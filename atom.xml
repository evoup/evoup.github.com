<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Evoup`s Blog]]></title>
  <link href="http://evoupsight.com/atom.xml" rel="self"/>
  <link href="http://evoupsight.com/"/>
  <updated>2014-08-03T22:22:10+08:00</updated>
  <id>http://evoupsight.com/</id>
  <author>
    <name><![CDATA[Evoup`s Blog]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[基于netsnmp的agent开发]]></title>
    <link href="http://evoupsight.com/blog/2014/08/03/netsnmp-daemon-dev/"/>
    <updated>2014-08-03T17:59:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/08/03/netsnmp-daemon-dev</id>
    <content type="html"><![CDATA[<p>防止遗忘，实现一个snmp agent，基于ucd-netsnmp，可以无需netsnmp单独运行，加了点获取其他信息的代码。</p>

<!-- more -->


<p>struct.h</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#ifndef UCD_SNMP_STRUCT</span>
</span><span class='line'><span class="cp">#define UCD_SNMP_STRUCT</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define STRMAX 1024</span>
</span><span class='line'><span class="cp">#define SHPROC 1</span>
</span><span class='line'><span class="cp">#define EXECPROC 2</span>
</span><span class='line'><span class="cp">#define PASSTHRU 3</span>
</span><span class='line'><span class="cp">#define PASSTHRU_PERSIST 4</span>
</span><span class='line'><span class="cp">#define MIBMAX 30</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">extensible</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span>            <span class="n">name</span><span class="p">[</span><span class="n">STRMAX</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span>            <span class="n">command</span><span class="p">[</span><span class="n">STRMAX</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span>            <span class="n">fixcmd</span><span class="p">[</span><span class="n">STRMAX</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">int</span>             <span class="n">type</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span>             <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span>            <span class="n">output</span><span class="p">[</span><span class="n">STRMAX</span><span class="p">];</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">extensible</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">miboid</span><span class="p">[</span><span class="n">MIBMAX</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">size_t</span>          <span class="n">miblen</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span>             <span class="n">pid</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">myproc</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span>            <span class="n">name</span><span class="p">[</span><span class="n">STRMAX</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span>            <span class="n">fixcmd</span><span class="p">[</span><span class="n">STRMAX</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">int</span>             <span class="n">min</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span>             <span class="n">max</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">myproc</span>  <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * struct mibinfo </span>
</span><span class='line'><span class="cm"> * {</span>
</span><span class='line'><span class="cm"> * int numid;</span>
</span><span class='line'><span class="cm"> * unsigned long mibid[10];</span>
</span><span class='line'><span class="cm"> * char *name;</span>
</span><span class='line'><span class="cm"> * void (*handle) ();</span>
</span><span class='line'><span class="cm"> * };</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>example.h</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> *  Template MIB group interface - example.h</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Don&#39;t include ourselves twice </span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="cp">#ifndef _MIBGROUP_EXAMPLE_H</span>
</span><span class='line'><span class="cp">#define _MIBGROUP_EXAMPLE_H</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef __cplusplus</span>
</span><span class='line'><span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="p">{</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * We use &#39;header_generic&#39; from the util_funcs module,</span>
</span><span class='line'><span class="cm">     *  so make sure this module is included in the agent.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'><span class="n">config_require</span><span class="p">(</span><span class="n">util_funcs</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Declare our publically-visible functions.</span>
</span><span class='line'><span class="cm">     * Typically, these will include the initialization and shutdown functions,</span>
</span><span class='line'><span class="cm">     *  the main request callback routine and any writeable object methods.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * Function prototypes are provided for the callback routine (&#39;FindVarMethod&#39;)</span>
</span><span class='line'><span class="cm">     *  and writeable object methods (&#39;WriteMethod&#39;).</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>     <span class="kt">void</span>     <span class="n">init_example</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>     <span class="n">FindVarMethod</span> <span class="n">var_example</span><span class="p">;</span>
</span><span class='line'>     <span class="n">WriteMethod</span> <span class="n">write_exampleint</span><span class="p">;</span>
</span><span class='line'>     <span class="n">WriteMethod</span> <span class="n">write_exampletrap</span><span class="p">;</span>
</span><span class='line'>     <span class="n">WriteMethod</span> <span class="n">write_exampletrap2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Magic number definitions.</span>
</span><span class='line'><span class="cm">     * These must be unique for each object implemented within a</span>
</span><span class='line'><span class="cm">     *  single mib module callback routine.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * Typically, these will be the last OID sub-component for</span>
</span><span class='line'><span class="cm">     *  each entry, or integers incrementing from 1.</span>
</span><span class='line'><span class="cm">     *  (which may well result in the same values anyway).</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * Here, the second and third objects are form a &#39;sub-table&#39; and</span>
</span><span class='line'><span class="cm">     *   the magic numbers are chosen to match these OID sub-components.</span>
</span><span class='line'><span class="cm">     * This is purely for programmer convenience.</span>
</span><span class='line'><span class="cm">     * All that really matters is that the numbers are unique.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define  EXAMPLESTRING       1</span>
</span><span class='line'><span class="cp">#define EXAMPLEINTEGER       21</span>
</span><span class='line'><span class="cp">#define  EXAMPLEOBJECTID         22</span>
</span><span class='line'><span class="cp">#define EXAMPLETIMETICKS 3</span>
</span><span class='line'><span class="cp">#define  EXAMPLEIPADDRESS        4</span>
</span><span class='line'><span class="cp">#define EXAMPLECOUNTER       5</span>
</span><span class='line'><span class="cp">#define  EXAMPLEGAUGE            6</span>
</span><span class='line'><span class="cp">#define  EXAMPLETRIGGERTRAP      7</span>
</span><span class='line'><span class="cp">#define  EXAMPLETRIGGERTRAP2     8</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef __cplusplus</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#endif                          </span><span class="cm">/* _MIBGROUP_EXAMPLE_H */</span><span class="cp"></span>
</span></code></pre></td></tr></table></div></figure>


<p>example.c</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
<span class='line-number'>464</span>
<span class='line-number'>465</span>
<span class='line-number'>466</span>
<span class='line-number'>467</span>
<span class='line-number'>468</span>
<span class='line-number'>469</span>
<span class='line-number'>470</span>
<span class='line-number'>471</span>
<span class='line-number'>472</span>
<span class='line-number'>473</span>
<span class='line-number'>474</span>
<span class='line-number'>475</span>
<span class='line-number'>476</span>
<span class='line-number'>477</span>
<span class='line-number'>478</span>
<span class='line-number'>479</span>
<span class='line-number'>480</span>
<span class='line-number'>481</span>
<span class='line-number'>482</span>
<span class='line-number'>483</span>
<span class='line-number'>484</span>
<span class='line-number'>485</span>
<span class='line-number'>486</span>
<span class='line-number'>487</span>
<span class='line-number'>488</span>
<span class='line-number'>489</span>
<span class='line-number'>490</span>
<span class='line-number'>491</span>
<span class='line-number'>492</span>
<span class='line-number'>493</span>
<span class='line-number'>494</span>
<span class='line-number'>495</span>
<span class='line-number'>496</span>
<span class='line-number'>497</span>
<span class='line-number'>498</span>
<span class='line-number'>499</span>
<span class='line-number'>500</span>
<span class='line-number'>501</span>
<span class='line-number'>502</span>
<span class='line-number'>503</span>
<span class='line-number'>504</span>
<span class='line-number'>505</span>
<span class='line-number'>506</span>
<span class='line-number'>507</span>
<span class='line-number'>508</span>
<span class='line-number'>509</span>
<span class='line-number'>510</span>
<span class='line-number'>511</span>
<span class='line-number'>512</span>
<span class='line-number'>513</span>
<span class='line-number'>514</span>
<span class='line-number'>515</span>
<span class='line-number'>516</span>
<span class='line-number'>517</span>
<span class='line-number'>518</span>
<span class='line-number'>519</span>
<span class='line-number'>520</span>
<span class='line-number'>521</span>
<span class='line-number'>522</span>
<span class='line-number'>523</span>
<span class='line-number'>524</span>
<span class='line-number'>525</span>
<span class='line-number'>526</span>
<span class='line-number'>527</span>
<span class='line-number'>528</span>
<span class='line-number'>529</span>
<span class='line-number'>530</span>
<span class='line-number'>531</span>
<span class='line-number'>532</span>
<span class='line-number'>533</span>
<span class='line-number'>534</span>
<span class='line-number'>535</span>
<span class='line-number'>536</span>
<span class='line-number'>537</span>
<span class='line-number'>538</span>
<span class='line-number'>539</span>
<span class='line-number'>540</span>
<span class='line-number'>541</span>
<span class='line-number'>542</span>
<span class='line-number'>543</span>
<span class='line-number'>544</span>
<span class='line-number'>545</span>
<span class='line-number'>546</span>
<span class='line-number'>547</span>
<span class='line-number'>548</span>
<span class='line-number'>549</span>
<span class='line-number'>550</span>
<span class='line-number'>551</span>
<span class='line-number'>552</span>
<span class='line-number'>553</span>
<span class='line-number'>554</span>
<span class='line-number'>555</span>
<span class='line-number'>556</span>
<span class='line-number'>557</span>
<span class='line-number'>558</span>
<span class='line-number'>559</span>
<span class='line-number'>560</span>
<span class='line-number'>561</span>
<span class='line-number'>562</span>
<span class='line-number'>563</span>
<span class='line-number'>564</span>
<span class='line-number'>565</span>
<span class='line-number'>566</span>
<span class='line-number'>567</span>
<span class='line-number'>568</span>
<span class='line-number'>569</span>
<span class='line-number'>570</span>
<span class='line-number'>571</span>
<span class='line-number'>572</span>
<span class='line-number'>573</span>
<span class='line-number'>574</span>
<span class='line-number'>575</span>
<span class='line-number'>576</span>
<span class='line-number'>577</span>
<span class='line-number'>578</span>
<span class='line-number'>579</span>
<span class='line-number'>580</span>
<span class='line-number'>581</span>
<span class='line-number'>582</span>
<span class='line-number'>583</span>
<span class='line-number'>584</span>
<span class='line-number'>585</span>
<span class='line-number'>586</span>
<span class='line-number'>587</span>
<span class='line-number'>588</span>
<span class='line-number'>589</span>
<span class='line-number'>590</span>
<span class='line-number'>591</span>
<span class='line-number'>592</span>
<span class='line-number'>593</span>
<span class='line-number'>594</span>
<span class='line-number'>595</span>
<span class='line-number'>596</span>
<span class='line-number'>597</span>
<span class='line-number'>598</span>
<span class='line-number'>599</span>
<span class='line-number'>600</span>
<span class='line-number'>601</span>
<span class='line-number'>602</span>
<span class='line-number'>603</span>
<span class='line-number'>604</span>
<span class='line-number'>605</span>
<span class='line-number'>606</span>
<span class='line-number'>607</span>
<span class='line-number'>608</span>
<span class='line-number'>609</span>
<span class='line-number'>610</span>
<span class='line-number'>611</span>
<span class='line-number'>612</span>
<span class='line-number'>613</span>
<span class='line-number'>614</span>
<span class='line-number'>615</span>
<span class='line-number'>616</span>
<span class='line-number'>617</span>
<span class='line-number'>618</span>
<span class='line-number'>619</span>
<span class='line-number'>620</span>
<span class='line-number'>621</span>
<span class='line-number'>622</span>
<span class='line-number'>623</span>
<span class='line-number'>624</span>
<span class='line-number'>625</span>
<span class='line-number'>626</span>
<span class='line-number'>627</span>
<span class='line-number'>628</span>
<span class='line-number'>629</span>
<span class='line-number'>630</span>
<span class='line-number'>631</span>
<span class='line-number'>632</span>
<span class='line-number'>633</span>
<span class='line-number'>634</span>
<span class='line-number'>635</span>
<span class='line-number'>636</span>
<span class='line-number'>637</span>
<span class='line-number'>638</span>
<span class='line-number'>639</span>
<span class='line-number'>640</span>
<span class='line-number'>641</span>
<span class='line-number'>642</span>
<span class='line-number'>643</span>
<span class='line-number'>644</span>
<span class='line-number'>645</span>
<span class='line-number'>646</span>
<span class='line-number'>647</span>
<span class='line-number'>648</span>
<span class='line-number'>649</span>
<span class='line-number'>650</span>
<span class='line-number'>651</span>
<span class='line-number'>652</span>
<span class='line-number'>653</span>
<span class='line-number'>654</span>
<span class='line-number'>655</span>
<span class='line-number'>656</span>
<span class='line-number'>657</span>
<span class='line-number'>658</span>
<span class='line-number'>659</span>
<span class='line-number'>660</span>
<span class='line-number'>661</span>
<span class='line-number'>662</span>
<span class='line-number'>663</span>
<span class='line-number'>664</span>
<span class='line-number'>665</span>
<span class='line-number'>666</span>
<span class='line-number'>667</span>
<span class='line-number'>668</span>
<span class='line-number'>669</span>
<span class='line-number'>670</span>
<span class='line-number'>671</span>
<span class='line-number'>672</span>
<span class='line-number'>673</span>
<span class='line-number'>674</span>
<span class='line-number'>675</span>
<span class='line-number'>676</span>
<span class='line-number'>677</span>
<span class='line-number'>678</span>
<span class='line-number'>679</span>
<span class='line-number'>680</span>
<span class='line-number'>681</span>
<span class='line-number'>682</span>
<span class='line-number'>683</span>
<span class='line-number'>684</span>
<span class='line-number'>685</span>
<span class='line-number'>686</span>
<span class='line-number'>687</span>
<span class='line-number'>688</span>
<span class='line-number'>689</span>
<span class='line-number'>690</span>
<span class='line-number'>691</span>
<span class='line-number'>692</span>
<span class='line-number'>693</span>
<span class='line-number'>694</span>
<span class='line-number'>695</span>
<span class='line-number'>696</span>
<span class='line-number'>697</span>
<span class='line-number'>698</span>
<span class='line-number'>699</span>
<span class='line-number'>700</span>
<span class='line-number'>701</span>
<span class='line-number'>702</span>
<span class='line-number'>703</span>
<span class='line-number'>704</span>
<span class='line-number'>705</span>
<span class='line-number'>706</span>
<span class='line-number'>707</span>
<span class='line-number'>708</span>
<span class='line-number'>709</span>
<span class='line-number'>710</span>
<span class='line-number'>711</span>
<span class='line-number'>712</span>
<span class='line-number'>713</span>
<span class='line-number'>714</span>
<span class='line-number'>715</span>
<span class='line-number'>716</span>
<span class='line-number'>717</span>
<span class='line-number'>718</span>
<span class='line-number'>719</span>
<span class='line-number'>720</span>
<span class='line-number'>721</span>
<span class='line-number'>722</span>
<span class='line-number'>723</span>
<span class='line-number'>724</span>
<span class='line-number'>725</span>
<span class='line-number'>726</span>
<span class='line-number'>727</span>
<span class='line-number'>728</span>
<span class='line-number'>729</span>
<span class='line-number'>730</span>
<span class='line-number'>731</span>
<span class='line-number'>732</span>
<span class='line-number'>733</span>
<span class='line-number'>734</span>
<span class='line-number'>735</span>
<span class='line-number'>736</span>
<span class='line-number'>737</span>
<span class='line-number'>738</span>
<span class='line-number'>739</span>
<span class='line-number'>740</span>
<span class='line-number'>741</span>
<span class='line-number'>742</span>
<span class='line-number'>743</span>
<span class='line-number'>744</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> *  Template MIB group implementation - example.c</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * include important headers </span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="cp">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
</span><span class='line'><span class="cp">#if HAVE_STDLIB_H</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#if HAVE_STRING_H</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp">#include &lt;strings.h&gt;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * needed by util_funcs.h </span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="cp">#if TIME_WITH_SYS_TIME</span>
</span><span class='line'><span class="cp"># ifdef WIN32</span>
</span><span class='line'><span class="cp">#  include &lt;sys/timeb.h&gt;</span>
</span><span class='line'><span class="cp"># else</span>
</span><span class='line'><span class="cp">#  include &lt;sys/time.h&gt;</span>
</span><span class='line'><span class="cp"># endif</span>
</span><span class='line'><span class="cp"># include &lt;time.h&gt;</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'><span class="cp"># if HAVE_SYS_TIME_H</span>
</span><span class='line'><span class="cp">#  include &lt;sys/time.h&gt;</span>
</span><span class='line'><span class="cp"># else</span>
</span><span class='line'><span class="cp">#  include &lt;time.h&gt;</span>
</span><span class='line'><span class="cp"># endif</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if HAVE_WINSOCK_H</span>
</span><span class='line'><span class="cp">#include &lt;winsock.h&gt;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="cp">#if HAVE_NETINET_IN_H</span>
</span><span class='line'><span class="cp">#include &lt;netinet/in.h&gt;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * header_generic() comes from here </span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="cp">#include &quot;/usr/include/net-snmp/agent/util_funcs.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * include our .h file </span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="cp">#include &quot;example.h&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>   <span class="cm">/*</span>
</span><span class='line'><span class="cm">    *  Certain objects can be set via configuration file directives.</span>
</span><span class='line'><span class="cm">    *  These variables hold the values for such objects, as they need to</span>
</span><span class='line'><span class="cm">    *   be accessible to both the config handlers, and the callback routine.</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'><span class="cp">#define EXAMPLE_STR_LEN  300</span>
</span><span class='line'><span class="cp">#define EXAMPLE_STR_DEFAULT  &quot;life the universe and everything&quot;</span>
</span><span class='line'><span class="kt">int</span>             <span class="n">example_int</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span>            <span class="n">example_str</span><span class="p">[</span><span class="n">EXAMPLE_STR_LEN</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * Forward declarations for the config handlers </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'><span class="kt">void</span>            <span class="nf">example_parse_config_exampleint</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span>
</span><span class='line'>                                                <span class="kt">char</span> <span class="o">*</span><span class="n">cptr</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span>            <span class="nf">example_parse_config_examplestr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span>
</span><span class='line'>                                                <span class="kt">char</span> <span class="o">*</span><span class="n">cptr</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span>            <span class="nf">example_free_config_exampleint</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'><span class="kt">void</span>            <span class="nf">example_free_config_examplestr</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*********************</span>
</span><span class='line'><span class="cm">  *</span>
</span><span class='line'><span class="cm">  *  Initialisation &amp; common implementation functions</span>
</span><span class='line'><span class="cm">  *</span>
</span><span class='line'><span class="cm">  *********************/</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * This array structure defines a representation of the</span>
</span><span class='line'><span class="cm">     *  MIB being implemented.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * The type of the array is &#39;struct variableN&#39;, where N is</span>
</span><span class='line'><span class="cm">     *  large enough to contain the longest OID sub-component</span>
</span><span class='line'><span class="cm">     *  being loaded.  This will normally be the maximum value</span>
</span><span class='line'><span class="cm">     *  of the fifth field in each line.  In this case, the second</span>
</span><span class='line'><span class="cm">     *  and third entries are both of size 2, so we&#39;re using</span>
</span><span class='line'><span class="cm">     *  &#39;struct variable2&#39;</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * The supported values for N are listed in &lt;agent/var_struct.h&gt;</span>
</span><span class='line'><span class="cm">     *  If the value you need is not listed there, simply use the</span>
</span><span class='line'><span class="cm">     *  next largest that is.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * The format of each line is as follows</span>
</span><span class='line'><span class="cm">     *  (using the first entry as an example):</span>
</span><span class='line'><span class="cm">     *      1: EXAMPLESTRING:</span>
</span><span class='line'><span class="cm">     *          The magic number defined in the example header file.</span>
</span><span class='line'><span class="cm">     *          This is passed to the callback routine and is used</span>
</span><span class='line'><span class="cm">     *            to determine which object is being queried.</span>
</span><span class='line'><span class="cm">     *      2: ASN_OCTET_STR:</span>
</span><span class='line'><span class="cm">     *          The type of the object.</span>
</span><span class='line'><span class="cm">     *          Valid types are listed in &lt;snmp_impl.h&gt;</span>
</span><span class='line'><span class="cm">     *      3: RONLY (or RWRITE):</span>
</span><span class='line'><span class="cm">     *          Whether this object can be SET or not.</span>
</span><span class='line'><span class="cm">     *      4: var_example:</span>
</span><span class='line'><span class="cm">     *          The callback routine, used when the object is queried.</span>
</span><span class='line'><span class="cm">     *          This will usually be the same for all objects in a module</span>
</span><span class='line'><span class="cm">     *            and is typically defined later in this file.</span>
</span><span class='line'><span class="cm">     *      5: 1:</span>
</span><span class='line'><span class="cm">     *          The length of the OID sub-component (the next field)</span>
</span><span class='line'><span class="cm">     *      6: {1}:</span>
</span><span class='line'><span class="cm">     *          The OID sub-components of this entry.</span>
</span><span class='line'><span class="cm">     *          In other words, the bits of the full OID that differ</span>
</span><span class='line'><span class="cm">     *            between the various entries of this array.</span>
</span><span class='line'><span class="cm">     *          This value is appended to the common prefix (defined later)</span>
</span><span class='line'><span class="cm">     *            to obtain the full OID of each entry.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'><span class="k">struct</span> <span class="n">variable2</span> <span class="n">example_variables</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">{</span><span class="n">EXAMPLESTRING</span><span class="p">,</span> <span class="n">ASN_OCTET_STR</span><span class="p">,</span> <span class="n">RONLY</span><span class="p">,</span> <span class="n">var_example</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">1</span><span class="p">}},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">EXAMPLEINTEGER</span><span class="p">,</span> <span class="n">ASN_INTEGER</span><span class="p">,</span> <span class="n">RWRITE</span><span class="p">,</span> <span class="n">var_example</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">}},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">EXAMPLEOBJECTID</span><span class="p">,</span> <span class="n">ASN_OBJECT_ID</span><span class="p">,</span> <span class="n">RONLY</span><span class="p">,</span> <span class="n">var_example</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">}},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">EXAMPLETIMETICKS</span><span class="p">,</span> <span class="n">ASN_TIMETICKS</span><span class="p">,</span> <span class="n">RONLY</span><span class="p">,</span> <span class="n">var_example</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">3</span><span class="p">}},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">EXAMPLEIPADDRESS</span><span class="p">,</span> <span class="n">ASN_IPADDRESS</span><span class="p">,</span> <span class="n">RONLY</span><span class="p">,</span> <span class="n">var_example</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">4</span><span class="p">}},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">EXAMPLECOUNTER</span><span class="p">,</span> <span class="n">ASN_COUNTER</span><span class="p">,</span> <span class="n">RONLY</span><span class="p">,</span> <span class="n">var_example</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">5</span><span class="p">}},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">EXAMPLEGAUGE</span><span class="p">,</span> <span class="n">ASN_GAUGE</span><span class="p">,</span> <span class="n">RONLY</span><span class="p">,</span> <span class="n">var_example</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">6</span><span class="p">}},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">EXAMPLETRIGGERTRAP</span><span class="p">,</span> <span class="n">ASN_INTEGER</span><span class="p">,</span> <span class="n">RWRITE</span><span class="p">,</span> <span class="n">var_example</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">7</span><span class="p">}},</span>
</span><span class='line'>    <span class="p">{</span><span class="n">EXAMPLETRIGGERTRAP2</span><span class="p">,</span> <span class="n">ASN_INTEGER</span><span class="p">,</span> <span class="n">RWRITE</span><span class="p">,</span> <span class="n">var_example</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">8</span><span class="p">}}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * This array defines the OID of the top of the mib tree that we&#39;re</span>
</span><span class='line'><span class="cm">     *  registering underneath.</span>
</span><span class='line'><span class="cm">     * Note that this needs to be the correct size for the OID being </span>
</span><span class='line'><span class="cm">     *  registered, so that the length of the OID can be calculated.</span>
</span><span class='line'><span class="cm">     *  The format given here is the simplest way to achieve this.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'><span class="n">oid</span>             <span class="n">example_variables_oid</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2021</span><span class="p">,</span> <span class="mi">254</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * This function is called at the time the agent starts up</span>
</span><span class='line'><span class="cm">     *  to do any initializations that might be required.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * In theory it is optional and can be omitted if no</span>
</span><span class='line'><span class="cm">     *  initialization is needed.  In practise, every module</span>
</span><span class='line'><span class="cm">     *  will need to register itself (or the objects being</span>
</span><span class='line'><span class="cm">     *  implemented will not appear in the MIB tree), and this</span>
</span><span class='line'><span class="cm">     *  registration is typically done here.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * If this function is added or removed, you must re-run</span>
</span><span class='line'><span class="cm">     *  the configure script, to detect this change.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">init_example</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Register ourselves with the agent to handle our mib tree.</span>
</span><span class='line'><span class="cm">     * The arguments are:</span>
</span><span class='line'><span class="cm">     *    descr:   A short description of the mib group being loaded.</span>
</span><span class='line'><span class="cm">     *    var:     The variable structure to load.</span>
</span><span class='line'><span class="cm">     *                  (the name of the variable structure defined above)</span>
</span><span class='line'><span class="cm">     *    vartype: The type of this variable structure</span>
</span><span class='line'><span class="cm">     *    theoid:  The OID pointer this MIB is being registered underneath.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">REGISTER_MIB</span><span class="p">(</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="n">example_variables</span><span class="p">,</span> <span class="n">variable2</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">example_variables_oid</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     *  Register config handlers for the two objects that can be set</span>
</span><span class='line'><span class="cm">     *   via configuration file directive.</span>
</span><span class='line'><span class="cm">     *  Also set a default value for the string object.  Note that the</span>
</span><span class='line'><span class="cm">     *   example integer variable was initialised above.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">strncpy</span><span class="p">(</span><span class="n">example_str</span><span class="p">,</span> <span class="n">EXAMPLE_STR_DEFAULT</span><span class="p">,</span> <span class="n">EXAMPLE_STR_LEN</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">snmpd_register_config_handler</span><span class="p">(</span><span class="s">&quot;exampleint&quot;</span><span class="p">,</span>
</span><span class='line'>                                  <span class="n">example_parse_config_exampleint</span><span class="p">,</span>
</span><span class='line'>                                  <span class="n">example_free_config_exampleint</span><span class="p">,</span>
</span><span class='line'>                                  <span class="s">&quot;exampleint value&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">snmpd_register_config_handler</span><span class="p">(</span><span class="s">&quot;examplestr&quot;</span><span class="p">,</span>
</span><span class='line'>                                  <span class="n">example_parse_config_examplestr</span><span class="p">,</span>
</span><span class='line'>                                  <span class="n">example_free_config_examplestr</span><span class="p">,</span>
</span><span class='line'>                                  <span class="s">&quot;examplestr value&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">snmpd_register_config_handler</span><span class="p">(</span><span class="s">&quot;examplestring&quot;</span><span class="p">,</span>
</span><span class='line'>                                  <span class="n">example_parse_config_examplestr</span><span class="p">,</span>
</span><span class='line'>                                  <span class="n">example_free_config_examplestr</span><span class="p">,</span>
</span><span class='line'>                                  <span class="s">&quot;examplestring value&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * One common requirement is to read values from the kernel.</span>
</span><span class='line'><span class="cm">     * This is usually initialised here, to speed up access when the</span>
</span><span class='line'><span class="cm">     *  information is read in, as a response to an incoming request.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * This module doesn&#39;t actually use this mechanism,</span>
</span><span class='line'><span class="cm">     * so this call is commented out here.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * auto_nlist( &quot;example_symbol&quot;, 0, 0 ); </span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*********************</span>
</span><span class='line'><span class="cm">  *</span>
</span><span class='line'><span class="cm">  *  Configuration file handling functions</span>
</span><span class='line'><span class="cm">  *</span>
</span><span class='line'><span class="cm">  *********************/</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">example_parse_config_exampleint</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cptr</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">example_int</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">example_parse_config_examplestr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cptr</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Make sure the string fits in the space allocated for it.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">cptr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">EXAMPLE_STR_LEN</span><span class="p">)</span>
</span><span class='line'>        <span class="n">strcpy</span><span class="p">(</span><span class="n">example_str</span><span class="p">,</span> <span class="n">cptr</span><span class="p">);</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * Truncate the string if necessary.</span>
</span><span class='line'><span class="cm">         * An alternative approach would be to log an error,</span>
</span><span class='line'><span class="cm">         *  and discard this value altogether.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">strncpy</span><span class="p">(</span><span class="n">example_str</span><span class="p">,</span> <span class="n">cptr</span><span class="p">,</span> <span class="n">EXAMPLE_STR_LEN</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
</span><span class='line'>        <span class="n">example_str</span><span class="p">[</span><span class="n">EXAMPLE_STR_LEN</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="n">strcat</span><span class="p">(</span><span class="n">example_str</span><span class="p">,</span> <span class="s">&quot;...&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">example_str</span><span class="p">[</span><span class="n">EXAMPLE_STR_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * We don&#39;t need to do anything special when closing down </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">example_free_config_exampleint</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span>
</span><span class='line'><span class="nf">example_free_config_examplestr</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*********************</span>
</span><span class='line'><span class="cm">  *</span>
</span><span class='line'><span class="cm">  *  System specific implementation functions</span>
</span><span class='line'><span class="cm">  *</span>
</span><span class='line'><span class="cm">  *********************/</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Define the callback function used in the example_variables structure.</span>
</span><span class='line'><span class="cm">     * This is called whenever an incoming request refers to an object</span>
</span><span class='line'><span class="cm">     *  within this sub-tree.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * Four of the parameters are used to pass information in.</span>
</span><span class='line'><span class="cm">     * These are:</span>
</span><span class='line'><span class="cm">     *    vp      The entry from the &#39;example_variables&#39; array for the</span>
</span><span class='line'><span class="cm">     *             object being queried.</span>
</span><span class='line'><span class="cm">     *    name    The OID from the request.</span>
</span><span class='line'><span class="cm">     *    length  The length of this OID.</span>
</span><span class='line'><span class="cm">     *    exact   A flag to indicate whether this is an &#39;exact&#39; request</span>
</span><span class='line'><span class="cm">     *             (GET/SET) or an &#39;inexact&#39; one (GETNEXT/GETBULK).</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * Four of the parameters are used to pass information back out.</span>
</span><span class='line'><span class="cm">     * These are:</span>
</span><span class='line'><span class="cm">     *    name     The OID being returned.</span>
</span><span class='line'><span class="cm">     *    length   The length of this OID.</span>
</span><span class='line'><span class="cm">     *    var_len  The length of the answer being returned.</span>
</span><span class='line'><span class="cm">     *    write_method   A pointer to the SET function for this object.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * Note that name &amp; length serve a dual purpose in both roles.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>
</span><span class='line'><span class="n">u_char</span>         <span class="o">*</span>
</span><span class='line'><span class="nf">var_example</span><span class="p">(</span><span class="k">struct</span> <span class="n">variable</span> <span class="o">*</span><span class="n">vp</span><span class="p">,</span>
</span><span class='line'>            <span class="n">oid</span> <span class="o">*</span> <span class="n">name</span><span class="p">,</span>
</span><span class='line'>            <span class="kt">size_t</span> <span class="o">*</span> <span class="n">length</span><span class="p">,</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">exact</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span> <span class="n">var_len</span><span class="p">,</span> <span class="n">WriteMethod</span> <span class="o">**</span> <span class="n">write_method</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     *  The result returned from this function needs to be a pointer to</span>
</span><span class='line'><span class="cm">     *    static data (so that it can be accessed from outside).</span>
</span><span class='line'><span class="cm">     *  Define suitable variables for any type of data we may return.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">char</span>     <span class="n">string</span><span class="p">[</span><span class="n">EXAMPLE_STR_LEN</span><span class="p">];</span>    <span class="cm">/* for EXAMPLESTRING   */</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">oid</span>      <span class="n">oid_ret</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="cm">/* for EXAMPLEOBJECTID */</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">long</span>     <span class="n">long_ret</span><span class="p">;</span>   <span class="cm">/* for everything else */</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Before returning an answer, we need to check that the request</span>
</span><span class='line'><span class="cm">     *  refers to a valid instance of this object.  The utility routine</span>
</span><span class='line'><span class="cm">     *  &#39;header_generic&#39; can be used to do this for scalar objects.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * This routine &#39;header_simple_table&#39; does the same thing for &quot;simple&quot;</span>
</span><span class='line'><span class="cm">     *  tables. (See the AGENT.txt file for the definition of a simple table).</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * Both these utility routines also set up default values for the</span>
</span><span class='line'><span class="cm">     *  return arguments (assuming the check succeeded).</span>
</span><span class='line'><span class="cm">     * The name and length are set suitably for the current object,</span>
</span><span class='line'><span class="cm">     *  var_len assumes that the result is an integer of some form,</span>
</span><span class='line'><span class="cm">     *  and write_method assumes that the object cannot be set.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * If these assumptions are correct, this callback routine simply</span>
</span><span class='line'><span class="cm">     * needs to return a pointer to the appropriate value (using &#39;long_ret&#39;).</span>
</span><span class='line'><span class="cm">     * Otherwise, &#39;var_len&#39; and/or &#39;write_method&#39; should be set suitably.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;var_example entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">header_generic</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span> <span class="n">var_len</span><span class="p">,</span> <span class="n">write_method</span><span class="p">)</span> <span class="o">==</span>
</span><span class='line'>        <span class="n">MATCH_FAILED</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Many object will need to obtain data from the operating system in</span>
</span><span class='line'><span class="cm">     *  order to return the appropriate value.  Typically, this is done</span>
</span><span class='line'><span class="cm">     *  here - immediately following the &#39;header&#39; call, and before the</span>
</span><span class='line'><span class="cm">     *  switch statement. This is particularly appropriate if a single </span>
</span><span class='line'><span class="cm">     *  interface call can return data for all the objects supported.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * This example module does not rely on external data, so no such</span>
</span><span class='line'><span class="cm">     *  calls are needed in this case.  </span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Now use the magic number from the variable pointer &#39;vp&#39; to</span>
</span><span class='line'><span class="cm">     *  select the particular object being queried.</span>
</span><span class='line'><span class="cm">     * In each case, one of the static objects is set up with the</span>
</span><span class='line'><span class="cm">     *  appropriate information, and returned mapped to a &#39;u_char *&#39;</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">EXAMPLESTRING</span>:
</span><span class='line'>        <span class="n">sprintf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">example_str</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * Note that the assumption that the answer will be an</span>
</span><span class='line'><span class="cm">         *  integer does not hold true in this case, so the length</span>
</span><span class='line'><span class="cm">         *  of the answer needs to be set explicitly.           </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="o">*</span><span class="n">var_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">string</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">string</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">EXAMPLEINTEGER</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * Here the length assumption is correct, but the</span>
</span><span class='line'><span class="cm">         *  object is writeable, so we need to set the</span>
</span><span class='line'><span class="cm">         *  write_method pointer as well as the current value.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">long_ret</span> <span class="o">=</span> <span class="n">example_int</span><span class="p">;</span>
</span><span class='line'>        <span class="o">*</span><span class="n">write_method</span> <span class="o">=</span> <span class="n">write_exampleint</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">long_ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">EXAMPLEOBJECTID</span>:
</span><span class='line'>        <span class="n">oid_ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">oid_ret</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'>        <span class="n">oid_ret</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</span><span class='line'>        <span class="n">oid_ret</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="n">oid_ret</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
</span><span class='line'>        <span class="n">oid_ret</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">oid_ret</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">oid_ret</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * Again, the assumption regarding the answer length is wrong.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="o">*</span><span class="n">var_len</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">oid</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">oid_ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">EXAMPLETIMETICKS</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * Here both assumptions are correct,</span>
</span><span class='line'><span class="cm">         *  so we just need to set up the answer.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">long_ret</span> <span class="o">=</span> <span class="mi">363136200</span><span class="p">;</span>   <span class="cm">/* 42 days, 42 minutes and 42.0 seconds */</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">long_ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">EXAMPLEIPADDRESS</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * ipaddresses get returned as a long.  ick </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * we&#39;re returning 127.0.0.1 </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">long_ret</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">INADDR_LOOPBACK</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">long_ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">EXAMPLECOUNTER</span>:
</span><span class='line'>        <span class="n">long_ret</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">long_ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">EXAMPLEGAUGE</span>:
</span><span class='line'>        <span class="n">long_ret</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>          <span class="cm">/* Do we detect a theme running through these answers? */</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">long_ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">EXAMPLETRIGGERTRAP</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * This object is essentially &quot;write-only&quot;.</span>
</span><span class='line'><span class="cm">         * It only exists to trigger the sending of a trap.</span>
</span><span class='line'><span class="cm">         * Reading it will always return 0.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">long_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="o">*</span><span class="n">write_method</span> <span class="o">=</span> <span class="n">write_exampletrap</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">long_ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">EXAMPLETRIGGERTRAP2</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * This object is essentially &quot;write-only&quot;.</span>
</span><span class='line'><span class="cm">         * It only exists to trigger the sending of a v2 trap.</span>
</span><span class='line'><span class="cm">         * Reading it will always return 0.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">long_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="o">*</span><span class="n">write_method</span> <span class="o">=</span> <span class="n">write_exampletrap2</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">long_ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nl">default:</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  This will only be triggered if there&#39;s a problem with</span>
</span><span class='line'><span class="cm">         *   the coding of the module.  SNMP requests that reference</span>
</span><span class='line'><span class="cm">         *   a non-existant OID will be directed elsewhere.</span>
</span><span class='line'><span class="cm">         *  If this branch is reached, log an error, so that</span>
</span><span class='line'><span class="cm">         *   the problem can be investigated.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;snmpd&quot;</span><span class="p">,</span> <span class="s">&quot;unknown sub-id %d in examples/var_example</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">vp</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * If we fall through to here, fail by returning NULL.</span>
</span><span class='line'><span class="cm">     * This is essentially a continuation of the &#39;default&#39; case above.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*********************</span>
</span><span class='line'><span class="cm">  *</span>
</span><span class='line'><span class="cm">  *  Writeable object SET handling routines</span>
</span><span class='line'><span class="cm">  *</span>
</span><span class='line'><span class="cm">  *********************/</span>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">write_exampleint</span><span class="p">(</span><span class="kt">int</span> <span class="n">action</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">u_char</span> <span class="o">*</span> <span class="n">var_val</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">u_char</span> <span class="n">var_val_type</span><span class="p">,</span>
</span><span class='line'>                 <span class="kt">size_t</span> <span class="n">var_val_len</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">u_char</span> <span class="o">*</span> <span class="n">statP</span><span class="p">,</span> <span class="n">oid</span> <span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">name_len</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Define an arbitrary maximum permissible value </span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'><span class="cp">#define MAX_EXAMPLE_INT  100</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">long</span>     <span class="n">intval</span><span class="p">;</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">long</span>     <span class="n">old_intval</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">RESERVE1</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  Check that the value being set is acceptable</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">var_val_type</span> <span class="o">!=</span> <span class="n">ASN_INTEGER</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;%x not integer type&quot;</span><span class="p">,</span> <span class="n">var_val_type</span><span class="p">));</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SNMP_ERR_WRONGTYPE</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">var_val_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;wrong length %x&quot;</span><span class="p">,</span> <span class="n">var_val_len</span><span class="p">));</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SNMP_ERR_WRONGLENGTH</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">intval</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">var_val</span><span class="p">);</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;you have set the value :%ld&quot;</span><span class="p">,</span><span class="n">intval</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">intval</span> <span class="o">&gt;</span> <span class="n">MAX_EXAMPLE_INT</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;wrong value %x&quot;</span><span class="p">,</span> <span class="n">intval</span><span class="p">));</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SNMP_ERR_WRONGVALUE</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">RESERVE2</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  This is conventially where any necesary</span>
</span><span class='line'><span class="cm">         *   resources are allocated (e.g. calls to malloc)</span>
</span><span class='line'><span class="cm">         *  Here, we are using static variables</span>
</span><span class='line'><span class="cm">         *   so don&#39;t need to worry about this.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">FREE</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  This is where any of the above resources</span>
</span><span class='line'><span class="cm">         *   are freed again (because one of the other</span>
</span><span class='line'><span class="cm">         *   values being SET failed for some reason).</span>
</span><span class='line'><span class="cm">         *  Again, since we are using static variables</span>
</span><span class='line'><span class="cm">         *   we don&#39;t need to worry about this either.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">ACTION</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  Set the variable as requested.</span>
</span><span class='line'><span class="cm">         *   Note that this may need to be reversed,</span>
</span><span class='line'><span class="cm">         *   so save any information needed to do this.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">old_intval</span> <span class="o">=</span> <span class="n">example_int</span><span class="p">;</span>
</span><span class='line'>        <span class="n">example_int</span> <span class="o">=</span> <span class="n">intval</span><span class="p">;</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">UNDO</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  Something failed, so re-set the</span>
</span><span class='line'><span class="cm">         *   variable to its previous value</span>
</span><span class='line'><span class="cm">         *  (and free any allocated resources).</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">example_int</span> <span class="o">=</span> <span class="n">old_intval</span><span class="p">;</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">COMMIT</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  Everything worked, so we can discard any</span>
</span><span class='line'><span class="cm">         *   saved information, and make the change</span>
</span><span class='line'><span class="cm">         *   permanent (e.g. write to the config file).</span>
</span><span class='line'><span class="cm">         *  We also free any allocated resources.</span>
</span><span class='line'><span class="cm">         *</span>
</span><span class='line'><span class="cm">         *  In this case, there&#39;s nothing to do.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">SNMP_ERR_NOERROR</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">write_exampletrap</span><span class="p">(</span><span class="kt">int</span> <span class="n">action</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">u_char</span> <span class="o">*</span> <span class="n">var_val</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">u_char</span> <span class="n">var_val_type</span><span class="p">,</span>
</span><span class='line'>                  <span class="kt">size_t</span> <span class="n">var_val_len</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">u_char</span> <span class="o">*</span> <span class="n">statP</span><span class="p">,</span> <span class="n">oid</span> <span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">name_len</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">long</span>            <span class="n">intval</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;write_exampletrap entered: action=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">action</span><span class="p">));</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">RESERVE1</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  The only acceptable value is the integer 1</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">var_val_type</span> <span class="o">!=</span> <span class="n">ASN_INTEGER</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;%x not integer type&quot;</span><span class="p">,</span> <span class="n">var_val_type</span><span class="p">));</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SNMP_ERR_WRONGTYPE</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">var_val_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;wrong length %x&quot;</span><span class="p">,</span> <span class="n">var_val_len</span><span class="p">));</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SNMP_ERR_WRONGLENGTH</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">intval</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">var_val</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">intval</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;wrong value %x&quot;</span><span class="p">,</span> <span class="n">intval</span><span class="p">));</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SNMP_ERR_WRONGVALUE</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">RESERVE2</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * No resources are required.... </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">FREE</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * ... so no resources need be freed </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">ACTION</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  Having triggered the sending of a trap,</span>
</span><span class='line'><span class="cm">         *   it would be impossible to revoke this,</span>
</span><span class='line'><span class="cm">         *   so we can&#39;t actually invoke the action here.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">UNDO</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * We haven&#39;t done anything yet,</span>
</span><span class='line'><span class="cm">         * so there&#39;s nothing to undo </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">COMMIT</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  Everything else worked, so it&#39;s now safe</span>
</span><span class='line'><span class="cm">         *   to trigger the trap.</span>
</span><span class='line'><span class="cm">         *  Note that this is *only* acceptable since</span>
</span><span class='line'><span class="cm">         *   the trap sending routines are &quot;failsafe&quot;.</span>
</span><span class='line'><span class="cm">         *  (In fact, they can fail, but they return no</span>
</span><span class='line'><span class="cm">         *   indication of this, which is the next best thing!)</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;write_exampletrap sending the trap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
</span><span class='line'>        <span class="n">send_easy_trap</span><span class="p">(</span><span class="n">SNMP_TRAP_ENTERPRISESPECIFIC</span><span class="p">,</span> <span class="mi">99</span><span class="p">);</span>
</span><span class='line'>        <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;write_exampletrap trap sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">SNMP_ERR_NOERROR</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * this documents how to send a SNMPv2 (and higher) trap via the</span>
</span><span class='line'><span class="cm"> * send_v2trap() API.</span>
</span><span class='line'><span class="cm"> * </span>
</span><span class='line'><span class="cm"> * Coding SNMP-v2 Trap:</span>
</span><span class='line'><span class="cm"> * </span>
</span><span class='line'><span class="cm"> * The SNMPv2-Trap PDU contains at least a pair of object names and</span>
</span><span class='line'><span class="cm"> * values: - sysUpTime.0 whose value is the time in hundredths of a</span>
</span><span class='line'><span class="cm"> * second since the netwok management portion of system was last</span>
</span><span class='line'><span class="cm"> * reinitialized.  - snmpTrapOID.0 which is part of the trap group SNMPv2</span>
</span><span class='line'><span class="cm"> * MIB whose value is the object-id of the specific trap you have defined</span>
</span><span class='line'><span class="cm"> * in your own MIB.  Other variables can be added to caracterize the</span>
</span><span class='line'><span class="cm"> * trap.</span>
</span><span class='line'><span class="cm"> * </span>
</span><span class='line'><span class="cm"> * The function send_v2trap adds automaticallys the two objects but the</span>
</span><span class='line'><span class="cm"> * value of snmpTrapOID.0 is 0.0 by default. If you want to add your trap</span>
</span><span class='line'><span class="cm"> * name, you have to reconstruct this object and to add your own</span>
</span><span class='line'><span class="cm"> * variable.</span>
</span><span class='line'><span class="cm"> * </span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">write_exampletrap2</span><span class="p">(</span><span class="kt">int</span> <span class="n">action</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">u_char</span> <span class="o">*</span> <span class="n">var_val</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">u_char</span> <span class="n">var_val_type</span><span class="p">,</span>
</span><span class='line'>                   <span class="kt">size_t</span> <span class="n">var_val_len</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">u_char</span> <span class="o">*</span> <span class="n">statP</span><span class="p">,</span> <span class="n">oid</span> <span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">name_len</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">long</span>            <span class="n">intval</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * these variales will be used when we send the trap </span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">oid</span>             <span class="n">objid_snmptrap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>     <span class="cm">/* snmpTrapOID.0 */</span>
</span><span class='line'>    <span class="n">oid</span>             <span class="n">demo_trap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2021</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">990</span> <span class="p">};</span>  <span class="cm">/*demo-trap */</span>
</span><span class='line'>    <span class="n">oid</span>             <span class="n">example_string_oid</span><span class="p">[]</span> <span class="o">=</span>
</span><span class='line'>        <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2021</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">netsnmp_variable_list</span> <span class="n">var_trap</span><span class="p">;</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">netsnmp_variable_list</span> <span class="n">var_obj</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;write_exampletrap2 entered: action=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">action</span><span class="p">));</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">RESERVE1</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  The only acceptable value is the integer 1</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">var_val_type</span> <span class="o">!=</span> <span class="n">ASN_INTEGER</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;%x not integer type&quot;</span><span class="p">,</span> <span class="n">var_val_type</span><span class="p">));</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SNMP_ERR_WRONGTYPE</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">var_val_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;wrong length %x&quot;</span><span class="p">,</span> <span class="n">var_val_len</span><span class="p">));</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SNMP_ERR_WRONGLENGTH</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">intval</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">var_val</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">intval</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;wrong value %x&quot;</span><span class="p">,</span> <span class="n">intval</span><span class="p">));</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">SNMP_ERR_WRONGVALUE</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">RESERVE2</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * No resources are required.... </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">FREE</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * ... so no resources need be freed </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">ACTION</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  Having triggered the sending of a trap,</span>
</span><span class='line'><span class="cm">         *   it would be impossible to revoke this,</span>
</span><span class='line'><span class="cm">         *   so we can&#39;t actually invoke the action here.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">UNDO</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * We haven&#39;t done anything yet,</span>
</span><span class='line'><span class="cm">         * so there&#39;s nothing to undo </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">COMMIT</span>:
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         *  Everything else worked, so it&#39;s now safe</span>
</span><span class='line'><span class="cm">         *   to trigger the trap.</span>
</span><span class='line'><span class="cm">         *  Note that this is *only* acceptable since</span>
</span><span class='line'><span class="cm">         *   the trap sending routines are &quot;failsafe&quot;.</span>
</span><span class='line'><span class="cm">         *  (In fact, they can fail, but they return no</span>
</span><span class='line'><span class="cm">         *   indication of this, which is the next best thing!)</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * trap definition objects </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">var_trap</span><span class="p">.</span><span class="n">next_variable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">var_obj</span><span class="p">;</span>      <span class="cm">/* next variable */</span>
</span><span class='line'>        <span class="n">var_trap</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">objid_snmptrap</span><span class="p">;</span> <span class="cm">/* snmpTrapOID.0 */</span>
</span><span class='line'>        <span class="n">var_trap</span><span class="p">.</span><span class="n">name_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">objid_snmptrap</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">oid</span><span class="p">);</span>    <span class="cm">/* number of sub-ids */</span>
</span><span class='line'>        <span class="n">var_trap</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ASN_OBJECT_ID</span><span class="p">;</span>
</span><span class='line'>        <span class="n">var_trap</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="n">objid</span> <span class="o">=</span> <span class="n">demo_trap</span><span class="p">;</span> <span class="cm">/* demo-trap objid */</span>
</span><span class='line'>        <span class="n">var_trap</span><span class="p">.</span><span class="n">val_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">demo_trap</span><span class="p">);</span>   <span class="cm">/* length in bytes (not number of subids!) */</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * additional objects </span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="n">var_obj</span><span class="p">.</span><span class="n">next_variable</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>   <span class="cm">/* No more variables after this one */</span>
</span><span class='line'>        <span class="n">var_obj</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">example_string_oid</span><span class="p">;</span>
</span><span class='line'>        <span class="n">var_obj</span><span class="p">.</span><span class="n">name_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">example_string_oid</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">oid</span><span class="p">);</span> <span class="cm">/* number of sub-ids */</span>
</span><span class='line'>        <span class="n">var_obj</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ASN_OCTET_STR</span><span class="p">;</span>   <span class="cm">/* type of variable */</span>
</span><span class='line'>        <span class="n">var_obj</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">example_str</span><span class="p">;</span>       <span class="cm">/* value */</span>
</span><span class='line'>        <span class="n">var_obj</span><span class="p">.</span><span class="n">val_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">example_str</span><span class="p">);</span>
</span><span class='line'>        <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;write_exampletrap2 sending the v2 trap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
</span><span class='line'>        <span class="n">send_v2trap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">var_trap</span><span class="p">);</span>
</span><span class='line'>        <span class="n">DEBUGMSGTL</span><span class="p">((</span><span class="s">&quot;example&quot;</span><span class="p">,</span> <span class="s">&quot;write_exampletrap2 v2 trap sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">SNMP_ERR_NOERROR</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>example-demon.c</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*主函数：foxmail_new.c */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;net-snmp/net-snmp-config.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;net-snmp/net-snmp-includes.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;net-snmp/agent/net-snmp-agent-includes.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;signal.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &quot;example.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define MYDEBUG </span>
</span><span class='line'><span class="cp">#ifdef MYDEBUG</span>
</span><span class='line'>  <span class="err">#</span><span class="n">define</span> <span class="n">myprintf</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">a</span><span class="p">...)</span>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s,%s(),%d:&quot;</span> <span class="n">fmt</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span> <span class="err">##</span><span class="n">a</span><span class="p">)</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="err">#</span><span class="n">define</span> <span class="n">myprintf</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">a</span><span class="p">...)</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="n">keep_running</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">RETSIGTYPE</span>
</span><span class='line'>
</span><span class='line'><span class="nf">stop_server</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">keep_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">agentx_subagent</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="cm">/* change this if you want to be a SNMP master agent */</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">background</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* change this if you want to run in the background */</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">syslog</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* change this if you want to use syslog */</span>
</span><span class='line'>
</span><span class='line'><span class="n">myprintf</span><span class="p">(</span><span class="s">&quot;it is ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="cm">/* print log errors to syslog or stderr */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">syslog</span><span class="p">)</span>
</span><span class='line'>    <span class="n">snmp_enable_calllog</span><span class="p">();</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">snmp_enable_stderrlog</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//myprintf(&quot;it is ok \n&quot;);</span>
</span><span class='line'>  <span class="cm">/* we&#39;re an agentx subagent? */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">agentx_subagent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* make us a agentx client. */</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">netsnmp_ds_set_boolean</span><span class="p">(</span><span class="n">NETSNMP_DS_APPLICATION_ID</span><span class="p">,</span> <span class="n">NETSNMP_DS_AGENT_ROLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* run in background, if requested */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">background</span> <span class="o">&amp;&amp;</span> <span class="n">netsnmp_daemonize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">!</span><span class="n">syslog</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Initialize tcpip, if necessary */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">SOCK_STARTUP</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Initialize the agent library */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">init_agent</span><span class="p">(</span><span class="s">&quot;example-demon&quot;</span><span class="p">);</span>
</span><span class='line'><span class="n">init_system_mib</span><span class="p">();</span>
</span><span class='line'><span class="n">init_sysORTable</span><span class="p">();</span>
</span><span class='line'><span class="n">init_at</span><span class="p">();</span>
</span><span class='line'><span class="n">init_snmp_mib</span><span class="p">();</span>
</span><span class='line'><span class="n">init_tcp</span><span class="p">();</span>
</span><span class='line'><span class="n">init_icmp</span><span class="p">();</span>
</span><span class='line'><span class="n">init_ip</span><span class="p">();</span>
</span><span class='line'><span class="n">init_udp</span><span class="p">();</span>
</span><span class='line'><span class="n">init_vacm_vars</span><span class="p">();</span>
</span><span class='line'><span class="n">init_memory</span><span class="p">();</span>
</span><span class='line'><span class="n">init_proc</span><span class="p">();</span>
</span><span class='line'><span class="n">init_versioninfo</span><span class="p">();</span>
</span><span class='line'><span class="n">init_pass</span><span class="p">();</span>
</span><span class='line'><span class="n">init_pass_persist</span><span class="p">();</span>
</span><span class='line'><span class="n">init_disk</span><span class="p">();</span>
</span><span class='line'><span class="n">init_loadave</span><span class="p">();</span>
</span><span class='line'><span class="n">init_extensible</span><span class="p">();</span>
</span><span class='line'><span class="n">init_errormib</span><span class="p">();</span>
</span><span class='line'><span class="n">init_file</span><span class="p">();</span>
</span><span class='line'><span class="n">init_snmpEngine</span><span class="p">();</span>
</span><span class='line'><span class="n">init_snmpMPDStats</span><span class="p">();</span>
</span><span class='line'><span class="n">init_usmStats</span><span class="p">();</span>
</span><span class='line'><span class="n">init_usmUser</span><span class="p">();</span>
</span><span class='line'><span class="n">init_var_route</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Initialize our mib code here */</span>
</span><span class='line'>
</span><span class='line'><span class="n">init_example</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* initialize vacm/usm access control  */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">agentx_subagent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span>  <span class="n">init_vacm_vars</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span>  <span class="n">init_usmUser</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Example-demon will be used to read example-demon.conf files. */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">init_snmp</span><span class="p">(</span><span class="s">&quot;example-demon&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* If we&#39;re going to be a snmp master agent, initial the ports */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">agentx_subagent</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">init_master_agent</span><span class="p">();</span>  <span class="cm">/* open the port to listen on (defaults to udp:161) */</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* In case we recevie a request to stop (kill -TERM or kill -INT) */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">keep_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">stop_server</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">signal</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">stop_server</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">snmp_log</span><span class="p">(</span><span class="n">LOG_INFO</span><span class="p">,</span><span class="s">&quot;example-demon is up and running.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* your main loop here... */</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">while</span><span class="p">(</span><span class="n">keep_running</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* if you use select(), see snmp_select_info() in snmp_api(3) */</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*     --- OR ---  */</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent_check_and_process</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* 0 == don&#39;t block */</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* at shutdown time */</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">snmp_shutdown</span><span class="p">(</span><span class="s">&quot;example-demon&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">SOCK_CLEANUP</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>example-demon.conf</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">###############################################################################</span>
</span><span class='line'><span class="cp"># Access Control</span>
</span><span class='line'><span class="cp">###############################################################################</span>
</span><span class='line'>
</span><span class='line'><span class="cp"># sec.name source community</span>
</span><span class='line'><span class="n">rocommunity</span> <span class="n">public</span>
</span><span class='line'><span class="n">rwcommunity</span> <span class="mi">223323</span>
</span><span class='line'><span class="cp">####</span>
</span><span class='line'><span class="cp"># Second, map the security names into group names:</span>
</span><span class='line'>
</span><span class='line'><span class="cp"># sec.model sec.name</span>
</span><span class='line'><span class="n">group</span> <span class="n">MyRWGroup</span> <span class="n">v1</span> <span class="n">local</span>
</span><span class='line'><span class="n">group</span> <span class="n">MyRWGroup</span> <span class="n">v2c</span> <span class="n">local</span>
</span><span class='line'><span class="n">group</span> <span class="n">MyRWGroup</span> <span class="n">usm</span> <span class="n">local</span>
</span><span class='line'><span class="n">group</span> <span class="n">MyROGroup</span> <span class="n">v1</span> <span class="n">mynetwork</span>
</span><span class='line'><span class="n">group</span> <span class="n">MyROGroup</span> <span class="n">v2c</span> <span class="n">mynetwork</span>
</span><span class='line'><span class="n">group</span> <span class="n">MyROGroup</span> <span class="n">usm</span> <span class="n">mynetwork</span>
</span><span class='line'>
</span><span class='line'><span class="cp">####</span>
</span><span class='line'><span class="cp"># Third, create a view for us to let the groups have rights to:</span>
</span><span class='line'>
</span><span class='line'><span class="cp"># incl/excl subtree mask</span>
</span><span class='line'><span class="n">view</span> <span class="n">all</span> <span class="n">included</span> <span class="mf">.1</span> <span class="mi">80</span>
</span><span class='line'>
</span><span class='line'><span class="cp">####</span>
</span><span class='line'><span class="cp"># Finally, grant the 2 groups access to the 1 view with different</span>
</span><span class='line'><span class="cp"># write permissions:</span>
</span><span class='line'>
</span><span class='line'><span class="cp"># context sec.model sec.level match read write notif</span>
</span><span class='line'><span class="n">access</span> <span class="n">MyROGroup</span> <span class="s">&quot;&quot;</span> <span class="n">any</span> <span class="n">noauth</span> <span class="n">exact</span> <span class="n">all</span> <span class="n">none</span> <span class="n">none</span>
</span><span class='line'><span class="n">access</span> <span class="n">MyRWGroup</span> <span class="s">&quot;&quot;</span> <span class="n">any</span> <span class="n">noauth</span> <span class="n">exact</span> <span class="n">all</span> <span class="n">all</span> <span class="n">none</span>
</span><span class='line'>
</span><span class='line'><span class="n">agentaddress</span> <span class="mi">161</span>
</span></code></pre></td></tr></table></div></figure>


<p>Makefile</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='makefile'><span class='line'><span class="nv">CC</span><span class="o">=</span>gcc
</span><span class='line'><span class="nv">OBJS2</span><span class="o">=</span>example-demon.o example.o
</span><span class='line'><span class="nv">TARGETS</span><span class="o">=</span>example-demon
</span><span class='line'>
</span><span class='line'><span class="nv">CFLAGS</span><span class="o">=</span>-I. <span class="sb">`</span>net-snmp-config --cflags<span class="sb">`</span>
</span><span class='line'><span class="nv">BUILDLIBS</span><span class="o">=</span><span class="sb">`</span>net-snmp-config --libs<span class="sb">`</span>
</span><span class='line'><span class="nv">BUILDAGENTLIBS</span><span class="o">=</span><span class="sb">`</span>net-snmp-config --agent-libs<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="c"># shared library flags (assumes gcc)</span>
</span><span class='line'><span class="nv">DLFLAGS</span><span class="o">=</span>-fPIC –shared
</span><span class='line'>
</span><span class='line'><span class="nf">all</span><span class="o">:</span> <span class="m">$(TARGETS)</span>
</span><span class='line'>
</span><span class='line'><span class="nf">example-demon</span><span class="o">:</span> <span class="m">$(OBJS2)</span>
</span><span class='line'>  <span class="k">$(</span>CC<span class="k">)</span> -o example-demon <span class="k">$(</span>OBJS2<span class="k">)</span> <span class="k">$(</span>BUILDAGENTLIBS<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="nf">clean</span><span class="o">:</span>
</span><span class='line'>  rm <span class="k">$(</span>OBJS2<span class="k">)</span> <span class="k">$(</span>OBJS2<span class="k">)</span> <span class="k">$(</span>TARGETS<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>目前无法获取到系统load，以后用到再深入。</p>

<p>参考文章
《Snmp Agent开发流程》
<a href="http://blog.csdn.net/ytz_linuxer/article/details/5985534">http://blog.csdn.net/ytz_linuxer/article/details/5985534</a></p>

<p>《网管SNMP Agent的快速开发》
<a href="http://www.wangchao.net.cn/bbsdetail_53491.html">http://www.wangchao.net.cn/bbsdetail_53491.html</a></p>

<p>《SNMP监控一些常用OID的总结》
<a href="http://www.cnblogs.com/aspx-net/p/3554044.html">http://www.cnblogs.com/aspx-net/p/3554044.html</a></p>

<p>《与大家分享uclinux上的ucd-snmp开发过程》
<a href="http://bbs.chinaunix.net/thread-2112856-1-1.html">http://bbs.chinaunix.net/thread-2112856-1-1.html</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[编译cdh47下hive的contrib源码]]></title>
    <link href="http://evoupsight.com/blog/2014/07/31/compile-cdh47-hive-contrib/"/>
    <updated>2014-07-31T10:18:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/07/31/compile-cdh47-hive-contrib</id>
    <content type="html"><![CDATA[<p>进入hive的src/contrib目录，开始编译，提示需要这几个包得加到classpath中去</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/home/hadoop/software/hadoop-2.0.0-cdh4.7.0/share/hadoop/common/hadoop-common-2.0.0-cdh4.7.0.jar
</span><span class='line'>/home/hadoop/software/hadoop-2.0.0-cdh4.7.0/share/hadoop/mapreduce1/hadoop-core-2.0.0-mr1-cdh4.7.0.jar</span></code></pre></td></tr></table></div></figure>


<!-- more -->


<p>看下工程路径build.xml的29行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;import file="../build-common.xml"/&gt;</span></code></pre></td></tr></table></div></figure>


<p>于是编辑上级目录的build-common.xml文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>266   &lt;path id="classpath"&gt;
</span><span class='line'>267     &lt;pathelement location="${build.dir.hive}/service/classes"/&gt;
</span><span class='line'>268     &lt;pathelement location="${build.dir.hive}/common/classes"/&gt;
</span><span class='line'>269     &lt;pathelement location="${build.dir.hive}/serde/classes"/&gt;
</span><span class='line'>270     &lt;pathelement location="${build.dir.hive}/metastore/classes"/&gt;
</span><span class='line'>271     &lt;pathelement location="${build.dir.hive}/ql/classes"/&gt;
</span><span class='line'>272     &lt;pathelement location="${build.dir.hive}/beeline/classes"/&gt;
</span><span class='line'>273     &lt;pathelement location="${build.dir.hive}/cli/classes"/&gt;
</span><span class='line'>274     &lt;pathelement location="${build.dir.hive}/shims/classes"/&gt;
</span><span class='line'>275     &lt;pathelement location="${build.dir.hive}/hwi/classes"/&gt;
</span><span class='line'>276     &lt;pathelement location="${build.dir.hive}/jdbc/classes"/&gt;
</span><span class='line'>277     &lt;pathelement location="${build.dir.hive}/hbase-handler/classes"/&gt;
</span><span class='line'>278 &lt;!--{ { {把缺少的hadoop加入--&gt;
</span><span class='line'>279     &lt;pathelement location="/home/hadoop/software/hadoop-2.0.0-cdh4.7.0/share/hadoop/common/hadoop-common-2.0.0-cdh4.7.0.jar"/&gt;
</span><span class='line'>280     &lt;pathelement location="/home/hadoop/software/hadoop-2.0.0-cdh4.7.0/share/hadoop/mapreduce1/hadoop-core-2.0.0-mr1-cdh4.7.0.jar"/&gt;
</span><span class='line'>281 &lt;!--} } }--&gt;
</span><span class='line'>282     &lt;fileset dir="${basedir}" includes="lib/*.jar"/&gt;
</span><span class='line'>283     &lt;path refid="common-classpath"/&gt;
</span><span class='line'>284   &lt;/path&gt;</span></code></pre></td></tr></table></div></figure>


<p>像上面这样把2个包加入。</p>

<p>然后回到工程文件，执行ant，提示将编译contrib包，一路过去，没有问题
，最后编译的jar包存到了ivy的路径下</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>compile:
</span><span class='line'>     [echo] Project: contrib
</span><span class='line'>    [javac] Compiling 39 source files to /home/hadoop/software/hive-0.10.0-cdh4.7.0/src/build/contrib/classes
</span><span class='line'>    [javac] /home/hadoop/software/hadoop-2.0.0-cdh4.7.0/share/hadoop/common/hadoop-common-2.0.0-cdh4.7.0.jar(org/apache/hadoop/fs/Path.class): 警告: 无法找到类型 'LimitedPrivate' 的注释方法 'value()': 找不到org.apache.hadoop.classification.InterfaceAudience的类文件
</span><span class='line'>    [javac] 注: 某些输入文件使用或覆盖了已过时的 API。
</span><span class='line'>    [javac] 注: 有关详细信息, 请使用 -Xlint:deprecation 重新编译。
</span><span class='line'>    [javac] 注: /home/hadoop/software/hive-0.10.0-cdh4.7.0/src/contrib/src/java/org/apache/hadoop/hive/contrib/udf/example/UDFExampleStructPrint.java使用了未经检查或不安全的操作。
</span><span class='line'>    [javac] 注: 有关详细信息, 请使用 -Xlint:unchecked 重新编译。
</span><span class='line'>    [javac] 1 个警告
</span><span class='line'>     [copy] Warning: /home/hadoop/software/hive-0.10.0-cdh4.7.0/src/contrib/src/java/conf does not exist.
</span><span class='line'>
</span><span class='line'>jar:
</span><span class='line'>     [echo] Project: contrib
</span><span class='line'>      [jar] Building jar: /home/hadoop/software/hive-0.10.0-cdh4.7.0/src/build/contrib/hive-contrib-0.10.0-cdh4.7.0.jar
</span><span class='line'>[ivy:publish] :: delivering :: org.apache.hive#hive-contrib;0.10.0-cdh4.7.0 :: 0.10.0-cdh4.7.0 :: integration :: Fri Jul 25 10:54:42 CST 2014
</span><span class='line'>[ivy:publish]   delivering ivy file to /home/hadoop/software/hive-0.10.0-cdh4.7.0/src/build/contrib/ivy-0.10.0-cdh4.7.0.xml
</span><span class='line'>[ivy:publish] :: publishing :: org.apache.hive#hive-contrib
</span><span class='line'>[ivy:publish]   published hive-contrib to /home/hadoop/.ivy2/local/org.apache.hive/hive-contrib/0.10.0-cdh4.7.0/jars/hive-contrib.jar
</span><span class='line'>[ivy:publish]   published ivy to /home/hadoop/.ivy2/local/org.apache.hive/hive-contrib/0.10.0-cdh4.7.0/ivys/ivy.xml
</span><span class='line'>
</span><span class='line'>BUILD SUCCESSFUL
</span><span class='line'>Total time: 19 seconds</span></code></pre></td></tr></table></div></figure>


<p>ok
这样就得到了hive-contrib.jar文件,解包看一下内容。没问题，都包含了。</p>

<p>参考互联网文章《如何在Ant中引入第三方Jar包》，链接已挂删除了：）</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[centos上hadoop2.x hdfs支持lzo]]></title>
    <link href="http://evoupsight.com/blog/2014/07/30/hadoop-with-lzo/"/>
    <updated>2014-07-30T18:32:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/07/30/hadoop-with-lzo</id>
    <content type="html"><![CDATA[<p>总体来说要让hadoop2.x的hdfs支持lzo压缩格式，是和hadoop1.x下配置方式一样的。下文记录一下配置过程。</p>

<!-- more -->


<p>首先安装lzo</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo yum install lzo-devel.x86_64 lzop.x86_64
</span></code></pre></td></tr></table></div></figure>


<p>下载twitter的hadoop-lzo项目</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone https://github.com/twitter/hadoop-lzo.git
</span></code></pre></td></tr></table></div></figure>


<p>64位环境的需要设置两个环境变量：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim ~/.bashrc
</span><span class='line'><span class="nb">export </span><span class="nv">CFLAGS</span><span class="o">=</span>-m64
</span><span class='line'><span class="nb">export </span><span class="nv">CXXFLAGS</span><span class="o">=</span>-m64
</span></code></pre></td></tr></table></div></figure>


<p>开始编译</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mvn clean package -Dmaven.test.skip<span class="o">=</span><span class="nb">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>出现警告</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>WARNING<span class="o">]</span> Javadoc Warnings
</span><span class='line'><span class="o">[</span>WARNING<span class="o">]</span> /home/hadoop/software/hadoop-lzo/src/main/java/com/hadoop/compression/lzo/LzoIndexer.java:115: 警告 - @return 标记没有参数。
</span><span class='line'><span class="o">[</span>WARNING<span class="o">]</span> /home/hadoop/software/hadoop-lzo/src/main/java/com/hadoop/compression/lzo/LzoIndexer.java:51: 警告 - @param argument <span class="s2">&quot;lzoUri&quot;</span> 不是参数名称。
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Building jar: /home/hadoop/software/hadoop-lzo/target/hadoop-lzo-0.4.20-SNAPSHOT-javadoc.jar
</span></code></pre></td></tr></table></div></figure>


<p>不用管，编译ok。</p>

<p>需要把本地库和jar包放到hadoop对应目录中</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cp target/native/Linux-amd64-64/lib/* <span class="nv">$HADOOP_HOME</span>/lib/native/
</span><span class='line'>cp target/hadoop-lzo-0.4.20-SNAPSHOT.jar  <span class="nv">$HADOOP_HOME</span>/share/hadoop/mapreduce/lib/
</span></code></pre></td></tr></table></div></figure>


<p>3 修改hadoop的配置文件core-site.xml
修改/增加以下2个参数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">io</span><span class="o">.</span><span class="na">compression</span><span class="o">.</span><span class="na">codecs</span>
</span><span class='line'><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hadoop</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">compress</span><span class="o">.</span><span class="na">GzipCodec</span><span class="o">,</span>
</span><span class='line'><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hadoop</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">compress</span><span class="o">.</span><span class="na">DefaultCodec</span><span class="o">,</span>
</span><span class='line'><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">hadoop</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">compress</span><span class="o">.</span><span class="na">BZip2Codec</span><span class="o">,</span>
</span><span class='line'><span class="n">com</span><span class="o">.</span><span class="na">hadoop</span><span class="o">.</span><span class="na">compression</span><span class="o">.</span><span class="na">lzo</span><span class="o">.</span><span class="na">LzoCodec</span><span class="o">,</span>
</span><span class='line'><span class="n">com</span><span class="o">.</span><span class="na">hadoop</span><span class="o">.</span><span class="na">compression</span><span class="o">.</span><span class="na">lzo</span><span class="o">.</span><span class="na">LzopCodec</span>
</span><span class='line'>
</span><span class='line'><span class="n">io</span><span class="o">.</span><span class="na">compression</span><span class="o">.</span><span class="na">codec</span><span class="o">.</span><span class="na">lzo</span><span class="o">.</span><span class="na">class</span>
</span><span class='line'><span class="n">com</span><span class="o">.</span><span class="na">hadoop</span><span class="o">.</span><span class="na">compression</span><span class="o">.</span><span class="na">lzo</span><span class="o">.</span><span class="na">LzoCodec</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后重启hadoop看效果。</p>

<p>参考
<a href="http://www.linuxidc.com/Linux/2014-05/101090.htm">http://www.linuxidc.com/Linux/2014-05/101090.htm</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[hadoop2.x本地库安装]]></title>
    <link href="http://evoupsight.com/blog/2014/07/30/hadoop2x-nativecodeloader/"/>
    <updated>2014-07-30T18:00:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/07/30/hadoop2x-nativecodeloader</id>
    <content type="html"><![CDATA[<p>运行hadoop cli时会出现 <code>14/07/25 14:45:25 WARN util.NativeCodeLoader: Unable to load native-hadoop library for your platform...</code>
<code>using builtin-java classes where applicable</code>
虽然表面上看来不影响工作结果，但是放着警告不处理太不科学了，想办法解决，过程还是比较漫长，要解决的要有耐心看下文了。</p>

<!-- more -->


<h3>首先查看本地库</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ls <span class="nv">$HADOOP_HOME</span>/lib/native/
</span></code></pre></td></tr></table></div></figure>


<p>发现动态库不存在,按照上文述及，也会这个错误。
查看系统的libc版本</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ll /lib64/libc.so.6
</span><span class='line'>lrwxrwxrwx. 1 root root 12 12月 12 2013 /lib64/libc.so.6 -&gt; libc-2.18.so
</span></code></pre></td></tr></table></div></figure>


<p>系统的版本为2.18</p>

<p>参考cdh手册
<a href="http://archive.cloudera.com/cdh4/cdh/4/hadoop/hadoop-project-dist/hadoop-common/NativeLibraries.html#Native_Libraries_Guide">http://archive.cloudera.com/cdh4/cdh/4/hadoop/hadoop-project-dist/hadoop-common/NativeLibraries.html#Native_Libraries_Guide</a></p>

<p>找一个hadoop-mapreduce1-project的项目用ant跑一下
ant -Dcompile.native=true</p>

<p>期间会报错jvm-check需要1.6，我的是1.7，直接修改ant的build.xml文件，把里面的1.6改成1.7就可以了。</p>

<p>慢慢等编译完成，报错以下依赖没有解决</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span> :: resolution report :: resolve 11214ms :: artifacts dl 10ms
</span><span class='line'>        ---------------------------------------------------------------------
</span><span class='line'>        |                  |            modules            <span class="o">||</span>   artifacts   |
</span><span class='line'>        |       conf       | number| search|dwnlded|evicted|| number|dwnlded|
</span><span class='line'>        ---------------------------------------------------------------------
</span><span class='line'>        |      common      |   10  |   2   |   0   |   0   <span class="o">||</span>   8   |   0   |
</span><span class='line'>        ---------------------------------------------------------------------
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span> :: problems summary ::
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span> :::: WARNINGS
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span>           ::::::::::::::::::::::::::::::::::::::::::::::
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span>           ::          UNRESOLVED DEPENDENCIES         ::
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span>           ::::::::::::::::::::::::::::::::::::::::::::::
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span>           :: org.codehaus.jackson#jackson-mapper-asl;1.0.1: several problems occurred <span class="k">while </span>resolving dependency: org.codehaus.jackson#jackson-mapper-asl;1.0.1 <span class="o">{</span><span class="nv">common</span><span class="o">=[</span>default<span class="o">]}</span>:
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span>   reactor-repo: unable to get resource <span class="k">for </span>org/codehaus/jackson#jackson-mapper-asl;1.0.1: <span class="nv">res</span><span class="o">=</span><span class="k">${</span><span class="nv">reactor</span><span class="p">.repo</span><span class="k">}</span>/org/codehaus/jackson/jackson-mapper-asl/1.0.1/jackson-mapper-asl-1.0.1.pom: java.net.MalformedURLException: no protocol: <span class="k">${</span><span class="nv">reactor</span><span class="p">.repo</span><span class="k">}</span>/org/codehaus/jackson/jackson-mapper-asl/1.0.1/jackson-mapper-asl-1.0.1.pom
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span>   reactor-repo: unable to get resource <span class="k">for </span>org/codehaus/jackson#jackson-mapper-asl;1.0.1: <span class="nv">res</span><span class="o">=</span><span class="k">${</span><span class="nv">reactor</span><span class="p">.repo</span><span class="k">}</span>/org/codehaus/jackson/jackson-mapper-asl/1.0.1/jackson-mapper-asl-1.0.1.jar: java.net.MalformedURLException: no protocol: <span class="k">${</span><span class="nv">reactor</span><span class="p">.repo</span><span class="k">}</span>/org/codehaus/jackson/jackson-mapper-asl/1.0.1/jackson-mapper-asl-1.0.1.jar
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span>           :: org.codehaus.jackson#jackson-core-asl;1.0.1: several problems occurred <span class="k">while </span>resolving dependency: org.codehaus.jackson#jackson-core-asl;1.0.1 <span class="o">{</span><span class="nv">common</span><span class="o">=[</span>default<span class="o">]}</span>:
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span>   reactor-repo: unable to get resource <span class="k">for </span>org/codehaus/jackson#jackson-core-asl;1.0.1: <span class="nv">res</span><span class="o">=</span><span class="k">${</span><span class="nv">reactor</span><span class="p">.repo</span><span class="k">}</span>/org/codehaus/jackson/jackson-core-asl/1.0.1/jackson-core-asl-1.0.1.pom: java.net.MalformedURLException: no protocol: <span class="k">${</span><span class="nv">reactor</span><span class="p">.repo</span><span class="k">}</span>/org/codehaus/jackson/jackson-core-asl/1.0.1/jackson-core-asl-1.0.1.pom
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span>   reactor-repo: unable to get resource <span class="k">for </span>org/codehaus/jackson#jackson-core-asl;1.0.1: <span class="nv">res</span><span class="o">=</span><span class="k">${</span><span class="nv">reactor</span><span class="p">.repo</span><span class="k">}</span>/org/codehaus/jackson/jackson-core-asl/1.0.1/jackson-core-asl-1.0.1.jar: java.net.MalformedURLException: no protocol: <span class="k">${</span><span class="nv">reactor</span><span class="p">.repo</span><span class="k">}</span>/org/codehaus/jackson/jackson-core-asl/1.0.1/jackson-core-asl-1.0.1.jar
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span>           ::::::::::::::::::::::::::::::::::::::::::::::
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span>
</span><span class='line'><span class="o">[</span>ivy:resolve<span class="o">]</span> :: USE VERBOSE OR DEBUG MESSAGE LEVEL FOR MORE DETAILS
</span><span class='line'>
</span><span class='line'>BUILD FAILED
</span><span class='line'>/home/hadoop/software/hadoop-2.0.0-cdh4.7.0/src/hadoop-mapreduce1-project/build.xml:614: The following error occurred <span class="k">while </span>executing this line:
</span><span class='line'>/home/hadoop/software/hadoop-2.0.0-cdh4.7.0/src/hadoop-mapreduce1-project/src/contrib/build.xml:30: The following error occurred <span class="k">while </span>executing this line:
</span><span class='line'>/home/hadoop/software/hadoop-2.0.0-cdh4.7.0/src/hadoop-mapreduce1-project/src/contrib/build-contrib.xml:440: impossible to resolve dependencies:
</span><span class='line'>        resolve failed - see output <span class="k">for </span>details
</span><span class='line'>
</span><span class='line'>Total <span class="nb">time</span>: 1 minute 33 seconds
</span></code></pre></td></tr></table></div></figure>


<p>少几个jar包，能不能通过直接复制到.ivy2目录的方式解决呢？暂时没这个能力</p>

<p>尝试进到内部工程文件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> ./src/contrib/capacity-scheduler/
</span></code></pre></td></tr></table></div></figure>


<p>直接ant,报错一样的</p>

<p>原来是要定义reactor.repo这个参数
参考《基于hadoop2.0.0的fuse安装以及libhdfs和fuse-dfs的编译》
<a href="http://www.verydemo.com/demo_c161_i273713.html">http://www.verydemo.com/demo_c161_i273713.html</a>
解决办法：</p>

<p>   需要定义reactor.repo的url：</p>

<p>  在/usr/hadoop/src/hadoop-mapreduce1-project/ivy/ivysettings.xml文件中添加：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> &lt;property <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;reactor.repo&quot;</span>
</span><span class='line'>           <span class="nv">value</span><span class="o">=</span><span class="s2">&quot;http://repo1.maven.org/maven2/&quot;</span>
</span><span class='line'>  <span class="nv">override</span><span class="o">=</span><span class="s2">&quot;false&quot;</span>/&gt;
</span></code></pre></td></tr></table></div></figure>


<p>添加之后就能找到jackson</p>

<p>但是继续编译会出现</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>compile:
</span><span class='line'>     <span class="o">[</span><span class="nb">echo</span><span class="o">]</span> contrib: gridmix
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span> /home/hadoop/software/hadoop-2.0.0-cdh4.7.0/src/hadoop-mapreduce1-project/src/contrib/build-contrib.xml:193: warning: <span class="s1">&#39;includeantruntime&#39;</span> was not <span class="nb">set</span>, defaulting to build.sysclasspath<span class="o">=</span>last; <span class="nb">set </span>to <span class="nb">false </span><span class="k">for </span>repeatable builds
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span> Compiling 31 <span class="nb">source </span>files to /home/hadoop/software/hadoop-2.0.0-cdh4.7.0/src/hadoop-mapreduce1-project/build/contrib/gridmix/classes
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span> /home/hadoop/software/hadoop-2.0.0-cdh4.7.0/src/hadoop-mapreduce1-project/src/contrib/gridmix/src/java/org/apache/hadoop/mapred/gridmix/Gridmix.java:396: 错误: 类型参数? extends T不在类型变量E的范围内
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span>   private &lt;T&gt; String getEnumValues<span class="o">(</span>Enum&lt;? extends T&gt;<span class="o">[]</span> e<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span>                                         ^
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span>   其中, T,E是类型变量:
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span>     T扩展已在方法 &lt;T&gt;getEnumValues<span class="o">(</span>Enum&lt;? extends T&gt;<span class="o">[])</span>中声明的Object
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span>     E扩展已在类 Enum中声明的Enum&lt;E&gt;
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span> /home/hadoop/software/hadoop-2.0.0-cdh4.7.0/src/hadoop-mapreduce1-project/src/contrib/gridmix/src/java/org/apache/hadoop/mapred/gridmix/Gridmix.java:399: 错误: 类型参数? extends T不在类型变量E的范围内
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span>     <span class="k">for</span> <span class="o">(</span>Enum&lt;? extends T&gt; v : e<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span>               ^
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span>   其中, T,E是类型变量:
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span>     T扩展已在方法 &lt;T&gt;getEnumValues<span class="o">(</span>Enum&lt;? extends T&gt;<span class="o">[])</span>中声明的Object
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span>     E扩展已在类 Enum中声明的Enum&lt;E&gt;
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span> 注: 某些输入文件使用或覆盖了已过时的 API。
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span> 注: 有关详细信息, 请使用 -Xlint:deprecation 重新编译。
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span> 注: 某些输入文件使用了未经检查或不安全的操作。
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span> 注: 有关详细信息, 请使用 -Xlint:unchecked 重新编译。
</span><span class='line'>    <span class="o">[</span>javac<span class="o">]</span> 2 个错误
</span><span class='line'>
</span><span class='line'>BUILD FAILED
</span><span class='line'>/home/hadoop/software/hadoop-2.0.0-cdh4.7.0/src/hadoop-mapreduce1-project/build.xml:614: The following error occurred <span class="k">while </span>executing this line:
</span><span class='line'>/home/hadoop/software/hadoop-2.0.0-cdh4.7.0/src/hadoop-mapreduce1-project/src/contrib/build.xml:30: The following error occurred <span class="k">while </span>executing this line:
</span><span class='line'>/home/hadoop/software/hadoop-2.0.0-cdh4.7.0/src/hadoop-mapreduce1-project/src/contrib/build-contrib.xml:193: Compile failed; see the compiler error output <span class="k">for </span>details.
</span></code></pre></td></tr></table></div></figure>


<h2>可以参考《hadoop1.0.3编译eclipse plug-in》</h2>

<p><a href="http://www.th7.cn/Program/java/201208/88028.shtml">http://www.th7.cn/Program/java/201208/88028.shtml</a></p>

<hr />

<p>所以修改代码把Enum&lt;? extends T>改成Enum&lt;?>
重新用ant编译
编译成功
再用</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ant -Dcompile.native<span class="o">=</span><span class="nb">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>看看能否编译出libhadoop.so</p>

<p>编译成功</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>find . -type f -name <span class="s2">&quot;libhadoop.so&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是没有编译出libhadoop.so？</p>

<p>官方文档误导了（说是ant，在根目录又没有ant的配置文件，根目录下build文件夹的native目录是空的），其实要用maven编译！
其实需要完全编译hadoop才行《hadoop2.2.0 centos 编译安装详解》
<a href="http://f.dataguru.cn/thread-245387-1-1.html">http://f.dataguru.cn/thread-245387-1-1.html</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /home/hadoop/software/hadoop-2.0.0-cdh4.7.0/src
</span><span class='line'>mvn package -Pdist,native -DskipTests -Dtar
</span></code></pre></td></tr></table></div></figure>


<p>报错<code>[ERROR] Failed to execute goal org.apache.maven.plugins:maven-enforcer-plugin:1.0</code>
<code>:enforce (default) on project hadoop-main: Some Enforcer rules have failed.</code>
<code>Look above for specific messages explaining why the rule failed. -&gt; [Help 1]</code></p>

<p><a href="http://zhwj184.iteye.com/blog/1528627">http://zhwj184.iteye.com/blog/1528627</a>
如果为了提高执行速度，不想运行这个插件，则可以通过-Denforcer.skip=true或者简单的-Dskip=true就可以跳过这个这个插件的运行。如果mvn package过程中出现有关这个插件的异常，则可以简单通过这个参数跳过这个验证。</p>

<p>那么直接在编译中加参数-Denforcer.skip=true</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mvn package -Pdist,native -DskipTests -Dtar -Denforcer.skip<span class="o">=</span><span class="nb">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>再编译，这么很慢，要下载的文件很多
再次报错 <code>[ERROR] Failed to execute goal org.apache.maven.plugins:maven-antrun-plugin:1.6:</code>
<code>run (compile-proto) on project hadoop-common: An Ant</code>
<code>BuildException has occured: exec returned: 1 -&gt; [Help 1]</code></p>

<p>参考《hadoop源码编译问题》
<a href="http://wenku.baidu.com/link?url=Pkwth1GX3zRyM9BOaxuLhtQWI0dIcWUd7RYtHlvC0b5UpdoS1nc0Xxyn8dhOwnFMytT-Qeo_UZ31WxKE5ruREXF9Al_OGD6E5wr8GB8QRJy">http://wenku.baidu.com/link?url=Pkwth1GX3zRyM9BOaxuLhtQWI0dIcWUd7RYtHlvC0b5UpdoS1nc0Xxyn8dhOwnFMytT-Qeo_UZ31WxKE5ruREXF9Al_OGD6E5wr8GB8QRJy</a></p>

<p>看来是protoc版本过低导致的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget http://protobuf.googlecode.com/files/protobuf-2.4.1.tar.gz
</span></code></pre></td></tr></table></div></figure>


<p>被墙的自己想办法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>tar xzf protobuf-2.4.1.tar.gz
</span><span class='line'><span class="nb">cd </span>protobuf-2.4.1
</span><span class='line'><span class="o">[</span>hadoop@mdn4namenode1 protobuf-2.4.1<span class="o">]</span><span class="nv">$ </span>./configure
</span><span class='line'>checking build system type... x86_64-unknown-linux-gnu
</span><span class='line'>checking host system type... x86_64-unknown-linux-gnu
</span><span class='line'>checking target system type... x86_64-unknown-linux-gnu
</span><span class='line'>checking <span class="k">for </span>a BSD-compatible install... /usr/bin/install -c
</span><span class='line'>checking whether build environment is sane... yes
</span><span class='line'>checking <span class="k">for </span>a thread-safe mkdir -p... /usr/bin/mkdir -p
</span><span class='line'>checking <span class="k">for </span>gawk... gawk
</span><span class='line'>checking whether make sets <span class="k">$(</span>MAKE<span class="k">)</span>... yes
</span><span class='line'>checking <span class="k">for </span>gcc... no
</span><span class='line'>checking <span class="k">for </span>cc... no
</span><span class='line'>checking <span class="k">for </span>cl.exe... no
</span><span class='line'>configure: error: in <span class="sb">`</span>/home/hadoop/software/protobuf-2.4.1<span class="s1">&#39;:</span>
</span><span class='line'><span class="s1">configure: error: no acceptable C compiler found in $PATH</span>
</span><span class='line'><span class="s1">See `config.log&#39;</span> <span class="k">for </span>more details.
</span><span class='line'>
</span><span class='line'>sudo yum install gcc
</span></code></pre></td></tr></table></div></figure>


<p>继续安装
<code>configure: error: C++ preprocessor "/lib/cpp" fails sanity check</code></p>

<p>又出现很多问题</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo yum install gcc-c++
</span></code></pre></td></tr></table></div></figure>


<p>再次</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./configure
</span><span class='line'>make
</span><span class='line'>sudo make install
</span></code></pre></td></tr></table></div></figure>


<p>回来继续编译hadoop</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>ERROR<span class="o">]</span> Failed to execute goal org.apache.maven.plugins:maven-antrun-plugin:1.6:run <span class="o">(</span>make<span class="o">)</span> on project hadoop-common: An Ant BuildException has occured: Execute failed: java.io.IOException: Cannot run program <span class="s2">&quot;cmake&quot;</span> <span class="o">(</span>in directory <span class="s2">&quot;/home/hadoop/software/hadoop-2.0.0-cdh4.7.0/src/hadoop-common-project/hadoop-common/target/native&quot;</span><span class="o">)</span>: <span class="nv">error</span><span class="o">=</span>2, 没有那个文件或目录 -&gt; <span class="o">[</span>Help 1<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>没装cmake</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo yum install cmake
</span></code></pre></td></tr></table></div></figure>


<p>还有一些也装上</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo yum install pkgconfig  openssl openssl-devel
</span></code></pre></td></tr></table></div></figure>


<p>这些可以参考《64位操作系统下重新编译hadoop-2.2.0》（这文章提到应该用mvn package -DskipTests -Pdist,native -Dtar来编译hadoop2）
<a href="http://blog.itpub.net/20777547/viewspace-1147174">http://blog.itpub.net/20777547/viewspace-1147174</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>INFO<span class="o">]</span>                                                                                                                             <span class="o">[</span>40/1862<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Main ................................ SUCCESS <span class="o">[</span>5.349s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Project POM ......................... SUCCESS <span class="o">[</span>3.432s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Annotations ......................... SUCCESS <span class="o">[</span>6.518s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Assemblies .......................... SUCCESS <span class="o">[</span>0.875s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Project Dist POM .................... SUCCESS <span class="o">[</span>3.334s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Auth ................................ SUCCESS <span class="o">[</span>6.069s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Auth Examples ....................... SUCCESS <span class="o">[</span>4.573s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Jets3t Cloudera Dependencies ...................... SUCCESS <span class="o">[</span>6.534s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Common .............................. SUCCESS <span class="o">[</span>2:01.338s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Common Project ...................... SUCCESS <span class="o">[</span>0.452s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop HDFS ................................ SUCCESS <span class="o">[</span>2:06.706s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop HttpFS .............................. SUCCESS <span class="o">[</span>24.891s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop HDFS Project ........................ SUCCESS <span class="o">[</span>0.744s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn ....................................... SUCCESS <span class="o">[</span>28.902s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-api ................................... SUCCESS <span class="o">[</span>1:08.858s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-common ................................ SUCCESS <span class="o">[</span>56.000s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-server ................................ SUCCESS <span class="o">[</span>0.517s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-server-common ......................... SUCCESS <span class="o">[</span>16.093s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-server-nodemanager .................... SUCCESS <span class="o">[</span>31.421s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-server-web-proxy ...................... SUCCESS <span class="o">[</span>7.293s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-server-resourcemanager ................ SUCCESS <span class="o">[</span>22.440s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-server-tests .......................... SUCCESS <span class="o">[</span>1.168s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-client ................................ SUCCESS <span class="o">[</span>8.536s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-applications .......................... SUCCESS <span class="o">[</span>0.276s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-applications-distributedshell ......... SUCCESS <span class="o">[</span>4.767s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-mapreduce-client ........................... SUCCESS <span class="o">[</span>0.433s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-mapreduce-client-core ...................... SUCCESS <span class="o">[</span>54.060s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-applications-unmanaged-am-launcher .... SUCCESS <span class="o">[</span>5.197s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-site .................................. SUCCESS <span class="o">[</span>0.517s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-yarn-project ............................... SUCCESS <span class="o">[</span>36.840s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-mapreduce-client-common .................... SUCCESS <span class="o">[</span>33.592s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-mapreduce-client-shuffle ................... SUCCESS <span class="o">[</span>5.179s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-mapreduce-client-app ....................... SUCCESS <span class="o">[</span>18.536s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-mapreduce-client-hs ........................ SUCCESS <span class="o">[</span>9.267s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-mapreduce-client-jobclient ................. SUCCESS <span class="o">[</span>10.860s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-mapreduce-client-hs-plugins ................ SUCCESS <span class="o">[</span>4.425s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop MapReduce Examples .................. SUCCESS <span class="o">[</span>14.302s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> hadoop-mapreduce .................................. SUCCESS <span class="o">[</span>4.028s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop MapReduce Streaming ................. SUCCESS <span class="o">[</span>9.253s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Distributed Copy .................... SUCCESS <span class="o">[</span>1:14.406s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Archives ............................ SUCCESS <span class="o">[</span>4.108s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Rumen ............................... SUCCESS <span class="o">[</span>11.244s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Gridmix ............................. SUCCESS <span class="o">[</span>10.038s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Data Join ........................... SUCCESS <span class="o">[</span>5.673s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Extras .............................. SUCCESS <span class="o">[</span>6.033s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Pipes ............................... SUCCESS <span class="o">[</span>14.666s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Tools Dist .......................... SUCCESS <span class="o">[</span>3.519s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Tools ............................... SUCCESS <span class="o">[</span>0.066s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Distribution ........................ SUCCESS <span class="o">[</span>30.039s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Client .............................. SUCCESS <span class="o">[</span>20.618s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Apache Hadoop Mini-Cluster ........................ SUCCESS <span class="o">[</span>2.427s<span class="o">]</span>
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> BUILD SUCCESS
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Total <span class="nb">time</span>: 15:51.852s
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Finished at: Fri Jul 25 17:40:23 CST 2014
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> Final Memory: 127M/305M
</span><span class='line'><span class="o">[</span>INFO<span class="o">]</span> ------------------------------------------------------------------------
</span></code></pre></td></tr></table></div></figure>


<p>全部编译成功，然后找下libhadoop.so</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>find . -name <span class="s2">&quot;libhadoop.so&quot;</span>
</span><span class='line'>./src/hadoop-common-project/hadoop-common/target/hadoop-common-2.0.0-cdh4.7.0/lib/native/libhadoop.so
</span><span class='line'>./src/hadoop-common-project/hadoop-common/target/native/target/usr/local/lib/libhadoop.so
</span><span class='line'>./src/hadoop-dist/target/hadoop-2.0.0-cdh4.7.0/lib/native/libhadoop.so
</span></code></pre></td></tr></table></div></figure>


<p>编译出来了，然后放到文章一开始说的$HADOOP_HOME/lib/native/目录下面，以后运行就不再报错了。</p>

<p>参考文章
<a href="http://www.linuxidc.com/Linux/2012-04/59200.htm">《Hadoop本地库与系统版本不一致引起的错误解决方法》</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[zookeeper伪分布配置安装]]></title>
    <link href="http://evoupsight.com/blog/2014/07/30/zookeeper-pseudo-distributed-installation/"/>
    <updated>2014-07-30T17:22:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/07/30/zookeeper-pseudo-distributed-installation</id>
    <content type="html"><![CDATA[<h3>场景</h3>

<p>我的开发机是在vmware的centos6.5上搭建了一个hadoop节点来做开发，现在想在项目中加入zookeeper做HA的功能（一个leader，多个follower），一开始想到的是再搞一台机器实现完全分布，为了一个zookeeper其实不用再搞一台机器节省资源，后来考虑了下其实还有个伪分布的概念，所谓伪分布就是在一台机器上启动多个实例。下文详细描述如何在一台机器上启动多个zookeeper实例实现伪分布zk集群。</p>

<!-- more -->


<h3>伪分布集群安装配置</h3>

<p>准备一台机器，假定IP为192.168.216.198。</p>

<h4>下载安装软件</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /home/hadoop/software
</span><span class='line'><span class="nv">$ </span>wget http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.4.5/zookeeper-3.4.5.tar.gz
</span><span class='line'><span class="nv">$ </span>tar xzf zookeeper-3.4.5.tar.gz
</span><span class='line'><span class="nv">$ </span>sudo mv zookeeper-3.4.5 /usr/local/
</span><span class='line'><span class="nv">$ </span>sudo mv /usr/local/zookeeper-3.4.5/ /usr/local/zookeeper
</span></code></pre></td></tr></table></div></figure>


<h4>配置三个实例的myid</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir -p /home/hadoop/zoo/zk1 /home/hadoop/zoo/zk2 /home/hadoop/zoo/zk3
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;1&quot;</span> &gt; /home/hadoop/zoo/zk1/myid
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;2&quot;</span> &gt; /home/hadoop/zoo/zk2/myid
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;3&quot;</span> &gt; /home/hadoop/zoo/zk3/myid
</span></code></pre></td></tr></table></div></figure>


<h4>分配制作三个配置文件</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo cp /usr/local/zookeeper/conf/zoo_sample.cfg /usr/local/zookeeper/conf/zoo1.cfg
</span><span class='line'><span class="nv">$ </span>sudo cp /usr/local/zookeeper/conf/zoo_sample.cfg /usr/local/zookeeper/conf/zoo2.cfg
</span><span class='line'><span class="nv">$ </span>sudo cp /usr/local/zookeeper/conf/zoo_sample.cfg /usr/local/zookeeper/conf/zoo3.cfg
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>sudo vim /usr/local/zookeeper/conf/zoo1.cfg
</span><span class='line'><span class="nv">tickTime</span><span class="o">=</span>2000
</span><span class='line'><span class="nv">initLimit</span><span class="o">=</span>10
</span><span class='line'><span class="nv">syncLimit</span><span class="o">=</span>5
</span><span class='line'><span class="nv">dataDir</span><span class="o">=</span>/home/hadoop/zoo/zk1/
</span><span class='line'><span class="nv">clientPort</span><span class="o">=</span>2181
</span><span class='line'>server.1<span class="o">=</span>192.168.216.198:2889:3888
</span><span class='line'>server.2<span class="o">=</span>192.168.216.198:2889:3889
</span><span class='line'>server.3<span class="o">=</span>192.168.216.198:2890:3890
</span><span class='line'>
</span><span class='line'><span class="nv">$sudo</span> vim usr/local/zookeeper/conf/zoo2.cfg
</span><span class='line'><span class="nv">tickTime</span><span class="o">=</span>2000
</span><span class='line'><span class="nv">initLimit</span><span class="o">=</span>10
</span><span class='line'><span class="nv">syncLimit</span><span class="o">=</span>5
</span><span class='line'><span class="nv">dataDir</span><span class="o">=</span>/home/hadoop/zoo/zk2/
</span><span class='line'><span class="nv">clientPort</span><span class="o">=</span>2182
</span><span class='line'>server.1<span class="o">=</span>192.168.216.198:2889:3888
</span><span class='line'>server.2<span class="o">=</span>192.168.216.198:2889:3889
</span><span class='line'>server.3<span class="o">=</span>192.168.216.198:2890:3890
</span><span class='line'>
</span><span class='line'><span class="nv">$sudo</span> vim /usr/local/zookeeper/conf/zoo3.cfg
</span><span class='line'>/usr/local/zookeeper/conf/zoo3.cfg:tickTime<span class="o">=</span>2000
</span><span class='line'>/usr/local/zookeeper/conf/zoo3.cfg:initLimit<span class="o">=</span>10
</span><span class='line'>/usr/local/zookeeper/conf/zoo3.cfg:syncLimit<span class="o">=</span>5
</span><span class='line'>/usr/local/zookeeper/conf/zoo3.cfg:dataDir<span class="o">=</span>/home/hadoop/zoo/zk3/
</span><span class='line'>/usr/local/zookeeper/conf/zoo3.cfg:clientPort<span class="o">=</span>2183
</span><span class='line'>/usr/local/zookeeper/conf/zoo3.cfg:server.1<span class="o">=</span>192.168.216.198:2889:3888
</span><span class='line'>/usr/local/zookeeper/conf/zoo3.cfg:server.2<span class="o">=</span>192.168.216.198:2889:3889
</span><span class='line'>/usr/local/zookeeper/conf/zoo3.cfg:server.3<span class="o">=</span>192.168.216.198:2890:3890
</span></code></pre></td></tr></table></div></figure>


<h4>给当前用户账户访问权限（可选）</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo chown -R hadoop:hadoop /usr/local/zookeeper
</span></code></pre></td></tr></table></div></figure>


<h4>启动集群</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/usr/local/zookeeper/bin/zkServer.sh start /usr/local/zookeeper/conf/zoo1.cfg
</span><span class='line'>JMX enabled by default
</span><span class='line'>Using config: /usr/local/zookeeper/conf/zoo1.cfg
</span><span class='line'>Starting zookeeper ... STARTED
</span><span class='line'><span class="nv">$ </span>/usr/local/zookeeper/bin/zkServer.sh start /usr/local/zookeeper/conf/zoo2.cfg
</span><span class='line'>JMX enabled by default
</span><span class='line'>Using config: /usr/local/zookeeper/conf/zoo2.cfg
</span><span class='line'>Starting zookeeper ... STARTED
</span><span class='line'><span class="nv">$ </span>/usr/local/zookeeper/bin/zkServer.sh start /usr/local/zookeeper/conf/zoo3.cfg
</span><span class='line'>JMX enabled by default
</span><span class='line'>Using config: /usr/local/zookeeper/conf/zoo3.cfg
</span><span class='line'>Starting zookeeper ... STARTED
</span><span class='line'><span class="o">[</span>hadoop@mdn4namenode1 zk1<span class="o">]</span><span class="nv">$ </span>jps
</span><span class='line'>3115 Jps
</span><span class='line'>3084 QuorumPeerMain
</span><span class='line'>3043 QuorumPeerMain
</span><span class='line'>3015 QuorumPeerMain
</span></code></pre></td></tr></table></div></figure>


<h4>查看zookeeper工作文件目录结构</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ls -R /home/hadoop/zoo/
</span><span class='line'>/home/hadoop/zoo/:
</span><span class='line'>zk1  zk2  zk3
</span><span class='line'>
</span><span class='line'>/home/hadoop/zoo/zk1:
</span><span class='line'>myid  version-2  zookeeper.out  zookeeper_server.pid
</span><span class='line'>
</span><span class='line'>/home/hadoop/zoo/zk1/version-2:
</span><span class='line'>acceptedEpoch  currentEpoch  snapshot.0
</span><span class='line'>
</span><span class='line'>/home/hadoop/zoo/zk2:
</span><span class='line'>myid  version-2  zookeeper_server.pid
</span><span class='line'>
</span><span class='line'>/home/hadoop/zoo/zk2/version-2:
</span><span class='line'>acceptedEpoch  currentEpoch  snapshot.0
</span><span class='line'>
</span><span class='line'>/home/hadoop/zoo/zk3:
</span><span class='line'>myid  version-2  zookeeper_server.pid
</span><span class='line'>
</span><span class='line'>/home/hadoop/zoo/zk3/version-2:
</span><span class='line'>acceptedEpoch  currentEpoch  snapshot.100000000
</span></code></pre></td></tr></table></div></figure>


<h4>查看zookeeper运行情况</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/usr/local/zookeeper/bin/zkServer.sh status /usr/local/zookeeper/conf/zoo1.cfg
</span><span class='line'>/usr/local/zookeeper/bin/zkServer.sh status /usr/local/zookeeper/conf/zoo2.cfg
</span><span class='line'>/usr/local/zookeeper/bin/zkServer.sh status /usr/local/zookeeper/conf/zoo3.cfg
</span></code></pre></td></tr></table></div></figure>


<p>报错，需要修正zkServer.sh
把</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#STAT=`$JAVA &quot;-Dzookeeper.log.dir=${ZOO_LOG_DIR}&quot; &quot;-Dzookeeper.root.logger=${ZOO_LOG4J_PROP}&quot; \</span>
</span><span class='line'>         <span class="c">#-cp &quot;$CLASSPATH&quot; $JVMFLAGS org.apache.zookeeper.client.FourLetterWordMain localhost \</span>
</span><span class='line'>         <span class="c">#$(grep &quot;^[[:space:]]*clientPort&quot; &quot;$ZOOCFG&quot; | sed -e &#39;s/.*=//&#39;) srvr 2&gt; /dev/null    \</span>
</span><span class='line'>      <span class="c">#| grep Mode`</span>
</span></code></pre></td></tr></table></div></figure>


<p>给注释了，然后在其下加一行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">STAT</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo </span>stat | nc 127.0.0.1 <span class="k">$(</span>grep clientPort <span class="s2">&quot;$ZOOCFG&quot;</span> | sed -e <span class="s1">&#39;s/.*=//&#39;</span><span class="k">)</span> 2&gt; /dev/null| grep Mode<span class="sb">`</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样就妥妥的了:)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>/usr/local/zookeeper/bin/zkServer.sh status /usr/local/zookeeper/conf/zoo1.cfg
</span><span class='line'>JMX enabled by default
</span><span class='line'>Using config: /usr/local/zookeeper/conf/zoo1.cfg
</span><span class='line'>Mode: follower
</span><span class='line'><span class="nv">$ </span>/usr/local/zookeeper/bin/zkServer.sh status /usr/local/zookeeper/conf/zoo2.cfg
</span><span class='line'>JMX enabled by default
</span><span class='line'>Using config: /usr/local/zookeeper/conf/zoo2.cfg
</span><span class='line'>Mode: leader
</span><span class='line'><span class="nv">$ </span>/usr/local/zookeeper/bin/zkServer.sh status /usr/local/zookeeper/conf/zoo3.cfg
</span><span class='line'>JMX enabled by default
</span><span class='line'>Using config: /usr/local/zookeeper/conf/zoo3.cfg
</span><span class='line'>Mode: follower
</span></code></pre></td></tr></table></div></figure>


<h4>加入启动项</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo vim /etc/rc.d/rc.local
</span><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>su - hadoop -c <span class="s2">&quot;/usr/local/zookeeper/bin/zkServer.sh start /usr/local/zookeeper/conf/zoo1.cfg&quot;</span>
</span><span class='line'>su - hadoop -c <span class="s2">&quot;/usr/local/zookeeper/bin/zkServer.sh start /usr/local/zookeeper/conf/zoo2.cfg&quot;</span>
</span><span class='line'>su - hadoop -c <span class="s2">&quot;/usr/local/zookeeper/bin/zkServer.sh start /usr/local/zookeeper/conf/zoo3.cfg&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>收工。</p>

<h4>参考资料</h4>

<p><a href="http://blog.fens.me/hadoop-zookeeper-intro/">《ZooKeeper伪分布式集群安装及使用 | 粉丝日志》</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[hadoop put文件报DataStreamer Exception异常]]></title>
    <link href="http://evoupsight.com/blog/2014/07/30/hadoop-put-warn-datastreamer-exception/"/>
    <updated>2014-07-30T17:05:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/07/30/hadoop-put-warn-datastreamer-exception</id>
    <content type="html"><![CDATA[<p>今天在一个hadoop节点上传测试文件的时候</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bin/hadoop fs -put /home/hadoop/project/s3log.txt /yin_test/s3log
</span></code></pre></td></tr></table></div></figure>


<p>出现如下报错:</p>

<!-- more -->


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>14/07/25 13:23:05 WARN util.NativeCodeLoader: Unable to load native-hadoop library <span class="k">for </span>your platform... using <span class="nb">builtin</span>-java classes where app
</span><span class='line'>licable
</span><span class='line'>14/07/25 13:23:06 WARN hdfs.DFSClient: DataStreamer Exception
</span><span class='line'>org.apache.hadoop.ipc.RemoteException<span class="o">(</span>java.io.IOException<span class="o">)</span>: File /yin_test/s3log/s3log.txt._COPYING_ could only be replicated to 0 nodes instead of minReplication <span class="o">(=</span>1<span class="o">)</span>.  There are 0 datanode<span class="o">(</span>s<span class="o">)</span> running and no node<span class="o">(</span>s<span class="o">)</span> are excluded in this operation.
</span><span class='line'>        at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.chooseTarget<span class="o">(</span>BlockManager.java:1361<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.getAdditionalBlock<span class="o">(</span>FSNamesystem.java:2362<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.addBlock<span class="o">(</span>NameNodeRpcServer.java:501<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolServerSideTranslatorPB.addBlock<span class="o">(</span>ClientNamenodeProtocolServerSideTranslato
</span><span class='line'>rPB.java:299<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.hdfs.protocol.proto.ClientNamenodeProtocolProtos<span class="nv">$ClientNamenodeProtocol$2</span>.callBlockingMethod<span class="o">(</span>ClientNamenodeProt
</span><span class='line'>ocolProtos.java:44954<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.ipc.ProtobufRpcEngine<span class="nv">$Server$ProtoBufRpcInvoker</span>.call<span class="o">(</span>ProtobufRpcEngine.java:453<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.ipc.RPC<span class="nv">$Server</span>.call<span class="o">(</span>RPC.java:1002<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.ipc.Server<span class="nv">$Handler$1</span>.run<span class="o">(</span>Server.java:1752<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.ipc.Server<span class="nv">$Handler$1</span>.run<span class="o">(</span>Server.java:1748<span class="o">)</span>
</span><span class='line'>        at java.security.AccessController.doPrivileged<span class="o">(</span>Native Method<span class="o">)</span>
</span><span class='line'>        at javax.security.auth.Subject.doAs<span class="o">(</span>Subject.java:415<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.security.UserGroupInformation.doAs<span class="o">(</span>UserGroupInformation.java:1438<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.ipc.Server<span class="nv">$Handler</span>.run<span class="o">(</span>Server.java:1746<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>        at org.apache.hadoop.ipc.Client.call<span class="o">(</span>Client.java:1238<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.ipc.ProtobufRpcEngine<span class="nv">$Invoker</span>.invoke<span class="o">(</span>ProtobufRpcEngine.java:202<span class="o">)</span>
</span><span class='line'>        at com.sun.proxy.<span class="nv">$Proxy9</span>.addBlock<span class="o">(</span>Unknown Source<span class="o">)</span>
</span><span class='line'>        at sun.reflect.NativeMethodAccessorImpl.invoke0<span class="o">(</span>Native Method<span class="o">)</span>
</span><span class='line'>        at sun.reflect.NativeMethodAccessorImpl.invoke<span class="o">(</span>NativeMethodAccessorImpl.java:57<span class="o">)</span>
</span><span class='line'>        at sun.reflect.DelegatingMethodAccessorImpl.invoke<span class="o">(</span>DelegatingMethodAccessorImpl.java:43<span class="o">)</span>
</span><span class='line'>        at java.lang.reflect.Method.invoke<span class="o">(</span>Method.java:606<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod<span class="o">(</span>RetryInvocationHandler.java:164<span class="o">)</span>
</span><span class='line'>        at org.apache.hadoop.io.retry.RetryInvocationHandler.invoke<span class="o">(</span>RetryInvocationHandler.java:83<span class="o">)</span>
</span><span class='line'>        at com.sun.proxy.<span class="nv">$Proxy9</span>.addBlock<span class="o">(</span>Unknown Source<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>已经把防火墙关了，经过一番查询研究，原来是dfs.namenode.name.dir和dfs.datanode.data.dir再重新格式化后要被清空的原因。删除这2个目录下的文件，然后重新格式化，再次put恢复正常。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[centos7配置静态IP]]></title>
    <link href="http://evoupsight.com/blog/2014/07/27/centos7-configure-static-ip/"/>
    <updated>2014-07-27T23:02:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/07/27/centos7-configure-static-ip</id>
    <content type="html"><![CDATA[<p>centos7按照初始安装时候的developer tool方式一路装好,在vmware里已经设置为bridge模式，按理说是会自动按照DHCP联网成功的，结果却发现连网卡都没有激活，这里记录下。</p>

<!-- more -->


<p>配置网卡</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vim /etc/sysconfig/network-scripts/ifcfg-ens33</span></code></pre></td></tr></table></div></figure>


<p>原先的配置是这样的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HWADDR=00:0C:29:2C:E5:30
</span><span class='line'>TYPE=Ethernet
</span><span class='line'>BOOTPROTO=static
</span><span class='line'>DEFROUTE=yes
</span><span class='line'>PEERDNS=yes
</span><span class='line'>PEERROUTES=yes
</span><span class='line'>IPV4_FAILURE_FATAL=no
</span><span class='line'>IPV6INIT=yes
</span><span class='line'>IPV6_AUTOCONF=yes
</span><span class='line'>IPV6_DEFROUTE=yes
</span><span class='line'>IPV6_PEERDNS=yes
</span><span class='line'>IPV6_PEERROUTES=yes
</span><span class='line'>IPV6_FAILURE_FATAL=no
</span><span class='line'>NAME=ens33
</span><span class='line'>UUID=ea35e10e-ff50-4a7a-92d5-ab54c58d8b44
</span><span class='line'>ONBOOT=no</span></code></pre></td></tr></table></div></figure>


<p>没想到在centos7里默认是不启动网卡的，奇怪的设定啊，所以网卡才没有激活
改为yes，然后再加上以下几个参数的设置</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>IPADDR=192.168.2.181
</span><span class='line'>GATEWAY=192.168.2.1
</span><span class='line'>DNS1=114.114.114.114
</span><span class='line'>DNS2=8.8.8.8</span></code></pre></td></tr></table></div></figure>


<p>其中IPADDR为网卡地址，GATEWAY为网关地址，我在vmware里采用的bridge，所以就是实际的路由器的地址。
DNS1和DNS2这2个至少要填DNS1。
编辑/etc/resolv.conf
并且在下面加入了</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>nameserver 114.114.114.114
</span><span class='line'>nameserver 8.8.8.8</span></code></pre></td></tr></table></div></figure>


<p>如果按照上面把/etc/resolv.conf中的dns也配置好之后</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo service network restart</span></code></pre></td></tr></table></div></figure>


<p>这样应该就完成配置可以上网了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[rrdtool的socket通讯接口rrdsrv]]></title>
    <link href="http://evoupsight.com/blog/2014/07/10/rrdsrv-usage/"/>
    <updated>2014-07-10T17:28:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/07/10/rrdsrv-usage</id>
    <content type="html"><![CDATA[<p>原来以为rrdtool只是个本地数据库，这次写java程序看了几个rrdtool的java实现的源码,在其中一款中发现原来rrdtool居然还支持inetd超级服务器的用法，也就是rrdsrv。以下以freebsd下rrdsrv的配置为例，介绍使用方法：</p>

<!--more-->


<p>假设rrdtool的安装路径在/usr/local/bin/rrdtool，然后存放rrd数据库的路径为/services/rrds/</p>

<p>首先编辑/etc/inetd.conf，加入</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rrdsrv  stream  tcp nowait  root    /usr/local/bin/rrdtool  rrdtool - /services/rrds/</span></code></pre></td></tr></table></div></figure>


<p>然后再编辑/etc/services，加入</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rrdsrv 13900/tcp</span></code></pre></td></tr></table></div></figure>


<p>在/etc/rc.conf中</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>inetd_enable="YES"</span></code></pre></td></tr></table></div></figure>


<p>然后</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo /etc/rc.d/inetd start
</span></code></pre></td></tr></table></div></figure>


<p>这样13900端口就支持使用socket方式的rrdtool命令操作了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>yin@yin-arch rrds<span class="o">]</span>&gt;telnet 127.0.0.1 13900
</span><span class='line'>Trying 127.0.0.1...
</span><span class='line'>Connected to localhost.
</span><span class='line'>Escape character is <span class="s1">&#39;^]&#39;</span>.
</span><span class='line'>
</span><span class='line'>info load.rrd
</span><span class='line'><span class="nv">filename</span> <span class="o">=</span> <span class="s2">&quot;load.rrd&quot;</span>
</span><span class='line'><span class="nv">rrd_version</span> <span class="o">=</span> <span class="s2">&quot;0003&quot;</span>
</span><span class='line'><span class="nv">step</span> <span class="o">=</span> 15
</span><span class='line'><span class="nv">last_update</span> <span class="o">=</span> 1404984273
</span><span class='line'><span class="nv">header_size</span> <span class="o">=</span> 1000
</span><span class='line'>ds<span class="o">[</span>load<span class="o">]</span>.index <span class="o">=</span> 0
</span><span class='line'>ds<span class="o">[</span>load<span class="o">]</span>.type <span class="o">=</span> <span class="s2">&quot;GAUGE&quot;</span>
</span><span class='line'>ds<span class="o">[</span>load<span class="o">]</span>.minimal_heartbeat <span class="o">=</span> 120
</span><span class='line'>ds<span class="o">[</span>load<span class="o">]</span>.min <span class="o">=</span> NaN
</span><span class='line'>ds<span class="o">[</span>load<span class="o">]</span>.max <span class="o">=</span> NaN
</span><span class='line'>ds<span class="o">[</span>load<span class="o">]</span>.last_ds <span class="o">=</span> <span class="s2">&quot;5.73242000000000029303e-01&quot;</span>
</span><span class='line'>ds<span class="o">[</span>load<span class="o">]</span>.value <span class="o">=</span> 2.0151107237e+00
</span><span class='line'>ds<span class="o">[</span>load<span class="o">]</span>.unknown_sec <span class="o">=</span> 0
</span><span class='line'>rra<span class="o">[</span>0<span class="o">]</span>.cf <span class="o">=</span> <span class="s2">&quot;AVERAGE&quot;</span>
</span><span class='line'>rra<span class="o">[</span>0<span class="o">]</span>.rows <span class="o">=</span> 5856
</span><span class='line'>rra<span class="o">[</span>0<span class="o">]</span>.cur_row <span class="o">=</span> 5072
</span><span class='line'>rra<span class="o">[</span>0<span class="o">]</span>.pdp_per_row <span class="o">=</span> 1
</span><span class='line'>rra<span class="o">[</span>0<span class="o">]</span>.xff <span class="o">=</span> 5.0000000000e-01
</span><span class='line'>rra<span class="o">[</span>0<span class="o">]</span>.cdp_prep<span class="o">[</span>0<span class="o">]</span>.value <span class="o">=</span> NaN
</span><span class='line'>rra<span class="o">[</span>0<span class="o">]</span>.cdp_prep<span class="o">[</span>0<span class="o">]</span>.unknown_datapoints <span class="o">=</span> 0
</span><span class='line'>rra<span class="o">[</span>1<span class="o">]</span>.cf <span class="o">=</span> <span class="s2">&quot;AVERAGE&quot;</span>
</span><span class='line'>rra<span class="o">[</span>1<span class="o">]</span>.rows <span class="o">=</span> 20160
</span><span class='line'>rra<span class="o">[</span>1<span class="o">]</span>.cur_row <span class="o">=</span> 9119
</span><span class='line'>rra<span class="o">[</span>1<span class="o">]</span>.pdp_per_row <span class="o">=</span> 4
</span><span class='line'>rra<span class="o">[</span>1<span class="o">]</span>.xff <span class="o">=</span> 5.0000000000e-01
</span><span class='line'>rra<span class="o">[</span>1<span class="o">]</span>.cdp_prep<span class="o">[</span>0<span class="o">]</span>.value <span class="o">=</span> 1.1429347927e+00
</span><span class='line'>rra<span class="o">[</span>1<span class="o">]</span>.cdp_prep<span class="o">[</span>0<span class="o">]</span>.unknown_datapoints <span class="o">=</span> 0
</span><span class='line'>rra<span class="o">[</span>2<span class="o">]</span>.cf <span class="o">=</span> <span class="s2">&quot;AVERAGE&quot;</span>
</span><span class='line'>rra<span class="o">[</span>2<span class="o">]</span>.rows <span class="o">=</span> 52704
</span><span class='line'>rra<span class="o">[</span>2<span class="o">]</span>.cur_row <span class="o">=</span> 46249
</span><span class='line'>rra<span class="o">[</span>2<span class="o">]</span>.pdp_per_row <span class="o">=</span> 40
</span><span class='line'>rra<span class="o">[</span>2<span class="o">]</span>.xff <span class="o">=</span> 5.0000000000e-01
</span><span class='line'>rra<span class="o">[</span>2<span class="o">]</span>.cdp_prep<span class="o">[</span>0<span class="o">]</span>.value <span class="o">=</span> 9.7464362627e+00
</span><span class='line'>rra<span class="o">[</span>2<span class="o">]</span>.cdp_prep<span class="o">[</span>0<span class="o">]</span>.unknown_datapoints <span class="o">=</span> 0
</span><span class='line'>OK u:0.00 s:0.01 r:41.67
</span></code></pre></td></tr></table></div></figure>


<p>值得一提的是，除了支持rrdtool的info、create、update等内置命令，更可以调用系统指令cd、mkdir、ls等指令，非常强大。可以看出作者的编程思路非常奇特，居然还可以这样用。于是我借助这个特性，实现了网络rrdtool指令的操作，like memcache：）</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[mysql复制同步修复工具]]></title>
    <link href="http://evoupsight.com/blog/2014/07/10/mysql-double-master-repair/"/>
    <updated>2014-07-10T16:44:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/07/10/mysql-double-master-repair</id>
    <content type="html"><![CDATA[<p>采用mysql双主同步这种架构时要格外注意数据同步的问题，如果没有解决好不同步的问题，那就像《网站运维：保持数据实时的秘技》中提到的，简直就是期待数据不同步。所以对于实际使用过程中还是要紧密监控，对于数据不同步的状况，需要及时报警和处理，不然就等着数据异常吧！下文是主从同步的修复，主主的修复，只要把另外一个主看成从，互相修一下就可以了，见下文：</p>

<!--more-->


<h3>恢复主主的工具</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; wget http://www.percona.com/redir/downloads/percona-toolkit/2.2.6/percona-toolkit-2.2.6.tar.gz
</span><span class='line'>&gt; tar xzf percona-toolkit-2.2.6.tar.gz
</span><span class='line'>&gt; <span class="nb">cd </span>percona-toolkit-2.2.6
</span><span class='line'>&gt; perl Makefile.PL
</span><span class='line'>Warning: prerequisite DBD::mysql 3 not found.
</span><span class='line'>Warning: prerequisite DBI 1.46 not found.
</span><span class='line'>Writing Makefile <span class="k">for </span>percona-toolkit
</span><span class='line'>
</span><span class='line'>&gt; sudo cpan YAML
</span><span class='line'>&gt; sudo cpan DBD::mysql
</span></code></pre></td></tr></table></div></figure>


<p>出现询问是否yes，一路选择yes</p>

<p>遇到测试的时候出现
<code>FAILED--Further testing stopped: ERROR: Access denied for user 'root'@'localhost' (using password: NO)</code></p>

<p>进入mysql修改一下默认密码为空</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>GRANT ALL PRIVILEGES ON *.* TO root@<span class="s1">&#39;localhost&#39;</span> IDENTIFIED BY <span class="s1">&#39;&#39;</span>;
</span><span class='line'>flush privileges;
</span></code></pre></td></tr></table></div></figure>


<p>回来继续</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo cpan DBD::mysql
</span></code></pre></td></tr></table></div></figure>


<h3>检查完整性</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>yinjia@hm15hadoop01 percona-toolkit-2.2.6<span class="o">]</span>&gt;sudo pt-table-checksum  --recursion-method<span class="o">=</span>processlist
</span><span class='line'>Cannot connect to <span class="nv">h</span><span class="o">=</span>10.10.8.45
</span><span class='line'>Diffs cannot be detected because no slaves were found.  Please <span class="nb">read </span>the --recursion-method documentation <span class="k">for </span>information.
</span></code></pre></td></tr></table></div></figure>


<p>在主上运行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mysql&gt; show slave hosts;
</span><span class='line'>+-----------+------+------+-----------+
</span><span class='line'>| Server_id | Host | Port | Master_id |
</span><span class='line'>+-----------+------+------+-----------+
</span><span class='line'>|         2 |      | 3306 |         1 |
</span><span class='line'>+-----------+------+------+-----------+
</span><span class='line'>1 row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>发现是host没有所以导致脚本会报错</p>

<p>到slave上，my.cnf中添加report_host=10.10.8.45 #设置成本机IP，然后重启slave
回到主上</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mysql&gt; show slave hosts;
</span><span class='line'>+-----------+------------+------+-----------+
</span><span class='line'>| Server_id | Host       | Port | Master_id |
</span><span class='line'>+-----------+------------+------+-----------+
</span><span class='line'>|         2 | 10.10.8.45 | 3306 |         1 |
</span><span class='line'>+-----------+------------+------+-----------+
</span><span class='line'>1 row in <span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>&gt;sudo pt-table-checksum --recursion-method<span class="o">=</span>processlist
</span><span class='line'>Password:
</span><span class='line'>Cannot connect to <span class="nv">h</span><span class="o">=</span>10.10.8.45
</span><span class='line'>Diffs cannot be detected because no slaves were found.  Please <span class="nb">read </span>the --recursion-method documentation <span class="k">for </span>information.
</span></code></pre></td></tr></table></div></figure>


<p>问题依旧,修改shell</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>yinjia@hm15hadoop01 percona-toolkit-2.2.6<span class="o">]</span>&gt;pt-table-checksum --recursion-method<span class="o">=</span>hosts --no-check-binlog-format --nocheck-replication-filters --replicate<span class="o">=</span>monitor1_db.checksums --databases<span class="o">=</span>monitor1_db --tables<span class="o">=</span>httplog_status <span class="nv">h</span><span class="o">=</span>10.10.8.45,u<span class="o">=</span>madcore,p<span class="o">=</span>madcore,P<span class="o">=</span>3306
</span><span class='line'>            TS ERRORS  DIFFS     ROWS  CHUNKS SKIPPED    TIME TABLE
</span><span class='line'>06-30T13:33:50      0      1     5415       4       0   0.377 monitor1_db.httplog_status
</span></code></pre></td></tr></table></div></figure>


<p>看到DIFFS1，即为有1行差异</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>yinjia@hm15hadoop02 ~/software<span class="o">]</span>&gt;pt-table-checksum --recursion-method<span class="o">=</span>hosts --no-check-binlog-format --nocheck-replication-filters --replicate<span class="o">=</span>monitor1_db.checksums --databases<span class="o">=</span>monitor1_db --tables<span class="o">=</span>httplog_status <span class="nv">h</span><span class="o">=</span>10.10.8.44,u<span class="o">=</span>madcore,p<span class="o">=</span>madcore,P<span class="o">=</span>3306
</span><span class='line'>            TS ERRORS  DIFFS     ROWS  CHUNKS SKIPPED    TIME TABLE
</span><span class='line'>06-30T13:34:58      0      1     5395       4       0   0.371 monitor1_db.httplog_status
</span></code></pre></td></tr></table></div></figure>


<p>可以看到现在DIFF是1，证明有差异。所以要同步，怎么同步，使用pt-table-sync进行修复</p>

<h3>修复同步</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pt-table-sync --replicate<span class="o">=</span>monitor1_db.checksums <span class="nv">h</span><span class="o">=</span>10.10.8.44,u<span class="o">=</span>madcore,p<span class="o">=</span>madcore <span class="nv">h</span><span class="o">=</span>10.10.8.45,u<span class="o">=</span>madcore,p<span class="o">=</span>madcore --print --execute
</span></code></pre></td></tr></table></div></figure>


<p>分别是主的IP，从的IP。针对两边分别修复，最后再看一下pt-table-checksum 发现DIFF为0证明数据同步成功。</p>

<h3>注意事项</h3>

<p>同步修复后，记录可能发生乱序，比较好的做法是加timestamp字段，把写入的时间戳记载下来，然后select的时候采用ORDER BY进行排序，这样就不会乱序了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[mysql主主配置]]></title>
    <link href="http://evoupsight.com/blog/2014/07/10/mysql-double-master/"/>
    <updated>2014-07-10T16:20:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/07/10/mysql-double-master</id>
    <content type="html"><![CDATA[<p>由于在项目中使用采用mysql的双master来实现关系型数据库的HA，以下配置的步骤记录一遍。</p>

<!--more-->


<h3>作业环境：</h3>

<p>serverA:  IP:192.168.216.210  OS:CentOs6.4 64bit  DB:MySQL5.5.37</p>

<p>serverB:  IP:192.168.216.211  OS:CentOs6.4 64bit  DB:MySQL5.5.37</p>

<h3>Step1:同步授权</h3>

<p>ServerA:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>GRANT REPLICATION SLAVE,FILE ON *.* TO repuser@<span class="s1">&#39;192.168.216.211&#39;</span> IDENTIFIED BY <span class="s1">&#39;reppass&#39;</span>;
</span><span class='line'>flush privileges;
</span><span class='line'><span class="nv">$ </span>sudo service mysql-server restart
</span></code></pre></td></tr></table></div></figure>


<p>ServerB:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>GRANT REPLICATION SLAVE,FILE ON *.* TO repuser@<span class="s1">&#39;192.168.216.210&#39;</span> IDENTIFIED BY <span class="s1">&#39;reppass&#39;</span>;
</span><span class='line'>flush privileges;
</span><span class='line'><span class="nv">$ </span>sudo service mysql-server restart
</span></code></pre></td></tr></table></div></figure>


<h3>Step2:配置参数</h3>

<p>先找一下my.cnf的位置</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>mysql --verbose --help | grep -A 1 <span class="s1">&#39;Default options&#39;</span>
</span><span class='line'>/etc/my.cnf /etc/mysql/my.cnf /usr/local/etc/my.cnf /usr/local/etc/mysql/my.cnf ~/.my.cnf
</span><span class='line'><span class="nv">$ </span>ls /etc/my.cnf /etc/mysql/my.cnf /usr/local/etc/my.cnf /usr/local/etc/mysql/my.cnf ~/.my.cnf
</span><span class='line'>ls: /etc/my.cnf: No such file or directory
</span><span class='line'>ls: /etc/mysql/my.cnf: No such file or directory
</span><span class='line'>ls: /home/evoup/.my.cnf: No such file or directory
</span><span class='line'>ls: /usr/local/etc/my.cnf: No such file or directory
</span><span class='line'>ls: /usr/local/etc/mysql/my.cnf: No such file or directory
</span><span class='line'><span class="nv">$ </span>locate my-medium.cnf
</span><span class='line'>/usr/local/share/mysql/my-medium.cnf
</span><span class='line'><span class="nv">$ </span>sudo cp /usr/local/share/mysql/my-medium.cnf /etc/my.cnf
</span></code></pre></td></tr></table></div></figure>


<p>开启二进制日志
接下来需要在ServerA的/etc/my.cnf中添加配置</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">user</span><span class="o">=</span>mysql
</span><span class='line'>binlog-do-db<span class="o">=</span>monitor1_db
</span><span class='line'>binlog-ignore-db<span class="o">=</span>mysql
</span><span class='line'>replicate-do-db<span class="o">=</span>monitor1_db
</span><span class='line'>replicate-ignore-db<span class="o">=</span>mysql
</span><span class='line'>log-slave-update
</span><span class='line'>slave-skip-errors<span class="o">=</span>all
</span><span class='line'>skip-name-resolve
</span><span class='line'><span class="nv">sync_binlog</span><span class="o">=</span>1
</span><span class='line'><span class="nv">auto_increment_increment</span><span class="o">=</span>2
</span><span class='line'><span class="nv">auto_increment_offset</span><span class="o">=</span>1
</span></code></pre></td></tr></table></div></figure>


<p>而在ServerB的/etc/my.cnf中</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">user</span><span class="o">=</span>mysql
</span><span class='line'>binlog-do-db<span class="o">=</span>monitor1_db
</span><span class='line'>binlog-ignore-db<span class="o">=</span>mysql
</span><span class='line'>replicate-do-db<span class="o">=</span>monitor1_db
</span><span class='line'>replicate-ignore-db<span class="o">=</span>mysql
</span><span class='line'>log-slave-update
</span><span class='line'>slave-skip-errors<span class="o">=</span>all
</span><span class='line'>skip-name-resolve
</span><span class='line'><span class="nv">sync_binlog</span><span class="o">=</span>1
</span><span class='line'><span class="nv">auto_increment_increment</span><span class="o">=</span>2
</span><span class='line'><span class="nv">auto_increment_offset</span><span class="o">=</span>2
</span></code></pre></td></tr></table></div></figure>


<p>几点说明：
1) binlog-do-db和replicate-do-db是指出要同步的数据库，一般指定了数据库再其下创建的表就都能进行主主同步。<br>
2) auto_increment_offset一定要指定为1个奇数，1个偶数，为什么，估计是同步的机制，反正这官方的主主解决方案我感觉很奇葩,必须这么设置。<br>
3）同步的数据库要有上面指出的帐号（repuser）操作的权限。</p>

<h3>Step3:关联Master和Master</h3>

<p>首先ServerA和ServerB要锁表，还有关闭slave同步</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mysql&gt; flush tables with <span class="nb">read </span>lock;
</span><span class='line'>mysql&gt; stop slave;
</span></code></pre></td></tr></table></div></figure>


<p>然后先查看ServerB的master状况</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mysql&gt;show master status;
</span><span class='line'>+------------------+----------+--------------+------------------+
</span><span class='line'>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
</span><span class='line'>+------------------+----------+--------------+------------------+
</span><span class='line'>| mysql-bin.000019 |      107 | monitor1_db  | mysql            |
</span><span class='line'>+------------------+----------+--------------+------------------+
</span></code></pre></td></tr></table></div></figure>


<p>在ServerA绑定好到ServerB的同步关系</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mysql&gt; change master to <span class="nv">master_host</span><span class="o">=</span><span class="s1">&#39;192.168.216.211&#39;</span>,master_password<span class="o">=</span><span class="s1">&#39;madcore&#39;</span>,master_user<span class="o">=</span><span class="s1">&#39;madcore&#39;</span>,master_log_file<span class="o">=</span><span class="s1">&#39;mysql-bin.000019&#39;</span>,master_log_pos<span class="o">=</span>107;
</span></code></pre></td></tr></table></div></figure>


<p>同样的，再查看ServerA的master状况</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mysql&gt; show master status;
</span><span class='line'>+------------------+----------+--------------+------------------+
</span><span class='line'>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
</span><span class='line'>+------------------+----------+--------------+------------------+
</span><span class='line'>| mysql-bin.000018 |      23  | monitor1_db  | mysql            |
</span><span class='line'>+------------------+----------+--------------+------------------+
</span></code></pre></td></tr></table></div></figure>


<p>再ServerB绑定好到ServerA的同步关系</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mysql&gt; change master to <span class="nv">master_host</span><span class="o">=</span><span class="s1">&#39;192.168.216.210&#39;</span>,master_password<span class="o">=</span><span class="s1">&#39;madcore&#39;</span>,master_user<span class="o">=</span><span class="s1">&#39;madcore&#39;</span>,master_log_file<span class="o">=</span><span class="s1">&#39;mysql-bin.000018&#39;</span>,master_log_pos<span class="o">=</span>23;
</span></code></pre></td></tr></table></div></figure>


<p>在ServerA和ServerB打开slave和解锁表</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mysql&gt; slave start;
</span><span class='line'>mysql&gt; unlock tables;
</span></code></pre></td></tr></table></div></figure>


<p>然后查看slave的同步状态
···
show slave status\G;
···
观察几个指标
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
Seconds_Behind_Master:0</p>

<p>再看一下进程描述</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mysql&gt; show processlist;
</span></code></pre></td></tr></table></div></figure>


<p>一般上面几个指标是YES和0的话，这个不看都可以。</p>

<h3>补充：</h3>

<p>在同步设置中遇到的问题，可以通过查看mysql日志的方法来解决。
查看mysql日志的位置的命令。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mysql&gt; show variables like <span class="s1">&#39;general_log_file&#39;</span>;
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[hadoop2.0cdh4.6.0完全分布式安装]]></title>
    <link href="http://evoupsight.com/blog/2014/07/10/hadoop2-dot-0cdh4-dot-6-0-fullly-distrbute/"/>
    <updated>2014-07-10T15:57:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/07/10/hadoop2-dot-0cdh4-dot-6-0-fullly-distrbute</id>
    <content type="html"><![CDATA[<p>hadoop2.0 cdh4安装（完全分布式）</p>

<!-- more -->


<p>vmware版本8.0.4 build-744019</p>

<p>首先规划3台虚拟机</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> ,'''''''''''''''''''''':'''''''''''''''''':''''''''''''''''''''''''''''''''''''''''''''|
</span><span class='line'> |        usage         |        IP        |                  Hostname                  |
</span><span class='line'> |                      |                  |                                            |
</span><span class='line'> |''''''''''''''''''''''|''''''''''''''''''|''''''''''''''''''''''''''''''''''''''''''''|
</span><span class='line'> | namenode1,datanode1  | 192.168.216.183  |    mdn3namenode1.net,mdn3datanode1.net     |
</span><span class='line'> |                      |                  |                                            |
</span><span class='line'> |''''''''''''''''''''''|''''''''''''''''''|''''''''''''''''''''''''''''''''''''''''''''|
</span><span class='line'> | namenode2,datanode2  | 192.168.216.184  |    mdn3namenode2.net,mdn3datanode2.net     |
</span><span class='line'> |                      |                  |                                            |
</span><span class='line'> |''''''''''''''''''''''|''''''''''''''''''|''''''''''''''''''''''''''''''''''''''''''''|
</span><span class='line'> | datanode2,nfs server | 192.168.216.185  |    mdn3datanode3.net,mdn3nfsserver.net     |
</span><span class='line'> |                      |                  |                                            |
</span><span class='line'>  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''</span></code></pre></td></tr></table></div></figure>


<h3>准备工作</h3>

<p>先安装JDK1.6 linux:先把已经安装的openjdk卸载,安装sun jdk1.6,去oracle下载 （j2se就够了）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rpm -qa | grep jdk
</span><span class='line'>java-1.6.0-openjdk-1.6.0.0-1.28.1.10.9.el5_8
</span><span class='line'><span class="nv">$ </span>sudo rpm -e java-1.6.0-openjdk-1.6.0.0-1.28.1.10.9.el5_8
</span><span class='line'><span class="nv">$ </span>sudo chmod +x jdk-6u45-linux-x64-rpm.bin
</span><span class='line'><span class="nv">$ </span>sudo ./jdk-6u45-linux-x64-rpm.bin
</span></code></pre></td></tr></table></div></figure>


<p>hadoop所有操作都是用hadoop帐号，下面添加（如果已经创建了帐号无须添加）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>groupadd hadoop
</span><span class='line'><span class="nv">$ </span>useradd -r -g hadoop -d /home/hadoop -m -s /bin/bash hadoop
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>mkdir -p /home/hadoop
</span><span class='line'><span class="nv">$ </span>chgrp -R hadoop /home/hadoop
</span><span class='line'><span class="nv">$ </span>chown -R hadoop /home/hadoop
</span></code></pre></td></tr></table></div></figure>


<p>环境变量(在centos里不管编辑~/.profile还是~/.bash_profile都不能加载环境变量，正确的应该是在~/.bashrc中，而如果是root用户，应该可以直接在/etc/profile中编辑)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vi ~/.bashrc
</span><span class='line'><span class="nb">export </span><span class="nv">HADOOP_HOME</span><span class="o">=</span><span class="s2">&quot;/usr/local/hadoop&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span><span class="s2">&quot;/usr/java/jdk1.6.0_45&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$JAVA_HOME</span>/bin
</span><span class='line'><span class="nb">export </span><span class="nv">CLASSPATH</span><span class="o">=</span>.:<span class="nv">$JAVA_HOME</span>/lib/dt.jar:<span class="nv">$JAVA_HOME</span>/lib/tools.jar
</span></code></pre></td></tr></table></div></figure>


<p>切换到hadoop帐号，进行免密码的ssh登录设置</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>su hadoop
</span><span class='line'><span class="nv">$ </span>ssh-keygen -t dsa -P <span class="s1">&#39;&#39;</span> -f ~/.ssh/id_dsa
</span><span class='line'><span class="nv">$ </span>cat ~/.ssh/id_dsa.pub &gt;&gt; ~/.ssh/authorized_keys
</span><span class='line'><span class="nv">$ </span>chmod 600 ~/.ssh/authorized_keys
</span></code></pre></td></tr></table></div></figure>


<p>给出我的hadoop/hbase版本</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Name        : hadoop-hdfs-namenode
</span><span class='line'>Arch        : x86_64
</span><span class='line'>Version     : 2.0.0+1554
</span><span class='line'>Release     : 1.cdh4.6.0.p0.16.el6
</span><span class='line'>
</span><span class='line'>Name        : hbase-master
</span><span class='line'>Arch        : x86_64
</span><span class='line'>Version     : 0.94.15+86
</span><span class='line'>Release     : 1.cdh4.6.0.p0.14.el6
</span></code></pre></td></tr></table></div></figure>


<p>然后是cdh的软件下载url
<a href="http://archive.cloudera.com/cdh4">http://archive.cloudera.com/cdh4</a>
这个路径下有很多的软件。</p>

<p>下载cdh4.6的几个包安装</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /home/software/
</span><span class='line'><span class="nv">$ </span>wget http://archive.cloudera.com/cdh4/cdh/4/hadoop-2.0.0-cdh4.6.0.tar.gz
</span><span class='line'><span class="nv">$ </span>sudo mkdir /usr/local/hadoop/
</span><span class='line'><span class="nv">$ </span>tar xzf hadoop-2.0.0-cdh4.6.0.tar.gz
</span><span class='line'><span class="nv">$ </span>sudo mv hadoop-2.0.0-cdh4.6.0 /usr/local/
</span><span class='line'><span class="nv">$ </span>sudo mv /usr/local/hadoop-2.0.0-cdh4.6.0 /usr/local/hadoop
</span><span class='line'><span class="nv">$ </span>sudo chown -R hadoop:hadoop /usr/local/hadoop
</span></code></pre></td></tr></table></div></figure>


<p>创建存储临时文件temp、data和name节点数据的目录</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo mkdir /usr/local/hadoop/temp/ /usr/local/hadoop/data/ /usr/local/hadoop/name/
</span><span class='line'><span class="nv">$ </span>sudo chown -R hadoop:hadoop /usr/local/hadoop
</span></code></pre></td></tr></table></div></figure>


<p>好了，准备工作终了</p>

<p>开始配置
配置/usr/local/hadoop/etc/hadoop/core-site.xml</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>fs.defaultFS<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>hdfs://mdn3namenode1.net:9000<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- master域名或者master的ip --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>io.file.buffer.size<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>131072<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>hadoop.tmp.dir<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>file:/usr/local/hadoop/temp<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>                <span class="nt">&lt;description&gt;</span>Abase for other temporary directories.<span class="nt">&lt;/description&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>hadoop.proxyuser.hduser.hosts<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>*<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>hadoop.proxyuser.hduser.groups<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>*<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>配置/usr/local/hadoop/etc/hadoop/hdfs-site.xml</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>dfs.namenode.secondary.http-address<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>mdn3namenode1.net:9001<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- master域名或者master的ip --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>dfs.namenode.name.dir<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;value&gt;</span>file:/usr/local/hadoop/dfs/name<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>dfs.datanode.data.dir<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>file:/usr/local/hadoop/dfs/data<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>dfs.replication<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>3<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>dfs.webhdfs.enabled<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>true<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>配置/usr/local/hadoop/etc/hadoop/madpred-site.xml</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>cp mapred-site.xml.template mapred-site.xml
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>mapreduce.framework.name<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>yarn<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>mapreduce.jobhistory.address<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>mdn3namenode1.net:10020<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- master域名或者master的ip --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>mapreduce.jobhistory.webapp.address<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>mdn3namenode1.net:19888<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- master域名或者master的ip --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>配置/usr/local/hadoop/etc/hadoop/yarn-site.xml</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>yarn.nodemanager.aux-services<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>mapreduce.shuffle<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>yarn.nodemanager.aux-services.mapreduce.shuffle.class<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>org.apache.hadoop.mapred.ShuffleHandler<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>yarn.resourcemanager.address<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>mdn3namenode1.net:8032<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- master域名或者master的ip --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>yarn.resourcemanager.scheduler.address<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>mdn3namenode1.net:8030<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- master域名或者master的ip --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>yarn.resourcemanager.resource-tracker.address<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>mdn3namenode1.net:8031<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- master域名或者master的ip --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>yarn.resourcemanager.admin.address<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>mdn3namenode1.net:8033<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- master域名或者master的ip --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;property&gt;</span>
</span><span class='line'>                <span class="nt">&lt;name&gt;</span>yarn.resourcemanager.webapp.address<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>                <span class="nt">&lt;value&gt;</span>mdn3namenode1.net:8088<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- master域名或者master的ip --&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/property&gt;</span>
</span><span class='line'><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>编辑slave的名字
直接讲slave的域名或者slave的ip按照一行一个的规则写进去</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>mdn3datanode2.net
</span><span class='line'>mdn3datanode3.net
</span></code></pre></td></tr></table></div></figure>


<p>复制到各台机器上</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /usr/local/
</span><span class='line'><span class="nv">$ </span>sudo scp -dr hadoop@192.168.216.183:/usr/local/hadoop .
</span><span class='line'><span class="nv">$ </span>sudo chown -R hadoop:hadoop hadoop/
</span></code></pre></td></tr></table></div></figure>


<p>格式化hdfs
在namenode上执行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/usr/local/hadoop/bin/hadoop namenode -format
</span></code></pre></td></tr></table></div></figure>


<h3>hbase的安装配置</h3>

<p>hbase依赖zookeeper，需要先去下载</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /home/software/
</span><span class='line'><span class="nv">$ </span>wget http://archive.cloudera.com/cdh4/cdh/4/zookeeper-3.4.5-cdh4.6.0.tar.gz
</span><span class='line'><span class="nv">$ </span>tar xzf zookeeper-3.4.5-cdh4.6.0.tar.gz
</span><span class='line'><span class="nv">$ </span>sudo mv zookeeper-3.4.5-cdh4.6.0 /usr/local/
</span><span class='line'><span class="nv">$ </span>sudo mv /usr/local/zookeeper-3.4.5-cdh4.6.0 /usr/local/zookeeper
</span><span class='line'><span class="nv">$ </span>sudo chown -R hadoop:hadoop /usr/local/zookeeper
</span><span class='line'><span class="nv">$ </span>sudo cp /usr/local/zookeeper/conf/zoo_sample.cfg /usr/local/zookeeper/conf/zoo.cfg
</span></code></pre></td></tr></table></div></figure>


<p>zookeeper准备完毕，可以继续安装hbase</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> /home/software/
</span><span class='line'><span class="nv">$ </span>wget http://archive.cloudera.com/cdh4/cdh/4/hbase-0.94.15-cdh4.6.0.tar.gz
</span><span class='line'><span class="nv">$ </span>sudo mkdir /usr/local/hbase/
</span><span class='line'><span class="nv">$ </span>tar xzf hbase-0.94.15-cdh4.6.0.tar.gz
</span><span class='line'><span class="nv">$ </span>sudo mv hbase-0.94.15-cdh4.6.0 /usr/local/
</span><span class='line'><span class="nv">$ </span>sudo mv /usr/local/hbase-0.94.15-cdh4.6.0 /usr/local/hbase
</span><span class='line'><span class="nv">$ </span>sudo chown -R hadoop:hadoop /usr/local/hbase
</span></code></pre></td></tr></table></div></figure>


<p>若干配置步骤
配置hbase-site.xml</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;name&gt;</span>hbase.rootdir<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;value&gt;</span>hdfs://mdn3namenode1.net:9000/hbase<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;name&gt;</span>hbase.cluster.distributed<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;value&gt;</span>true<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;name&gt;</span>hbase.master<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;value&gt;</span>mdn3datanode1.net:60000<span class="nt">&lt;/value&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/property&gt;</span>
</span><span class='line'>    <span class="nt">&lt;property&gt;</span>
</span><span class='line'>        <span class="nt">&lt;name&gt;</span>hbase.zookeeper.quorum<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>        <span class="nt">&lt;value&gt;</span>mdn3datanode1.net<span class="nt">&lt;/value&gt;</span>    <span class="c">&lt;!-- 这里配置若干个zookeeper的服务器地址，需要是奇数个 --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/property&gt;</span>
</span><span class='line'><span class="nt">&lt;/configuration&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>配置hbase-env.sh</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>export HBASE_MANAGES_ZK=false
</span></code></pre></td></tr></table></div></figure>


<p>不要hbase托管zookeeper</p>

<p>配置regionservers</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>mdn3datanode2.net
</span><span class='line'>mdn3datanode3.net
</span></code></pre></td></tr></table></div></figure>


<p>启动hbase</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/usr/local/hbase/bin/start-hbase.sh
</span><span class='line'>/usr/local/hbase/bin/hbase-daemons.sh start thrift
</span></code></pre></td></tr></table></div></figure>


<p>hbase启动完成.</p>

<h3>配置hbase可能碰到几个问题的说明：</h3>

<p>1) 报错
<code>ERROR client.HConnectionManager$HConnectionImplementation: Check the value configured in 'zookeeper.znode.parent'</code></p>

<p>是需要把/etc/hosts中的127.0.0.1注释掉，否则zookeeper还会出现
最后的hosts我这里是这样</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="o">[</span>hadoop@localhost conf<span class="o">]</span><span class="nv">$ </span>more /etc/hosts
</span><span class='line'><span class="c">#127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span>
</span><span class='line'>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
</span><span class='line'>192.168.216.183 mdn3namenode1.net mdn3datanode1.net
</span><span class='line'>192.168.216.184 mdn3namenode2.net mdn3datanode2.net
</span><span class='line'>192.168.216.185 mdn3datanode3.net mdn3nfsserver.net
</span></code></pre></td></tr></table></div></figure>


<p>2) 在运行/usr/local/hbase/bin/hbase shell的时候出现了
<code>WARN conf.Configuration: hadoop.native.lib is deprecated. Instead, use io.native.lib.available</code></p>

<p>3) <code>java.net.ConnectException: Connection refused</code>
这是要求hadoop中的slaves配置和hbase的regionservers要一致。</p>

<h3>hive的安装</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">cd</span> /home/software
</span><span class='line'>wget http://archive.cloudera.com/cdh4/cdh/4/hive-0.10.0-cdh4.6.0.tar.gz
</span><span class='line'>tar xzf hive-0.10.0-cdh4.6.0.tar.gz
</span><span class='line'>sudo mv hive-0.10.0-cdh4.6.0 /usr/local/
</span><span class='line'>sudo mv /usr/local/hive-0.10.0-cdh4.6.0 /usr/local/hive
</span><span class='line'>chown -R hadoop:hadoop /usr/local/hive
</span></code></pre></td></tr></table></div></figure>


<h3>hive的配置</h3>

<p>在~/.bashrc中加入</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">HIVE_HOME</span><span class="o">=</span>/usr/local/hive
</span><span class='line'><span class="nb">export </span><span class="nv">HIVE_CONF_DIR</span><span class="o">=</span><span class="nv">$HIVE_HOME</span>/conf
</span><span class='line'><span class="nb">export </span><span class="nv">HIVE_LIB</span><span class="o">=</span><span class="nv">$HIVE_HOME</span>/lib
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$JAVA_HOME</span>/bin:<span class="nv">$ZOOKEEPER_HOME</span>:<span class="nv">$HIVE_HOME</span>
</span></code></pre></td></tr></table></div></figure>


<p>在conf/hive-site.xml中</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;configuration&gt;
</span><span class='line'>&lt;property&gt;
</span><span class='line'>  &lt;name&gt;hive.metastore.local&lt;/name&gt;
</span><span class='line'>  &lt;value&gt;true&lt;/value&gt;
</span><span class='line'>&lt;/property&gt;
</span><span class='line'>
</span><span class='line'>&lt;property&gt;
</span><span class='line'>  &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;
</span><span class='line'>  &lt;value&gt;jdbc:mysql://localhost:3306/hive&lt;/value&gt;
</span><span class='line'>&lt;/property&gt;
</span><span class='line'>
</span><span class='line'>&lt;property&gt;
</span><span class='line'>  &lt;name&gt;javax.jdo.option.ConnectionDriverName&lt;/name&gt;
</span><span class='line'>  &lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;
</span><span class='line'>&lt;/property&gt;
</span><span class='line'>
</span><span class='line'>&lt;property&gt;
</span><span class='line'>  &lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;
</span><span class='line'>  &lt;value&gt;hive&lt;/value&gt;
</span><span class='line'>&lt;/property&gt;
</span><span class='line'>
</span><span class='line'>&lt;property&gt;
</span><span class='line'>  &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;
</span><span class='line'>  &lt;value&gt;hive&lt;/value&gt;
</span><span class='line'>&lt;/property&gt;
</span><span class='line'>&lt;property&gt;
</span><span class='line'>  &lt;name&gt;datanucleus.fixedDatastore&lt;/name&gt;
</span><span class='line'>  &lt;value&gt;false&lt;/value&gt;
</span><span class='line'>&lt;/property&gt;
</span><span class='line'>
</span><span class='line'>&lt;/configuration&gt;
</span></code></pre></td></tr></table></div></figure>


<p>这里要安装mysql作为元数据服务器，参考这篇 <a href="http://evoupsight.com/blog/2014/02/17/hadoop0-dot-20-dot-2-plus-hive0-dot-7/">http://evoupsight.com/blog/2014/02/17/hadoop0-dot-20-dot-2-plus-hive0-dot-7/</a></p>

<p>然后/bin/hive后，成功进入shell</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&gt; create table <span class="nb">test</span> <span class="o">(</span>key string<span class="o">)</span>;
</span></code></pre></td></tr></table></div></figure>


<p>如果遇到下面的报错
<code>FAILED: Error in metadata: java.lang.RuntimeException: Unable to instantiate org.apache.hadoop.hive.metastore.HiveMetaStoreClient</code></p>

<p><code>FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask</code>
建表错误
开始以为hive没有访问mysql的权限,以root用户登录mysql然后赋予hive用户权限：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>grant all privileges on *.* to hive@localhost identified by <span class="s1">&#39;hive&#39;</span>;
</span><span class='line'>grant all privileges on *.* to hive@192.168.216.183 identified by <span class="s1">&#39;hive&#39;</span>;
</span></code></pre></td></tr></table></div></figure>


<p>发现问题依旧</p>

<p>其实是要在hive-site.xml中把</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;property&gt;
</span><span class='line'>  &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;
</span><span class='line'>  &lt;value&gt;jdbc:mysql://localhost:3306/hive&lt;/value&gt;
</span><span class='line'>&lt;/property&gt;
</span></code></pre></td></tr></table></div></figure>


<p>改成</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;property&gt;
</span><span class='line'>  &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;
</span><span class='line'>  &lt;value&gt;jdbc:mysql://192.168.216.183:3306/hive&lt;/value&gt;
</span><span class='line'>&lt;/property&gt;
</span></code></pre></td></tr></table></div></figure>


<p>问题依旧，打开hive的调试模式</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bin/hive -hiveconf hive.root.logger<span class="o">=</span>DEBUG,console
</span></code></pre></td></tr></table></div></figure>


<p><code>14/05/08 17:35:53 WARN conf.HiveConf: DEPRECATED: Configuration property hive.metastore.local no longer has any effect.</code>
<code>Make sure to provide a valid value for hive.metastore.uris if you are connecting to a remote metastore</code></p>

<p>在配置文件里删除hive.metastore.local属性。</p>

<p>最后查得原因是没有安装mysql驱动，只要把mysql-connector-java-5.1.22-bin.jar放到lib下就可以了</p>

<p>然后</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>hive&gt; create table <span class="nb">test</span> <span class="o">(</span>key string<span class="o">)</span>;
</span><span class='line'>OK
</span><span class='line'>Time taken: 42.259 seconds
</span><span class='line'>
</span><span class='line'>hive&gt; show tables;
</span><span class='line'>OK
</span><span class='line'><span class="nb">test</span>
</span><span class='line'>Time taken: 0.279 seconds
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[freebsd和linux上安装中文字体]]></title>
    <link href="http://evoupsight.com/blog/2014/06/13/simplely-install-chinese-fonts-on-freebsd-and-linux/"/>
    <updated>2014-06-13T17:45:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/06/13/simplely-install-chinese-fonts-on-freebsd-and-linux</id>
    <content type="html"><![CDATA[<h3>使用中文字体及其安装</h3>

<p>首先说明，因为需要在不同的平台下让rrdtool显示的图片看起来舒服点，考虑安装中文字体。这里搜罗下方法。（这种方式仅仅是为了程序工作正常，需要使自己的KDE或者GNOME系统中文显示正常可以不用看本文了。）</p>

<!-- more -->


<h3>freebsd下</h3>

<p>直接把字体文件放到/usr/local/share/fonts下，然后刷新字体缓存</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo cp ukai.ttf /usr/local/share/fonts/
</span><span class='line'>sudo <span class="nb">fc</span>-cache -f -v
</span></code></pre></td></tr></table></div></figure>


<h3>centos下</h3>

<p>把字体放到/usr/share/fonts/msfonts下，然后执行几个命令</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo mkdir /use/share/fonts/msfonts
</span><span class='line'>sudo cp ukai.ttf /usr/share/fonts/msfonts/
</span><span class='line'><span class="nb">cd</span> /usr/share/fonts/msfonts/
</span><span class='line'>sudo mkfontscale
</span><span class='line'>sudo mkfontdir
</span><span class='line'>sudo <span class="nb">fc</span>-cache -fv
</span></code></pre></td></tr></table></div></figure>


<p>更EZ的方式有</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo yum  –y  install  fonts-chinese
</span></code></pre></td></tr></table></div></figure>


<p>于是就可以在rrdtool里指定字体为ukai.ttf了，是不是各种简单:)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[apache common configure依赖注意]]></title>
    <link href="http://evoupsight.com/blog/2014/06/13/apache-common-configure/"/>
    <updated>2014-06-13T15:35:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/06/13/apache-common-configure</id>
    <content type="html"><![CDATA[<p>基于maven使用apache的common-configuration的过程中，遇到一个依赖小问题，记录下</p>

<!-- more -->


<p>关于这个包commons-configuration-1.6.jar,注意一定要有三个包才能使用，见下pom片段</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;dependencies&gt;
</span><span class='line'>
</span><span class='line'>    &lt;dependency&gt;
</span><span class='line'>
</span><span class='line'>        &lt;groupId&gt;commons-configuration&lt;/groupId&gt;
</span><span class='line'>
</span><span class='line'>        &lt;artifactId&gt;commons-configuration&lt;/artifactId&gt;
</span><span class='line'>
</span><span class='line'>        &lt;version&gt;1.8&lt;/version&gt;
</span><span class='line'>
</span><span class='line'>    &lt;/dependency&gt;
</span><span class='line'>
</span><span class='line'>    &lt;dependency&gt;
</span><span class='line'>
</span><span class='line'>        &lt;groupId&gt;commons-beanutils&lt;/groupId&gt;
</span><span class='line'>
</span><span class='line'>        &lt;artifactId&gt;commons-beanutils&lt;/artifactId&gt;
</span><span class='line'>
</span><span class='line'>        &lt;version&gt;1.8.0&lt;/version&gt;
</span><span class='line'>
</span><span class='line'>    &lt;/dependency&gt;
</span><span class='line'>
</span><span class='line'>    &lt;dependency&gt;
</span><span class='line'>
</span><span class='line'>        &lt;groupId&gt;commons-jxpath&lt;/groupId&gt;
</span><span class='line'>
</span><span class='line'>        &lt;artifactId&gt;commons-jxpath&lt;/artifactId&gt;
</span><span class='line'>
</span><span class='line'>        &lt;version&gt;1.3&lt;/version&gt;
</span><span class='line'>
</span><span class='line'>    &lt;/dependency&gt;
</span><span class='line'>
</span><span class='line'>&lt;/dependencies&gt;</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[maven使用小计]]></title>
    <link href="http://evoupsight.com/blog/2014/06/12/maven-relative-note/"/>
    <updated>2014-06-12T14:41:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/06/12/maven-relative-note</id>
    <content type="html"><![CDATA[<h3>介绍</h3>

<p>maven是java的一个比较有名的项目构建工具，类似的工具还有ant、gradle等，采用vim+maven构建java项目需要了解maven的基本操作，以下是项目收集到的一些使用套路和细节注意点。</p>

<!-- more -->


<h3>安装(其实无需安装)</h3>

<p>由于可能地址被强，在国内maven下载依赖比较慢，最好在编辑/etc/hosts，并在其中加上依赖服务器的IP地址，如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>199.27.77.129 repo.maven.apache.org</span></code></pre></td></tr></table></div></figure>


<p>下载和解压安装包</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mkdir /home/software/
</span><span class='line'>fetch http://down1.chinaunix.net/distfiles/apache-maven-3.0.4-bin.tar.gz
</span><span class='line'>tar xzf apache-maven-3.0.4-bin.tar.gz</span></code></pre></td></tr></table></div></figure>


<p>然后在~/.cshrc中指定(我这里是使用tcsh作为shell环境)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>setenv M2_HOME "/usr/home/software/apache-maven-3.0.4"
</span><span class='line'>setenv MAVEN_OPTS "-Xms128m -Xmx512m"
</span><span class='line'>set path=( $path $M2_HOME/bin )</span></code></pre></td></tr></table></div></figure>


<p>接着</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>source ~/.cshrc</span></code></pre></td></tr></table></div></figure>


<p>就可以使用mvn命令了</p>

<h3>基本测试构建</h3>

<p>生成测试</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mvn clean test</span></code></pre></td></tr></table></div></figure>


<p>以上命令能直接生成class文件，并且支持自动测试（需要引入Junt并编写测试代码）</p>

<p>生成测试和打包</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mvn clean package</span></code></pre></td></tr></table></div></figure>


<p>以上命令能直接生成最终的jar包文件，同时实现mvn clean test的所有功能</p>

<h3>mvn常用命令</h3>

<p>编译</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mvn compile</span></code></pre></td></tr></table></div></figure>


<p>清理（删除所有test，package，compile等生成的文件）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mvn clean</span></code></pre></td></tr></table></div></figure>


<p>mvn获取所有依赖并且打包</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mvn dependency:copy-dependencies -DoutputDirectory=lib package</span></code></pre></td></tr></table></div></figure>


<p>maven不经过测试直接打包</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mvn -DskipTests clean package</span></code></pre></td></tr></table></div></figure>


<h3>mvn找依赖的方法</h3>

<p>以下两个网站任意一个直接在搜索框中给出java根类即可，第一个网站还可以在线查看jar包里的方法，可以当在线手册查阅：</p>

<p><a href="https://repository.sonatype.org/">https://repository.sonatype.org/</a></p>

<p><a href="http://mvnrepository.com/">http://mvnrepository.com/</a></p>

<p>参考：
《Maven实战》</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[git分支学习]]></title>
    <link href="http://evoupsight.com/blog/2014/05/10/git-branch-learning/"/>
    <updated>2014-05-10T14:17:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/05/10/git-branch-learning</id>
    <content type="html"><![CDATA[<p>主要学习的内容：git默认分支是什么，如何创建分支，如何查看所有分支，如何查看当前分支，如何提交分支，如何切换到分支,以下简单给出答案：</p>

<!-- more -->


<p>git的默认分支是master</p>

<p>创建分支</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git branch branchname </span></code></pre></td></tr></table></div></figure>


<p>显示所有分支</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git show-branch</span></code></pre></td></tr></table></div></figure>


<p>查看当前分支</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git status</span></code></pre></td></tr></table></div></figure>


<p>提交分支</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git push origin branchname</span></code></pre></td></tr></table></div></figure>


<p>切换到名字为branchname的分支</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git checkout branchname</span></code></pre></td></tr></table></div></figure>


<p>创建一个分支，然后把这个分支同步到远程仓库</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>git branch branchname
</span><span class='line'>git checkout branchname
</span><span class='line'>git push origin branchname
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[hive查询报错There are 0 datanode(s) running and no node]]></title>
    <link href="http://evoupsight.com/blog/2014/04/30/hive-there-are-0-datanode-s-running-and-no-node/"/>
    <updated>2014-04-30T17:38:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/04/30/hive-there-are-0-datanode-s-running-and-no-node</id>
    <content type="html"><![CDATA[<p>hive查询报错<code>c
ould only be replicated to 0 nodes instead of minReplication (=1).  There are 0 datanode(s) running and no node(s) are excluded in this operation</code></p>

<!-- more -->




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>hive&gt; select count(*) from httplog_2014_05_26_2017;
</span><span class='line'>Total MapReduce jobs = 1
</span><span class='line'>Launching Job 1 out of 1
</span><span class='line'>Number of reduce tasks determined at compile time: 1
</span><span class='line'>In order to change the average load for a reducer (in bytes):
</span><span class='line'>  set hive.exec.reducers.bytes.per.reducer=&lt;number&gt;
</span><span class='line'>In order to limit the maximum number of reducers:
</span><span class='line'>  set hive.exec.reducers.max=&lt;number&gt;
</span><span class='line'>In order to set a constant number of reducers:
</span><span class='line'>  set mapred.reduce.tasks=&lt;number&gt;
</span><span class='line'>org.apache.hadoop.ipc.RemoteException(java.io.IOException): File /tmp/hive-hadoop/hive_2014-07-15_10-27-16_252_580204120341469236-1/-mr-10003/7a56500c-c6e3-4f8c-a32b-053e9fe8eec2 c
</span><span class='line'>ould only be replicated to 0 nodes instead of minReplication (=1).  There are 0 datanode(s) running and no node(s) are excluded in this operation.
</span><span class='line'>        at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.chooseTarget(BlockManager.java:1340)
</span><span class='line'>        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.getAdditionalBlock(FSNamesystem.java:2296)
</span><span class='line'>        at org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.addBlock(NameNodeRpcServer.java:501)
</span><span class='line'>        at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolServerSideTranslatorPB.addBlock(ClientNamenodeProtocolServerSideTranslatorPB.java:299)
</span><span class='line'>        at org.apache.hadoop.hdfs.protocol.proto.ClientNamenodeProtocolProtos$ClientNamenodeProtocol$2.callBlockingMethod(ClientNamenodeProtocolProtos.java:44954)
</span><span class='line'>        at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:453)
</span><span class='line'>        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:1002)
</span><span class='line'>        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:1752)
</span><span class='line'>        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:1748)</span></code></pre></td></tr></table></div></figure>


<p>需要清理目录，其中hadoop为当前用户的名字</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> /tmp/hadoop
</span><span class='line'>rm -rf *
</span></code></pre></td></tr></table></div></figure>


<p>然后重启hadoop和hive，恢复正常，原因是hadoop的namespaceIDs有异常。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[golang使用syslog日志系统和安装使用第三方包log4go]]></title>
    <link href="http://evoupsight.com/blog/2014/04/22/golang-with-syslog-and-log4go/"/>
    <updated>2014-04-22T11:25:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/04/22/golang-with-syslog-and-log4go</id>
    <content type="html"><![CDATA[<h3>使用syslog</h3>

<p>首先介绍下golang的syslog的用法，因为这个其实也很好用，只不过比log4go缺点在于要用syslog那一套（如newsyslog）来手工设置syslog.conf来轮询日志。接下来是一个基本的用法，只有serverity的场景:</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="c1">// syslog init</span>
</span><span class='line'><span class="kd">func</span> <span class="nx">LogInit</span><span class="p">()</span> <span class="o">*</span><span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">Log</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syslog</span><span class="p">.</span><span class="nx">NewLogger</span><span class="p">(</span><span class="nx">syslog</span><span class="p">.</span><span class="nx">LOG_DEBUG</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nx">Lmicroseconds</span><span class="p">)</span> <span class="c1">//设置log facility为LOG_DEBUG</span>
</span><span class='line'>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">Log</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">//然后打印日志的时候可以调用对应的log level</span>
</span></code></pre></td></tr></table></div></figure>


<p>或者使用shell调用的方式，理论上效率会低一点:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="c1">/// using logger</span>
</span><span class='line'><span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nx">Command</span><span class="p">(</span><span class="s">&quot;logger&quot;</span><span class="p">,</span> <span class="s">&quot;-p&quot;</span><span class="p">,</span> <span class="s">&quot;local0.err&quot;</span><span class="p">,</span> <span class="s">&quot;-t&quot;</span><span class="p">,</span> <span class="s">&quot;bash&quot;</span><span class="p">,</span> <span class="s">&quot;hello bash&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nx">err</span> <span class="p">=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">Run</span><span class="p">()</span>
</span><span class='line'><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;error running cmd!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后是一个可以log serverity和log facility都可以用上的例子:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'><span class="kn">import</span><span class="p">(</span>
</span><span class='line'>    <span class="s">&quot;log/syslog&quot;</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="nx">testLogger</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">syslog</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">syslog</span><span class="p">.</span><span class="nx">LOG_WARNING</span><span class="p">|</span><span class="nx">syslog</span><span class="p">.</span><span class="nx">LOG_LOCAL0</span><span class="p">,</span> <span class="s">&quot;mytag&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">defer</span> <span class="nx">testLogger</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'><span class="k">if</span> <span class="nx">err</span><span class="o">!=</span><span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;New() failed: %v\n&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;logger ok&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">test</span><span class="p">.</span><span class="nx">Logger</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;test go syslog&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>log4go的安装</h3>

<p>言归正传讲安装，不要被log4go的README搞晕了</p>

<!-- more -->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="nx">Please</span> <span class="nx">see</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//log4go.googlecode.com/</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Installation</span><span class="p">:</span>
</span><span class='line'><span class="o">-</span> <span class="nx">Run</span> <span class="s">`goinstall log4go.googlecode.com/hg`</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Usage</span><span class="p">:</span>
</span><span class='line'><span class="o">-</span> <span class="nx">Add</span> <span class="nx">the</span> <span class="nx">following</span> <span class="kn">import</span><span class="p">:</span>
</span><span class='line'><span class="kn">import</span> <span class="nx">l4g</span> <span class="s">&quot;log4go.googlecode.com/hg&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Acknowledgements</span><span class="p">:</span>
</span><span class='line'><span class="o">-</span> <span class="nx">pomack</span>
</span><span class='line'>  <span class="nx">For</span> <span class="nx">providing</span> <span class="nx">awesome</span> <span class="nx">patches</span> <span class="nx">to</span> <span class="nx">bring</span> <span class="nx">log4go</span> <span class="nx">up</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">latest</span> <span class="nx">Go</span> <span class="nx">spec</span>
</span></code></pre></td></tr></table></div></figure>


<p>其实正确的安装方法如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>go get code.google.com/p/log4go
</span></code></pre></td></tr></table></div></figure>


<p>安装完成后默认路径位于</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>/usr/local/go/src/pkg/code.google.com/p/log4go
</span></code></pre></td></tr></table></div></figure>


<h3>使用log4go</h3>

<p>打开文档看怎么用，有2种方法：</p>

<h4>第一种</h4>

<p>在安装好log4go的机器上运行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>godoc -http<span class="o">=</span>:6060
</span></code></pre></td></tr></table></div></figure>


<p>然后用浏览器查看
<a href="http://host:6060/src/pkg/code.google.com/p/log4go/examples/">http://host:6060/src/pkg/code.google.com/p/log4go/examples/</a></p>

<h4>第二种</h4>

<p>直接查看该目录下的例子
/usr/local/go/src/pkg/code.google.com/p/log4go/examples</p>

<p>主要来看一个日志轮询的怎么做</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;bufio&quot;</span>
</span><span class='line'>  <span class="s">&quot;fmt&quot;</span>
</span><span class='line'>  <span class="s">&quot;io&quot;</span>
</span><span class='line'>  <span class="s">&quot;os&quot;</span>
</span><span class='line'>  <span class="s">&quot;time&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nx">l4g</span> <span class="s">&quot;code.google.com/p/log4go&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">const</span> <span class="p">(</span>
</span><span class='line'>  <span class="nx">filename</span> <span class="p">=</span> <span class="s">&quot;flw.log&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Get a new logger instance</span>
</span><span class='line'>  <span class="nx">log</span> <span class="o">:=</span> <span class="nx">l4g</span><span class="p">.</span><span class="nx">NewLogger</span><span class="p">()</span> <span class="c1">//实例化日志对象</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Create a default logger that is logging messages of FINE or higher</span>
</span><span class='line'>  <span class="nx">log</span><span class="p">.</span><span class="nx">AddFilter</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">,</span> <span class="nx">l4g</span><span class="p">.</span><span class="nx">FINE</span><span class="p">,</span> <span class="nx">l4g</span><span class="p">.</span><span class="nx">NewFileLogWriter</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="kc">false</span><span class="p">))</span>
</span><span class='line'>  <span class="nx">log</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Can also specify manually via the following: (these are the defaults) */</span>
</span><span class='line'>  <span class="nx">flw</span> <span class="o">:=</span> <span class="nx">l4g</span><span class="p">.</span><span class="nx">NewFileLogWriter</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">flw</span><span class="p">.</span><span class="nx">SetFormat</span><span class="p">(</span><span class="s">&quot;[%D %T] [%L] (%S) %M&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">flw</span><span class="p">.</span><span class="nx">SetRotate</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">flw</span><span class="p">.</span><span class="nx">SetRotateSize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">flw</span><span class="p">.</span><span class="nx">SetRotateLines</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">flw</span><span class="p">.</span><span class="nx">SetRotateDaily</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">log</span><span class="p">.</span><span class="nx">AddFilter</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">,</span> <span class="nx">l4g</span><span class="p">.</span><span class="nx">FINE</span><span class="p">,</span> <span class="nx">flw</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Log some experimental messages</span>
</span><span class='line'>  <span class="nx">log</span><span class="p">.</span><span class="nx">Finest</span><span class="p">(</span><span class="s">&quot;Everything is created now (notice that I will not be printing to the file)&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">log</span><span class="p">.</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;The time is now: %s&quot;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Format</span><span class="p">(</span><span class="s">&quot;15:04:05 MST 2006/01/02&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="nx">log</span><span class="p">.</span><span class="nx">Critical</span><span class="p">(</span><span class="s">&quot;Time to close out!&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Close the log</span>
</span><span class='line'>  <span class="nx">log</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Print what was logged to the file (yes, I know I&#39;m skipping error checking)</span>
</span><span class='line'>  <span class="nx">fd</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">in</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&quot;Messages logged to file were: (line numbers not included)\n&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">for</span> <span class="nx">lineno</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="nx">lineno</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">line</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">in</span><span class="p">.</span><span class="nx">ReadString</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">break</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%3d:\t%s&quot;</span><span class="p">,</span> <span class="nx">lineno</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">fd</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Remove the file so it&#39;s not lying around</span>
</span><span class='line'>  <span class="nx">os</span><span class="p">.</span><span class="nx">Remove</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>代码就不多说了，唯一值得注意的是log4go貌似达到指定的日志数上限了之后就不会再去掉旧的文件，更新新的文件了，也就是再也无法记录日志，这个是需要程序考虑的，完。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[win7下cocos2d-js3.0 alpha生成android项目]]></title>
    <link href="http://evoupsight.com/blog/2014/03/25/win7-cocos-2djs-3-dot-0-alpha-with-android/"/>
    <updated>2014-03-25T19:37:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/03/25/win7-cocos-2djs-3-dot-0-alpha-with-android</id>
    <content type="html"><![CDATA[<p>折腾了比较长的时间，主要是从cocos2d-html5入门开始做demo，然后到jsb的部分，发现走不通，于是又去研究了cocos2d-x3.0 v3.0 rc0如何生成android项目，发现发布是可以的，但是安装到模拟器又是闪退。花了两三天时间（间断）终于完成，放这里共享下。</p>

<!-- more -->


<h3>需要的软件</h3>

<p>首先当然是下载好cocos2d-js了，放到c:\cocos2d-jsb中：<br>
<img src="http://evoupsight.com/images/evoup/cocos2d-js_android/01.png" alt="Alt text" /></p>

<p>然后请安装好这些工具NDK（r9b）, android SDK（20131030）, ANT（1.9.3），Python（2.7.6）<br>
下图中红色框住的部分为实际使用到的软件</p>

<p><img src="http://evoupsight.com/images/evoup/cocos2d-js_android/02.png" alt="Alt text" /></p>

<p><img src="http://evoupsight.com/images/evoup/cocos2d-js_android/03.png" alt="Alt text" /></p>

<p>python要配置好环境变量，在cmd命令调出python，可以看到版本号:<br></p>

<p><img src="http://evoupsight.com/images/evoup/cocos2d-js_android/04.png" alt="Alt text" /></p>

<h3>安装</h3>

<p>万事俱备，到了见证奇迹的时刻,在这之前，请先安装好命令行，其实就是写入几个环境变量<br>
方法是：开始-运行-cmd，进入控制台，然后定位到C:\cocos2d-jsb\Cocos2d-JS-v3.0-alpha,接下来输入:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>python setup.py
</span></code></pre></td></tr></table></div></figure>


<p>然后在对应的NDK_ROOT环境变量中输入c:\android\android-ndk-r9b-windows-x86_64\android-ndk-r9b,<br>
在ANDROID_SDK_ROOT环境变量中输入c:\android\adt-bundle-windows-x86_64-20131030\sdk<br>
在ANT_ROOT中环境变量中输入c:\ant\apache-ant-1.9.3\bin<br>
<img src="http://evoupsight.com/images/evoup/cocos2d-js_android/05.png" alt="Alt text" /></p>

<p>这些操作完成后，你会发现win7好像并没有加载出这些环境变量，我的方法是重启（嗯！你没看错，反正我是重启才能加载，晕）。<br></p>

<p>重启完成之后,我们试一下这些环境变量是否OK，注意windows下批处理程序变量的命名方式为%变量名%<br></p>

<p><img src="http://evoupsight.com/images/evoup/cocos2d-js_android/06.png" alt="Alt text" /></p>

<h3>产生项目</h3>

<p>比如说要在c:/projects下创建一个有native编译支持的，名为projectFirst的项目，需要在控制台输入</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>%COCOS_CONSOLE_ROOT%/cocos new projectFirst -l js -d c:/projects
</span></code></pre></td></tr></table></div></figure>


<p>等一会儿就创建完毕<br>
<img src="http://evoupsight.com/images/evoup/cocos2d-js_android/07.png" alt="Alt text" /></p>

<h3>编译项目</h3>

<p>如果要编译成android项目，只要执行如下指令即可：<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>&gt; <span class="nb">cd </span>c:<span class="se">\p</span>rojects<span class="se">\p</span>rojectFirst
</span><span class='line'>&gt; %COCOS_CONSOLE_ROOT%/cocos compile -p android
</span></code></pre></td></tr></table></div></figure>


<p>之后要耐心等待项目编译完成，顺便说一句，没有vc2012是不能够编译cocos2d-js3.0的，因为现在引擎支持C++11了。<br>
<img src="http://evoupsight.com/images/evoup/cocos2d-js_android/08.png" alt="Alt text" /></p>

<p>等待编译完成<br>
<img src="http://evoupsight.com/images/evoup/cocos2d-js_android/09.png" alt="Alt text" /></p>

<p>这样就在runtime\android\下生成了projectFirst-debug-unaligned.apk</p>

<h3>在android模拟器测试</h3>

<p>这个只要注意如果是2d-js的项目，在模拟器里面是需要打开use host gpu<br>
<img src="http://evoupsight.com/images/evoup/cocos2d-js_android/10.png" alt="Alt text" /></p>

<p>启动模拟器后，用adb安装软件进去<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>%ANDROID_SDK_ROOT%/platform-tools/adb install c:<span class="se">\p</span>rojects<span class="se">\p</span>rojectFirst<span class="se">\r</span>untime<span class="se">\a</span>ndroid<span class="se">\p</span>rojectFirst-debug-unaligned.apk
</span></code></pre></td></tr></table></div></figure>


<p>安装完成后运行程序<br>
<img src="http://evoupsight.com/images/evoup/cocos2d-js_android/10.png" alt="Alt text" /></p>

<p>告一段落。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用CocoStudio创建骨骼动画（二）]]></title>
    <link href="http://evoupsight.com/blog/2014/03/18/use-cocostudio-create-bone-animation2/"/>
    <updated>2014-03-18T22:17:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/03/18/use-cocostudio-create-bone-animation2</id>
    <content type="html"><![CDATA[<p>上次的《使用CocoStudio创建骨骼动画》讨论到了如何创建骨骼和绑定骨骼关系，这节开始谈怎么创建帧动画。</p>

<p>我把上次的每个图层命名成每个骨骼后，更新后的：<a href="http://pan.baidu.com/s/1mg0UXJi" target=_blank>工作cocostudio源文件下载</a></p>

<!-- more -->


<p><img src="http://evoupsight.com/images/evoup/cocostudio_bone_animation2/01.png" alt="Alt text" /></p>

<p>点击形体模式之后切换到动画模式<br>
<img src="http://evoupsight.com/images/evoup/cocostudio_bone_animation2/02.png" alt="Alt text" /></p>

<p>开始第一个帧动画的制作，右键点击动作列表Animation1<br>
<img src="http://evoupsight.com/images/evoup/cocostudio_bone_animation2/03.png" alt="Alt text" /></p>

<p>改名为stand,注意不要改成中文，否则以后写代码调用的时候可能会出现问题<br>
<img src="http://evoupsight.com/images/evoup/cocostudio_bone_animation2/04.png" alt="Alt text" /></p>

<p>用鼠标框选全部的帧<br>
<img src="http://evoupsight.com/images/evoup/cocostudio_bone_animation2/05.png" alt="Alt text" /></p>

<p>选择复制帧<br>
<img src="http://evoupsight.com/images/evoup/cocostudio_bone_animation2/06.png" alt="Alt text" /></p>

<p>在60帧处右键，然后点击粘帖帧<br>
<img src="http://evoupsight.com/images/evoup/cocostudio_bone_animation2/07.png" alt="Alt text" /></p>

<p>同样的方法，在30帧处右键点击粘帖帧<br>
<img src="http://evoupsight.com/images/evoup/cocostudio_bone_animation2/08.png" alt="Alt text" /></p>

<p>然后把时间轴移到到30帧<br>
<img src="http://evoupsight.com/images/evoup/cocostudio_bone_animation2/09.png" alt="Alt text" /></p>

<p>接下来编辑造型了，轻微旋转各个关节<br>
<img src="http://evoupsight.com/images/evoup/cocostudio_bone_animation2/10.png" alt="Alt text" /></p>

<p>点击隐藏骨骼，可以展现整体角色<br>
<img src="http://evoupsight.com/images/evoup/cocostudio_bone_animation2/11.png" alt="Alt text" /></p>

<p>看效果<br>
<img src="http://evoupsight.com/images/evoup/cocostudio_bone_animation2/animation.gif" alt="Alt text" /></p>

<p>然后再创建一个run的动作，如法炮制，未完待续&hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Win7 Android开发环境搭建之二(NDK+CDT)]]></title>
    <link href="http://evoupsight.com/blog/2014/03/18/android-install-ndk-cdt/"/>
    <updated>2014-03-18T15:08:00+08:00</updated>
    <id>http://evoupsight.com/blog/2014/03/18/android-install-ndk-cdt</id>
    <content type="html"><![CDATA[<p>由于cocos2d-js用到了android的一些生产软件，比如android sdk、adt、cdt和ndk，前面两个已经在之前的《Win7 Android开发环境搭建之一(SDK+ADT)》说过了，这次主要介绍下怎么安装cdt和ndk。</p>

<!-- more -->


<h3>什么是NDK</h3>

<blockquote><p>NDK 提供了一系列的工具，帮助开发者快速开发C（或C++）的动态库，并能自动将so 和java 应用一起打包成apk。这些工具对开发者的帮助是巨大的。</p></blockquote>

<h3>NDK的安装</h3>

<p>这个安装其实就是解压（环境变量的添加要等装好了cygwin再添加，这是后话），下载android NDK。<a href="http://developer.android.com/tools/sdk/ndk/index.html">http://developer.android.com/tools/sdk/ndk/index.html</a></p>

<p>我下载的版本是android-ndk-r9d-windows-x86_64.zip<br>
下载后解压到例如：c:\android\android-ndk-r9d-windows-x86_64.zip，结果如下图：<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/01.png" alt="Alt text" /></p>

<h3>安装cygwin与ndk编译</h3>

<p>（插一句：cygwin安装后与octopress的环境可能冲突，建议先安装octopress)</p>

<h4>安装cygwin</h4>

<p>ndk开发需要gcc环境，在windows下可以用是cygwin模拟linux编译环境。</p>

<p>Cygwin的下载地址：<a href="http://www.cygwin.com/">http://www.cygwin.com/</a></p>

<p>这个直接一路装，选择163的镜像<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/02.png" alt="Alt text" /></p>

<p>选择Devel-Default，然后点击变成Devel-Install，然后持续点击下一步，耐心等待安装完成，时间是比较长的<br>
或者可以选择像网上许多教程说的那样只下载12个包，这个我就不这么做了<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/03.png" alt="Alt text" /></p>

<h4>加入环境变量(可选，这样可以直接在cmd里进行cygwin.bat的操作)</h4>

<p>完成之后，需要把cygwin加入环境变量,我这里是安装在了c:/cygwin64,把c:/cygwin64/bin加入环境变量PATH<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/04.png" alt="Alt text" /></p>

<h4>测试cygwin环境</h4>

<p>运行c:/cygwin64/Cygwin.bat,输入</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>cygcheck -c cygwin
</span><span class='line'>make -v
</span><span class='line'>gcc -v
</span></code></pre></td></tr></table></div></figure>


<p>如果显示ok就可以了，之前的报错cygheap base mismatch detected可以先忽略。<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/05.png" alt="Alt text" /></p>

<h4>设置NDK路径：</h4>

<p>接下来在windows系统环境变量ndk中添加NDK的路径,刚刚我把NDK解压到C:\android\android-ndk-r9d-windows-x86_64\android-ndk-r9d<br>
然后在环境变量ndk加上它在cygwin shell里的对应路径/cygdrive/c/android/android-ndk-r9d-windows-x86_64/android-ndk-r9d<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/06.png" alt="Alt text" /></p>

<p>编辑完成后，进入cygwin.bat输入<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">cd</span> <span class="nv">$ndk</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到如下结果<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/07.png" alt="Alt text" /></p>

<h4>测试NDK，编译一个例子</h4>

<p>例子可以在$ndk/sample/hello-jni中找到<br>
进入cygwin.bat中输入编译指令</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">cd</span> <span class="nv">$ndk</span>/sample/hello-jni
</span><span class='line'><span class="nv">$ndk</span>/ndk-build
</span></code></pre></td></tr></table></div></figure>


<p>一会儿就能编译完成，见下<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/08.png" alt="Alt text" /></p>

<p>进入libs目录查看结果,观察是否生成了so文件，如果生成则说明你的NDK已经运行正常了。<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>libs/armeabi/
</span><span class='line'><span class="nv">$ </span>ls
</span><span class='line'>gdb.setup  gdbserver  libhello-jni.so
</span></code></pre></td></tr></table></div></figure>


<h4>在Eclipse中完成代码调用</h4>

<p>接下来进入Eclipse，测试该项目,创建项目路径为C:\android\project\HelloJni<br>
在Create Android Project时勾选“Create project from existing source”，Root Directory中填C:\android\android-ndk-r9d-windows-x86_64\android-ndk-r9d\samples\hello-jni,如下<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/09.png" alt="Alt text" /><br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/10.png" alt="Alt text" /><br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/11.png" alt="Alt text" /><br></p>

<p>看到如下字符串就代表NDK的例子运行成功了<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/12.png" alt="Alt text" /></p>

<p>分析一下调用代码</p>

<figure class='code'><figcaption><span>HelloJni.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Copyright (C) 2009 The Android Open Source Project</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
</span><span class='line'><span class="cm"> * you may not use this file except in compliance with the License.</span>
</span><span class='line'><span class="cm"> * You may obtain a copy of the License at</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> *      http://www.apache.org/licenses/LICENSE-2.0</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Unless required by applicable law or agreed to in writing, software</span>
</span><span class='line'><span class="cm"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
</span><span class='line'><span class="cm"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span><span class='line'><span class="cm"> * See the License for the specific language governing permissions and</span>
</span><span class='line'><span class="cm"> * limitations under the License.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">hellojni</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.app.Activity</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.widget.TextView</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">android.os.Bundle</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloJni</span> <span class="kd">extends</span> <span class="n">Activity</span> <span class="c1">//HelloJni继承自活动对象事件调度类</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="cm">/** Called when the activity is first created. */</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="c1">//重写onCreate方法</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* Create a TextView and set its content.</span>
</span><span class='line'><span class="cm">         * the text is retrieved by calling a native</span>
</span><span class='line'><span class="cm">         * function.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">TextView</span>  <span class="n">tv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TextView</span><span class="o">(</span><span class="k">this</span><span class="o">);</span> <span class="c1">//创建一个文字view</span>
</span><span class='line'>        <span class="n">tv</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span> <span class="n">stringFromJNI</span><span class="o">()</span> <span class="o">);</span> <span class="c1">//调用自定义方法stringFromJNI</span>
</span><span class='line'>        <span class="n">setContentView</span><span class="o">(</span><span class="n">tv</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* A native method that is implemented by the</span>
</span><span class='line'><span class="cm">     * &#39;hello-jni&#39; native library, which is packaged</span>
</span><span class='line'><span class="cm">     * with this application.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">native</span> <span class="n">String</span>  <span class="nf">stringFromJNI</span><span class="o">();</span> <span class="c1">//有native代表是c++的代码，这里仅仅是声明</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* This is another native method declaration that is *not*</span>
</span><span class='line'><span class="cm">     * implemented by &#39;hello-jni&#39;. This is simply to show that</span>
</span><span class='line'><span class="cm">     * you can declare as many native methods in your Java code</span>
</span><span class='line'><span class="cm">     * as you want, their implementation is searched in the</span>
</span><span class='line'><span class="cm">     * currently loaded native libraries only the first time</span>
</span><span class='line'><span class="cm">     * you call them.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * Trying to call this function will result in a</span>
</span><span class='line'><span class="cm">     * java.lang.UnsatisfiedLinkError exception !</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">native</span> <span class="n">String</span>  <span class="nf">unimplementedStringFromJNI</span><span class="o">();</span> <span class="c1">//同样是C++的代码</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* this is used to load the &#39;hello-jni&#39; library on application</span>
</span><span class='line'><span class="cm">     * startup. The library has already been unpacked into</span>
</span><span class='line'><span class="cm">     * /data/data/com.example.hellojni/lib/libhello-jni.so at</span>
</span><span class='line'><span class="cm">     * installation time by the package manager.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">static</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&quot;hello-jni&quot;</span><span class="o">);</span> <span class="c1">//调用刚才ndk生成的hello-jni.so</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>C++的代码暂时就不看了，一步一步来，我们还没装cdt，不急着搞清楚，有兴趣的到文章最后去看链接</p>

<h3>什么是CDT</h3>

<blockquote><p>Eclipse CDT是 Eclipse 插件，它将把 Eclipse 转换为功能强大的 C/C++ IDE。它被设计为将 Java 开发人员喜爱的许多 Eclipse 优秀功能提供给 C/C++ 开发人员，例如项目管理、集成调试、类向导、自动构建、语法着色和代码完成。当 Eclipse 被用作 Java IDE 时，它将利用 JDK 并与之集成。同样地，CDT 将利用标准的 C/C++ 工具并与之集成，例如 g++、make 和 GDB。这使得 CDT 在 Linux 中变得非常流行，这些工具都可在 Linux 中使用并用于大多数 C++ 开发。可以在 Windows 上设置 CDT 以使用相同的工具。目前还在努力将 CDT 与 Microsoft 的 C++ 工具结合使用，以使 CDT 对 Windows C++ 开发人员更有吸引力。总之有了cdt，可以在一个工程里，同时开发C/C++的native代码的java外壳，并且2种代码能够同时编译。</p></blockquote>

<h3>在Eclipse编辑器中集成CDT</h3>

<p>首先在此下载<a href="http://www.eclipse.org/cdt/downloads.php">http://www.eclipse.org/cdt/downloads.php</a><br>
直接下载cdt-master-x.x.x.zip的就可以了，我的是Eclipse版本为Kepler，可以下载以下版本<br>
<a href="http://www.eclipse.org/downloads/download.php?file=/tools/cdt/releases/kepler/sr2/cdt-master-8.3.0.zip">http://www.eclipse.org/downloads/download.php?file=/tools/cdt/releases/kepler/sr2/cdt-master-8.3.0.zip</a></p>

<p><img src="http://evoupsight.com/images/evoup/android_cdt_ndk/13.png" alt="Alt text" /></p>

<p>然后通过Eclipse &ndash;> Help &ndash;> Install New Software &ndash;> add &ndash;> Achive,选择下载的zip文件</p>

<p><img src="http://evoupsight.com/images/evoup/android_cdt_ndk/14.png" alt="Alt text" /></p>

<p>等待安装完成<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/15.png" alt="Alt text" /></p>

<p>安装完成后如果在Eclipse中可以创建C++项目证明安装完成<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/16.png" alt="Alt text" /></p>

<h3>安装Sequoyah插件（事实证明，kepler+ndk9已经无须这个插件了）</h3>

<p><del> 官网地址 </del> <br>
<del> <a href="https://projects.eclipse.org/projects/tools.sequoyah">https://projects.eclipse.org/projects/tools.sequoyah</a> </del></p>

<p><del> 这个地址其实已经作废了,正确的连接如下 </del> <br>
<del> <a href="http://www.mirrorservice.org/sites/download.eclipse.org/eclipseMirror/sequoyah/updates/2.0/">http://www.mirrorservice.org/sites/download.eclipse.org/eclipseMirror/sequoyah/updates/2.0/</a> </del> <br>
<del> Eclipse-Help-Install New Software-Add,在Location里输入上面的地址，name就指定为sequoyah</del> <br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/17.png" alt="Alt text" />
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/18.png" alt="Alt text" /></p>

<p><del> 然后取消下面的Group By Item，之后选择Select All，按下Next安装（没有研究下去，发现这个要求的eclipse版本为3.7以下，我的kepler为4.3，不得以暂时放弃） </del></p>

<h3>JNI编译环境配置</h3>

<p>还是打开HelloJni这个项目，现在转换为C/C++的native的代码<br>
&ldquo;Eclipse->File->New->Other&rdquo;,选择&#8221;C/C++&ldquo;下的&#8221;Convert to a c/C++ Project(Add C/C++ Nature)&rdquo;,然后点击&#8221;Next&#8221;<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/19.png" alt="Alt text" /></p>

<p>然后在Makefile project中选择Cygwin GCC,点击Finish<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/20.png" alt="Alt text" /></p>

<p>右键项目的Properties，在&#8221;C/C++ Build&#8221;中取消默认的&#8221; Use default build command &ldquo;的打勾，在Build Command中输入对应bash加空格加ndk-build的路径，我这里是C:\android\android-ndk-r9d-windows-x86_64\android-ndk-r9d\ndk-build<br></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>bash C:<span class="se">\a</span>ndroid<span class="se">\a</span>ndroid-ndk-r9d-windows-x86_64<span class="se">\a</span>ndroid-ndk-r9d<span class="se">\n</span>dk-build
</span></code></pre></td></tr></table></div></figure>


<p><img src="http://evoupsight.com/images/evoup/android_cdt_ndk/21.png" alt="Alt text" /></p>

<p>在&#8221;C/C++ General&#8221;的Paths and Symbols中：在Includes下add新的GNU C依赖路径,根据自己的avd（andriod virtual device）的版本设置对应的头文件，我这里是android17的，则C:\android\android-ndk-r9d-windows-x86_64\android-ndk-r9d\platforms\android-17\arch-arm\usr\include,其他项目可以安装实际环境酌情调整依赖头文件的版本<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/22.png" alt="Alt text" /></p>

<p>验证：
将“/HelloJni/jni/hello-jni.c”中的字符串“Hello from JNI !”如改为“Hello JNI from test!”，运行后在模拟器上输出的字符串改变即说明配置成功。<br>
<img src="http://evoupsight.com/images/evoup/android_cdt_ndk/23.png" alt="Alt text" /></p>

<hr />

<h3>参考文章</h3>

<p>《Android NDK 安装与配置》
<a href="http://my.oschina.net/owen123456/blog/85658">http://my.oschina.net/owen123456/blog/85658</a></p>

<p>《Android: NDK编程入门笔记》
<a href="http://www.cnblogs.com/hibraincol/archive/2011/05/30/2063847.html">http://www.cnblogs.com/hibraincol/archive/2011/05/30/2063847.html</a></p>
]]></content>
  </entry>
  
</feed>
