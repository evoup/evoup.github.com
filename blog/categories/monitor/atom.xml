<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: monitor | Evoup`s Blog]]></title>
  <link href="http://evoupsight.com/blog/categories/monitor/atom.xml" rel="self"/>
  <link href="http://evoupsight.com/"/>
  <updated>2013-10-11T14:15:13+08:00</updated>
  <id>http://evoupsight.com/</id>
  <author>
    <name><![CDATA[Your Name]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[freebsd install ganglia3.4]]></title>
    <link href="http://evoupsight.com/blog/2012/10/22/freebsd-install-ganglia3-dot-4/"/>
    <updated>2012-10-22T11:24:00+08:00</updated>
    <id>http://evoupsight.com/blog/2012/10/22/freebsd-install-ganglia3-dot-4</id>
    <content type="html"><![CDATA[<h2>Ganglia是什么?</h2>

<p>简单形象的说，这是一个开源的系统监控软件，本身通过rrdtool这个软件作为数据载体，以及SNMP协议采集监控数据，最终在管理界面上呈现出监控图表数据的系统。</p>

<h2>安装小记</h2>

<p>首先是下载ganglia
{% codeblock shell lang:bash %}
wget <a href="http://downloads.sourceforge.net/project/ganglia/">http://downloads.sourceforge.net/project/ganglia/</a>
wget <a href="http://oss.oetiker.ch/rrdtool/pub/rrdtool-1.4.7.tar.gz">http://oss.oetiker.ch/rrdtool/pub/rrdtool-1.4.7.tar.gz</a>
{% endcodeblock %}</p>

<p>先安装rrdtool
{% codeblock shell lang:bash %}
./configure &mdash;prefix=/usr/lib32/rrdtool &mdash;disable-perl
make &amp;&amp; make install
{% endcodeblock %}</p>

<p>(Ps:安装过程有缺少包的解决，可以尝试先从port安装好rrdtool之后deinstall rrdtool，这样依赖的包就都有了，因为port直接安装rrdtool后ganglia不认，所以手动编译)</p>

<p>再来是ganglia
{% codeblock shell lang:bash %}
./configure &mdash;with-gmetad &mdash;with-librrd=/usr/lib32/rrdtool
make &amp;&amp; make install
{% endcodeblock %}
报告</p>

<p>Checking for apr</p>

<p>checking for apr-1-config&hellip; no</p>

<p>configure: error: apr-1-config binary not found in path</p>

<p>没有安装apache2</p>

<p>先安装mysql</p>

<p>whereis mysql51-server
{% codeblock shell lang:bash %}
wget <a href="ftp://ftp.fi.muni.cz/pub/mysql/Downloads/MySQL-5.1/mysql-5.1.60.tar.gz">ftp://ftp.fi.muni.cz/pub/mysql/Downloads/MySQL-5.1/mysql-5.1.60.tar.gz</a>
sudo make WITH_CHARSET=utf8 WITH_XCHARSET=all install clean
sudo make install
{% endcodeblock %}</p>

<p>安装httpd
{% codeblock shell lang:bash %}
wget <a href="http://labs.renren.com/apache-mirror/httpd/httpd-2.2.23.tar.gz">http://labs.renren.com/apache-mirror/httpd/httpd-2.2.23.tar.gz</a>
./configure &mdash;prefix=/usr/local/apache2 &mdash;enable-modules=so &mdash;enable-rewrite
make &amp;&amp; make install
{% endcodeblock %}</p>

<p>安装php
{% codeblock shell lang:bash %}
wget <a href="http://cn.php.net/get/php-5.3.6.tar.gz/from/this/mirror">http://cn.php.net/get/php-5.3.6.tar.gz/from/this/mirror</a>
tar –zxvf php-5.3.6.tar.gz
cd php-5.3.6
./configure &mdash;prefix=/usr/local/php &mdash;with-apxs2=/usr/local/apache2/bin/apxs &mdash;with-config-file-path=/usr/local/lib &mdash;with-mysql=/usr
make &amp;&amp; make install
{% endcodeblock %}</p>

<p>将php5的库复制到apache的modules里
{% codeblock shell lang:bash %}
sudo cp –p .libs/libphp5.so /usr/local/apache2/modules
sudo chown cdh:cdh /usr/local/apache2/modules/libphp5.so
{% endcodeblock %}</p>

<p>复制php5配置文件
{% codeblock shell lang:bash %}
sudo cp php.ini-development /usr/local/php/lib/php/php.ini
{% endcodeblock %}</p>

<p>修改http.conf 兼容php5
{% codeblock shell lang:bash %}
sudo vim /usr/local/apache2/conf/httpd.conf
{% endcodeblock %}
加上
{% codeblock shell lang:bash %}
AddType application/x-httpd-php .php</p>

<h1>LoadModule php5_module modules/libphp5.so</h1>

<p>{% endcodeblock %}<br/>
把上面的#号去掉</p>

<p>DirectoryIndex index.html</p>

<p>在后面加 index.php</p>

<p>DocumentRoot &ldquo;/usr/local/apache2/htdocs&rdquo;</p>

<p>把/usr/local/apache2/htdocs改为你存放网页文件的路径</p>

<p>AddDefaultCharset iso8859-1</p>

<p>把后面的iso8859-1改为gb2312 或者是干脆off</p>

<p>更详细的请参考<a href="http://article.21e.cn">http://article.21e.cn</a></p>

<p>到这里看下访问一下浏览器，php应该工作ok</p>

<p>继续编译ganglia
{% codeblock shell lang:bash %}
sudo ./configure &mdash;with-gmetad &mdash;with-librrd=/usr/lib32/rrdtool
{% endcodeblock %}
configure: error: apr-1-config binary not found in path</p>

<p>{% codeblock shell lang:bash %}
whereis apr1
cd /usr/ports/devel/apr1
sudo make install clean &amp;&amp; rehash
{% endcodeblock %}</p>

<p>回来继续编译，报告缺少libconfuse not found
{% codeblock shell lang:bash %}
cd /usr/ports/devel/libconfuse/
sudo make install clean &amp;&amp; rehash
{% endcodeblock %}</p>

<p>报告缺少expat.h
{% codeblock shell lang:bash %}
cd /usr/ports/textproc/expat2
sudo make install clean &amp;&amp; rehash
{% endcodeblock %}</p>

<p>问题依旧修改配置
{% codeblock shell lang:bash %}
sudo ./configure &mdash;with-gmetad &mdash;with-librrd=/usr/lib32/rrdtool &mdash;with-libexpat=/usr/local/
sudo make
sudo make install
{% endcodeblock %}
安装完成！</p>

<p>测试gmetad的运行
{% codeblock shell lang:bash %}
sudo /usr/local/sbin/gmetad -d 5</p>

<p>Going to run as user nobody</p>

<p>Please make sure that /var/db/ganglia/rrds exists: No such file or directory</p>

<p>sudo mkdir -p /var/db/ganglia/rrds</p>

<p>sudo /usr/local/sbin/gmetad -d 5</p>

<p>Going to run as user nobody</p>

<p>Please make sure that /var/db/ganglia/rrds is owned by nobody</p>

<p>sudo chown -R nobody:nobody /var/db/ganglia/</p>

<p>Going to run as user nobody</p>

<p>Sources are &hellip;</p>

<p>Source: [my cluster, step 15] has 1 sources</p>

<pre><code>    127.0.0.1
</code></pre>

<p>xml listening on port 8651</p>

<p>interactive xml listening on port 8652</p>

<p>cleanup thread has been started</p>

<p>Data thread 34460440576 is monitoring [my cluster] data source</p>

<pre><code>    127.0.0.1
</code></pre>

<p>data_thread() for [my cluster] failed to contact node 127.0.0.1</p>

<p>data_thread() got no answer from any [my cluster] datasource</p>

<p>data_thread() for [my cluster] failed to contact node 127.0.0.1</p>

<p>data_thread() got no answer from any [my cluster] datasource</p>

<p>data_thread() for [my cluster] failed to contact node 127.0.0.1</p>

<p>data_thread() got no answer from any [my cluster] datasource</p>

<p>sudo /usr/local/sbin/gmond -d 5
{% endcodeblock %}</p>

<p>看上去运行正常了</p>

<p>基本可以。</p>

<p>开始装界面。不要装3.5.3有些图开不了，3.5.2经过测试没有问题。</p>

<p><a href="http://sourceforge.net/projects/ganglia/files/ganglia-web/3.5.2/ganglia-web-3.5.2.tar.gz/download">http://sourceforge.net/projects/ganglia/files/ganglia-web/3.5.2/ganglia-web-3.5.2.tar.gz/download</a></p>

<p>注意web要求rrd数据库的路径只能是/var/lib/ganglia/rrds</p>

<p>由于之前是装在了/var/db/ganglia/rrds</p>

<p>则
{% codeblock shell lang:bash %}
cd /var/lib
sudo ln -s /var/db/ganglia ganglia
{% endcodeblock %}</p>

<p>然后访问浏览器</p>

<p><a href="http://192.168.174.133/ganglia/">http://192.168.174.133/ganglia/</a></p>

<p>此时</p>

<p>There was an error collecting ganglia data (127.0.0.1:8652): fsockopen error: Connection refused</p>

<p>因为没有打开gmond和gmetad，打开发现界面ok了，但是没有数据！</p>

<p>怀疑是php没有安装rrdtool的扩展,继续安装php的rrdtool扩展</p>

<p><a href="http://pecl.php.net/package/rrd">http://pecl.php.net/package/rrd</a>
{% codeblock shell lang:bash %}
sudo ./configure &mdash;with-php-config=/usr/local/php/bin/php-config &mdash;with-rrd-binary=/usr/lib32/rrdtool/bin/rrdtool
{% endcodeblock %}</p>

<p>配置报错找不到rrdtool的头文件，直接定位configure文件进行修改</p>

<p>for i in /usr /usr/local /usr/local/rrdtool /opt; do</p>

<p>改成我装的路径</p>

<p>for i in /usr /usr/local /usr/local/rrdtool /opt /usr/lib32/rrdtool; do</p>

<p>改了之后</p>

<p>configure: error: rrd lib version seems older than 1.3.0, update to 1.3.0+</p>

<p>通过后还是报错</p>

<p>error: too many arguments to function &lsquo;rrd_lastupdate&rsquo;</p>

<p>参考这里<a href="https://bugs.php.net/bug.php?id=59558">https://bugs.php.net/bug.php?id=59558</a></p>

<p>```c
&ndash; if (rrd_lastupdate(2, &amp;argv[1], &amp;last_update, &amp;ds_cnt, &amp;ds_namv,</p>

<ul>
<li>if (rrd_lastupdate_r(argv[1], &amp;last_update, &amp;ds_cnt, &amp;ds_namv,
```</li>
</ul>


<p>装完看到phpinfo里有了。</p>

<p>之后还要修改conf_default.php文件</p>

<p>graphite_rrd_dir变量，指向ganglia存放rrd的目录，我的是/var/db/ganglia/rrds</p>

<p>还有一个$conf[&lsquo;rrdtool&rsquo;]变量，指向rrdtool的安装位置，我的是/usr/lib32/rrdtool/bin/rrdtool</p>

<p>应该就差不多了！这样如果还不行，检查自身人品，然后看下/var/log/message</p>
]]></content>
  </entry>
  
</feed>
